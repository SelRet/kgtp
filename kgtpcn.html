<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8">
	<title>Linux Kernel GDB tracepoint module (KGTP)</title>
	<meta name="generator" content="LibreOffice 4.2.3.3 (Linux)">
	<meta name="author" content="teawater ">
	<meta name="created" content="20130710;155757000000000">
	<meta name="changed" content="20140509;142004619916746">
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-581509-4', 'teawater.github.io');
ga('send', 'pageview');

</script>
	<style type="text/css">
	<!--
		@page { margin: 2cm }
		p { margin-bottom: 0.21cm; font-size: 12pt }
		h1 { margin-bottom: 0.21cm }
		h1.western { font-family: "DejaVu Sans", sans-serif; font-size: 36pt }
		h1.cjk { font-family: "DejaVu Sans"; font-size: 36pt }
		h1.ctl { font-family: "Lohit Hindi"; font-size: 16pt }
		td p { margin-bottom: 0cm }
		h2 { margin-top: 0.42cm }
		h2.western { font-family: "DejaVu Serif", serif; font-size: 24pt }
		h2.cjk { font-family: "DejaVu Sans"; font-size: 24pt }
		h2.ctl { font-family: "Lohit Hindi" }
		h3 { margin-top: 0.42cm; color: #000000 }
		h3.western { font-family: "DejaVu Serif", serif; font-size: 18pt }
		h3.cjk { font-family: "DejaVu Sans"; font-size: 18pt }
		h3.ctl { font-family: "Lohit Hindi" }
		h4 { margin-top: 0.42cm; color: #000000 }
		h4.western { font-family: "DejaVu Sans", sans-serif; font-size: 15pt; font-style: normal }
		h4.cjk { font-family: "DejaVu Sans"; font-size: 15pt; font-style: normal }
		h4.ctl { font-family: "Lohit Hindi"; font-size: 11pt; font-style: italic }
		h5 { margin-top: 0.42cm; margin-bottom: 0.21cm }
		h5.western { font-family: "DejaVu Sans", sans-serif; font-size: 14pt }
		h5.cjk { font-family: "DejaVu Sans"; font-size: 14pt }
		h5.ctl { font-family: "Lohit Hindi"; font-size: 11pt }
		blockquote { margin-bottom: 0cm; color: #0000ff; page-break-before: auto }
		blockquote.western { font-size: 12pt; font-style: italic }
		blockquote.cjk { font-size: 12pt; font-style: oblique }
		blockquote.ctl { font-size: 12pt }
		h6 { margin-top: 0.42cm; margin-bottom: 0.21cm }
		h6.western { font-family: "DejaVu Sans", sans-serif; font-size: 10pt }
		h6.cjk { font-family: "DejaVu Sans"; font-size: 10pt }
		h6.ctl { font-family: "Lohit Hindi"; font-size: 10pt }
		a:link { so-language: zxx }
	-->
	</style>
</head>
<body lang="zh-CN" dir="ltr">
<div title="header">
	<p style="margin-bottom: 0.5cm"><sdfield type=DOCINFO subtype=THEME></sdfield></p>
</div>
<h1 class="cjk" align="center"></h1>
<p align="center"><br><br>
</p>
<p align="center"><br><br>
</p>
<p align="center"><br><br>
</p>
<p align="center"><br><br>
</p>
<p align="center"><br><br>
</p>
<p align="center"><br><br>
</p>
<p align="center" style="margin-bottom: 0cm"><font face="DejaVu Serif, serif"><font size="7" style="font-size: 42pt"><span lang="en-US"><b>Linux
Kernel GDB tracepoint module</b></span></font></font></p>
<p align="center" style="margin-bottom: 0cm"><font face="DejaVu Serif, serif"><font size="7" style="font-size: 42pt"><span lang="en-US"><b>(KGTP)</b></span></font></font></p>
<p align="center" style="margin-bottom: 0cm"><br>
</p>
<p align="center"><br><br>
</p>
<p align="center"><font face="DejaVu Serif, serif"><span lang="en-US">Update
in 2014-05-09</span></font></p>
<p align="center"><br><br>
</p>
<div id="内容目录1" dir="ltr">
	<div id="内容目录1_Head" dir="ltr">
		<p style="margin-bottom: 0cm; page-break-before: always; page-break-after: avoid">
		<font face="DejaVu Sans"><font size="4" style="font-size: 16pt"><b>目录</b></font></font></p>
	</div>
	<p style="margin-bottom: 0cm"><a href="#__RefHeading__10649_680043226">关于本文<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	5</a></span></font></font></p>
	<p style="margin-bottom: 0cm"><a href="#__RefHeading__5345_683619096">什么是<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">KGTP	6</a></span></font></font></p>
	<p style="margin-bottom: 0cm"><a href="#__RefHeading__11595_1305468286">快速配置和启动<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">KGTP	7</a></span></font></font></p>
	<p style="margin-bottom: 0cm"><a href="#__RefHeading__3899_71337508">需要帮助或者汇报问题<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	8</a></span></font></font></p>
	<p style="margin-bottom: 0cm"><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US"><a href="#__RefHeading__10120_71337508">GDB</a></span></font></font><a href="#__RefHeading__10120_71337508">调试普通程序和<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">KGTP</a></span></font></font><a href="#__RefHeading__10120_71337508">的区别表<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	9</a></span></font></font></p>
	<p style="margin-bottom: 0cm"><a href="#__RefHeading__11603_71337508">如何使用<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</a></span></font></font><a href="#__RefHeading__11603_71337508">控制<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">KGTP</a></span></font></font><a href="#__RefHeading__11603_71337508">跟踪和调试<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">Linux</a></span></font></font><a href="#__RefHeading__11603_71337508">内核<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	11</a></span></font></font></p>
	<p style="margin-left: 0.5cm; margin-bottom: 0cm"><a href="#__RefHeading__11605_71337508">在普通模式直接访问当前值<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	11</a></span></font></font></p>
	<p style="margin-left: 1cm; margin-bottom: 0cm"><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US"><a href="#__RefHeading__11607_71337508">Linux</a></span></font></font><a href="#__RefHeading__11607_71337508">内核的内存<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	12</a></span></font></font></p>
	<p style="margin-left: 1cm; margin-bottom: 0cm"><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US"><a href="#__RefHeading__11611_71337508">trace</a></span></font></font><a href="#__RefHeading__11611_71337508">状态变量<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	13</a></span></font></font></p>
	<p style="margin-left: 0.5cm; margin-bottom: 0cm"><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US"><a href="#__RefHeading__11613_71337508">GDB
	tracepoint	14</a></span></font></font></p>
	<p style="margin-left: 1cm; margin-bottom: 0cm"><a href="#__RefHeading__12707_71337508">设置<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tracepint	15</a></span></font></font></p>
	<p style="margin-left: 1.5cm; margin-bottom: 0cm"><a href="#__RefHeading__12709_71337508">这个函数确实存在但是设置<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tracepoint</a></span></font></font><a href="#__RefHeading__12709_71337508">到上面会失败如何处理<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	16</a></span></font></font></p>
	<p style="margin-left: 1cm; margin-bottom: 0cm"><a href="#__RefHeading__12711_71337508">如何设置条件<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tracepoint	17</a></span></font></font></p>
	<p style="margin-left: 1.5cm; margin-bottom: 0cm"><a href="#__RefHeading__12713_71337508">如何处理错误
	<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">&quot;Unsupported
	operator (null) (52) in expression.&quot;	18</a></span></font></font></p>
	<p style="margin-left: 1cm; margin-bottom: 0cm"><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US"><a href="#__RefHeading__12715_71337508">actions
	[num]	19</a></span></font></font></p>
	<p style="margin-left: 1.5cm; margin-bottom: 0cm"><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US"><a href="#__RefHeading__12717_71337508">collect
	expr1, expr2, ...	20</a></span></font></font></p>
	<p style="margin-left: 1.5cm; margin-bottom: 0cm"><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US"><a href="#__RefHeading__12719_71337508">teval
	expr1, expr2, ...	21</a></span></font></font></p>
	<p style="margin-left: 1.5cm; margin-bottom: 0cm"><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US"><a href="#__RefHeading__12721_71337508">while-stepping
	n	22</a></span></font></font></p>
	<p style="margin-left: 1cm; margin-bottom: 0cm"><a href="#__RefHeading__12723_71337508">启动和停止
	<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tracepoint	23</a></span></font></font></p>
	<p style="margin-left: 1cm; margin-bottom: 0cm"><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US"><a href="#__RefHeading__12725_71337508">Enable
	</a></span></font></font><a href="#__RefHeading__12725_71337508">和
	<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">disable
	tracepoint	24</a></span></font></font></p>
	<p style="margin-left: 1cm; margin-bottom: 0cm"><a href="#__RefHeading__12727_71337508">用<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tfind</a></span></font></font><a href="#__RefHeading__12727_71337508">选择<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">trace</a></span></font></font><a href="#__RefHeading__12727_71337508">帧缓存里面的条目<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	25</a></span></font></font></p>
	<p style="margin-left: 1.5cm; margin-bottom: 0cm"><a href="#__RefHeading__12729_71337508">如何处理错误
	<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">&quot;No
	such file or directory.&quot; </a></span></font></font><a href="#__RefHeading__12729_71337508">或者
	<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">&quot;</a></span></font></font><a href="#__RefHeading__12729_71337508">没有那个文件或目录<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">.&quot;	26</a></span></font></font></p>
	<p style="margin-left: 1cm; margin-bottom: 0cm"><a href="#__RefHeading__12731_71337508">保存<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">trace</a></span></font></font><a href="#__RefHeading__12731_71337508">帧信息到一个文件中<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	27</a></span></font></font></p>
	<p style="margin-left: 1cm; margin-bottom: 0cm"><a href="#__RefHeading__12733_71337508">显示和存储<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tracepoint	28</a></span></font></font></p>
	<p style="margin-left: 1cm; margin-bottom: 0cm"><a href="#__RefHeading__12735_71337508">删除<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tracepoint	29</a></span></font></font></p>
	<p style="margin-left: 1cm; margin-bottom: 0cm"><a href="#__RefHeading__12737_71337508">用<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tracepoint</a></span></font></font><a href="#__RefHeading__12737_71337508">从内核中某点取得寄存器信息<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	30</a></span></font></font></p>
	<p style="margin-left: 1cm; margin-bottom: 0cm"><a href="#__RefHeading__12739_71337508">用<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tracepoint</a></span></font></font><a href="#__RefHeading__12739_71337508">从内核中某点取得变量的值<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	32</a></span></font></font></p>
	<p style="margin-left: 1cm; margin-bottom: 0cm"><a href="#__RefHeading__12741_71337508">显示当前这一条<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">trace</a></span></font></font><a href="#__RefHeading__12741_71337508">缓存里存储的所有信息<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	33</a></span></font></font></p>
	<p style="margin-left: 1cm; margin-bottom: 0cm"><a href="#__RefHeading__12743_71337508">取得
	<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tracepoint
	</a></span></font></font><a href="#__RefHeading__12743_71337508">的状态<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	34</a></span></font></font></p>
	<p style="margin-left: 1cm; margin-bottom: 0cm"><a href="#__RefHeading__12745_71337508">设置<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">trace</a></span></font></font><a href="#__RefHeading__12745_71337508">缓存为循环缓存<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	35</a></span></font></font></p>
	<p style="margin-left: 1cm; margin-bottom: 0cm"><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US"><a href="#__RefHeading__12747_71337508">GDB</a></span></font></font><a href="#__RefHeading__12747_71337508">断开的时候不要停止<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tracepoint	36</a></span></font></font></p>
	<p style="margin-left: 1cm; margin-bottom: 0cm"><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US"><a href="#__RefHeading__12749_71337508">kprobes-optimization</a></span></font></font><a href="#__RefHeading__12749_71337508">和<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tracepoint</a></span></font></font><a href="#__RefHeading__12749_71337508">的执行速度<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	37</a></span></font></font></p>
	<p style="margin-left: 0.5cm; margin-bottom: 0cm"><a href="#__RefHeading__12751_71337508">如何使用<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">trace</a></span></font></font><a href="#__RefHeading__12751_71337508">状态变量<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	38</a></span></font></font></p>
	<p style="margin-left: 1cm; margin-bottom: 0cm"><a href="#__RefHeading__12753_71337508">普通<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">trace</a></span></font></font><a href="#__RefHeading__12753_71337508">状态变量<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	39</a></span></font></font></p>
	<p style="margin-left: 1cm; margin-bottom: 0cm"><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US"><a href="#__RefHeading__12755_71337508">Per_cpu
	trace</a></span></font></font><a href="#__RefHeading__12755_71337508">状态变量<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	41</a></span></font></font></p>
	<p style="margin-left: 1.5cm; margin-bottom: 0cm"><a href="#__RefHeading__13574_71337508">如何定义<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	42</a></span></font></font></p>
	<p style="margin-left: 2cm; margin-bottom: 0cm"><a href="#__RefHeading__13576_71337508">本地<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">CPU</a></span></font></font><a href="#__RefHeading__13576_71337508">变量<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	42</a></span></font></font></p>
	<p style="margin-left: 2cm; margin-bottom: 0cm"><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US"><a href="#__RefHeading__13578_71337508">CPU
	id</a></span></font></font><a href="#__RefHeading__13578_71337508">变量<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	42</a></span></font></font></p>
	<p style="margin-left: 1.5cm; margin-bottom: 0cm"><a href="#__RefHeading__13580_71337508">例子<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">1	43</a></span></font></font></p>
	<p style="margin-left: 1.5cm; margin-bottom: 0cm"><a href="#__RefHeading__13582_71337508">例子<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">2	44</a></span></font></font></p>
	<p style="margin-left: 1cm; margin-bottom: 0cm"><a href="#__RefHeading__13584_71337508">特殊<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">trace</a></span></font></font><a href="#__RefHeading__13584_71337508">状态变量
	<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">$current_task</a></span></font></font><a href="#__RefHeading__13584_71337508">，<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">$current_task_pid</a></span></font></font><a href="#__RefHeading__13584_71337508">，<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">$current_thread_info</a></span></font></font><a href="#__RefHeading__13584_71337508">，<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">$cpu_id</a></span></font></font><a href="#__RefHeading__13584_71337508">，<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">$dump_stack</a></span></font></font><a href="#__RefHeading__13584_71337508">，<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">$printk_level</a></span></font></font><a href="#__RefHeading__13584_71337508">，
<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">$printk_format</a></span></font></font><a href="#__RefHeading__13584_71337508">，<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">$printk_tmp</a></span></font></font><a href="#__RefHeading__13584_71337508">，<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">$clock</a></span></font></font><a href="#__RefHeading__13584_71337508">，<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">$hardirq_count</a></span></font></font><a href="#__RefHeading__13584_71337508">，<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">$softirq_count
	</a></span></font></font><a href="#__RefHeading__13584_71337508">和
	<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">$irq_count	45</a></span></font></font></p>
	<p style="margin-left: 1cm; margin-bottom: 0cm"><a href="#__RefHeading__13586_71337508">特殊<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">trace</a></span></font></font><a href="#__RefHeading__13586_71337508">状态变量
	<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">$self_trace	47</a></span></font></font></p>
	<p style="margin-left: 1cm; margin-bottom: 0cm"><a href="#__RefHeading__13588_71337508">用<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">$kret
	trace</a></span></font></font><a href="#__RefHeading__13588_71337508">函数的结尾<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	48</a></span></font></font></p>
	<p style="margin-left: 1cm; margin-bottom: 0cm"><a href="#__RefHeading__13590_71337508">用
	<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">$ignore_error
	</a></span></font></font><a href="#__RefHeading__13590_71337508">和
	<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">$last_errno
	</a></span></font></font><a href="#__RefHeading__13590_71337508">忽略<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tstart</a></span></font></font><a href="#__RefHeading__13590_71337508">的错误<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	49</a></span></font></font></p>
	<p style="margin-left: 1cm; margin-bottom: 0cm"><a href="#__RefHeading__13592_71337508">使用
	<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">$cooked_clock
	</a></span></font></font><a href="#__RefHeading__13592_71337508">和
	<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">$cooked_rdtsc
	</a></span></font></font><a href="#__RefHeading__13592_71337508">取得不包含<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">KGTP</a></span></font></font><a href="#__RefHeading__13592_71337508">运行时间的时间信息<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	50</a></span></font></font></p>
	<p style="margin-left: 1cm; margin-bottom: 0cm"><a href="#__RefHeading__13594_71337508">使用
	<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">$xtime_sec
	</a></span></font></font><a href="#__RefHeading__13594_71337508">和
	<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">$xtime_nsec
	</a></span></font></font><a href="#__RefHeading__13594_71337508">取得
	<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">timespec	51</a></span></font></font></p>
	<p style="margin-left: 0.5cm; margin-bottom: 0cm"><a href="#__RefHeading__13596_71337508">如何
	<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">backtrace
	(stack dump)	52</a></span></font></font></p>
	<p style="margin-left: 1cm; margin-bottom: 0cm"><a href="#__RefHeading__13598_71337508">通过<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">$bt</a></span></font></font><a href="#__RefHeading__13598_71337508">收集栈并用<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</a></span></font></font><a href="#__RefHeading__13598_71337508">命令<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">backtrace</a></span></font></font><a href="#__RefHeading__13598_71337508">进行分析<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	53</a></span></font></font></p>
	<p style="margin-left: 1cm; margin-bottom: 0cm"><a href="#__RefHeading__13600_71337508">用<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">$_ret</a></span></font></font><a href="#__RefHeading__13600_71337508">来取得当前函数的调用函数的栈<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	56</a></span></font></font></p>
	<p style="margin-left: 1cm; margin-bottom: 0cm"><a href="#__RefHeading__13602_71337508">用
	<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">$dump_stack
	</a></span></font></font><a href="#__RefHeading__13602_71337508">输出栈分析到<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">printk</a></span></font></font><a href="#__RefHeading__13602_71337508">里<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	58</a></span></font></font></p>
	<p style="margin-left: 0.5cm; margin-bottom: 0cm"><a href="#__RefHeading__13604_71337508">如何让<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tracepoint</a></span></font></font><a href="#__RefHeading__13604_71337508">直接输出信息<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	59</a></span></font></font></p>
	<p style="margin-left: 1cm; margin-bottom: 0cm"><a href="#__RefHeading__9855_1050592842">切换<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">collect</a></span></font></font><a href="#__RefHeading__9855_1050592842">为直接输出数据<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	59</a></span></font></font></p>
	<p style="margin-left: 0.5cm; margin-bottom: 0cm"><a href="#__RefHeading__9857_1050592842">如何用<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">watch
	tracepoint</a></span></font></font><a href="#__RefHeading__9857_1050592842">控制硬件断点记录内存访问<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	61</a></span></font></font></p>
	<p style="margin-left: 1cm; margin-bottom: 0cm"><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US"><a href="#__RefHeading__9859_1050592842">watch
	tracepoint</a></span></font></font><a href="#__RefHeading__9859_1050592842">的<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">trace</a></span></font></font><a href="#__RefHeading__9859_1050592842">状态变量<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	62</a></span></font></font></p>
	<p style="margin-left: 1cm; margin-bottom: 0cm"><a href="#__RefHeading__9861_1050592842">静态<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">watch
	tracepoint	65</a></span></font></font></p>
	<p style="margin-left: 1cm; margin-bottom: 0cm"><a href="#__RefHeading__11527_1050592842">动态<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">watch
	tracepoint	66</a></span></font></font></p>
	<p style="margin-left: 0.5cm; margin-bottom: 0cm"><a href="#__RefHeading__11529_1050592842">使用<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">while-stepping</a></span></font></font><a href="#__RefHeading__11529_1050592842">让<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">Linux</a></span></font></font><a href="#__RefHeading__11529_1050592842">内核做单步<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	67</a></span></font></font></p>
	<p style="margin-left: 1cm; margin-bottom: 0cm"><a href="#__RefHeading__11531_1050592842">如何使用
	<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">while-stepping	67</a></span></font></font></p>
	<p style="margin-left: 1cm; margin-bottom: 0cm"><a href="#__RefHeading__11533_1050592842">读<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">while-stepping</a></span></font></font><a href="#__RefHeading__11533_1050592842">的<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">traceframe	68</a></span></font></font></p>
	<p style="margin-left: 0.5cm; margin-bottom: 0cm"><a href="#__RefHeading__11535_1050592842">如何显示被优化掉的变量值<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	70</a></span></font></font></p>
	<p style="margin-left: 1cm; margin-bottom: 0cm"><a href="#__RefHeading__11537_1050592842">升级你的<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GCC	70</a></span></font></font></p>
	<p style="margin-left: 1cm; margin-bottom: 0cm"><a href="#__RefHeading__11539_1050592842">通过分析汇编代码取得访问被优化掉变量的方法<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	71</a></span></font></font></p>
	<p style="margin-left: 0.5cm; margin-bottom: 0cm"><a href="#__RefHeading__11541_1050592842">如何取得函数指针指向的函数<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	74</a></span></font></font></p>
	<p style="margin-left: 1cm; margin-bottom: 0cm"><a href="#__RefHeading__11543_1050592842">如果函数指针没有被优化掉<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	74</a></span></font></font></p>
	<p style="margin-left: 1cm; margin-bottom: 0cm"><a href="#__RefHeading__11545_1050592842">如果函数指针被优化掉了<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	75</a></span></font></font></p>
	<p style="margin-left: 0.5cm; margin-bottom: 0cm"><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US"><a href="#__RefHeading__11547_1050592842">/sys/kernel/debug/gtpframe</a></span></font></font><a href="#__RefHeading__11547_1050592842">和离线调试<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	76</a></span></font></font></p>
	<p style="margin-left: 0.5cm; margin-bottom: 0cm"><a href="#__RefHeading__11549_1050592842">如何使用
	<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">/sys/kernel/debug/gtpframe_pipe	78</a></span></font></font></p>
	<p style="margin-left: 1cm; margin-bottom: 0cm"><a href="#__RefHeading__11551_1050592842">用<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</a></span></font></font><a href="#__RefHeading__11551_1050592842">读帧信息<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	78</a></span></font></font></p>
	<p style="margin-left: 1cm; margin-bottom: 0cm"><a href="#__RefHeading__11553_1050592842">用<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">cat</a></span></font></font><a href="#__RefHeading__11553_1050592842">读帧信息<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	79</a></span></font></font></p>
	<p style="margin-left: 1cm; margin-bottom: 0cm"><a href="#__RefHeading__11555_1050592842">用<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">getframe</a></span></font></font><a href="#__RefHeading__11555_1050592842">读帧信息<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	80</a></span></font></font></p>
	<p style="margin-left: 1cm; margin-bottom: 0cm"><a href="#__RefHeading__11557_1050592842">使用
	<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">$pipe_trace	81</a></span></font></font></p>
	<p style="margin-left: 0.5cm; margin-bottom: 0cm"><a href="#__RefHeading__11559_1050592842">和用户程序一起使用<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">KGTP	82</a></span></font></font></p>
	<p style="margin-left: 1cm; margin-bottom: 0cm"><a href="#__RefHeading__5425_673718429">让<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</a></span></font></font><a href="#__RefHeading__5425_673718429">为访问用户程序而连接<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">KGTP	82</a></span></font></font></p>
	<p style="margin-left: 1cm; margin-bottom: 0cm"><a href="#__RefHeading__5691_673718429">直接读用户程序的内存<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	83</a></span></font></font></p>
	<p style="margin-left: 1cm; margin-bottom: 0cm"><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US"><a href="#__RefHeading__5693_673718429">Trace</a></span></font></font><a href="#__RefHeading__5693_673718429">用户程序<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	84</a></span></font></font></p>
	<p style="margin-left: 1cm; margin-bottom: 0cm"><a href="#__RefHeading__11563_1050592842">在<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tracepoint</a></span></font></font><a href="#__RefHeading__11563_1050592842">收集系统调用的从内核到用户层的的栈信息<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">(</a></span></font></font><a href="#__RefHeading__11563_1050592842">可用来做<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">backtrace)	86</a></span></font></font></p>
	<p style="margin-left: 1cm; margin-bottom: 0cm"><a href="#__RefHeading__11565_1050592842">如何使用
	<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">add-ons/hotcode.py	89</a></span></font></font></p>
	<p style="margin-left: 0.5cm; margin-bottom: 0cm"><a href="#__RefHeading__11567_1050592842">如何增加用<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">C</a></span></font></font><a href="#__RefHeading__11567_1050592842">写的插件<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	90</a></span></font></font></p>
	<p style="margin-left: 1cm; margin-bottom: 0cm"><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US"><a href="#__RefHeading__11569_1050592842">API	91</a></span></font></font></p>
	<p style="margin-left: 1cm; margin-bottom: 0cm"><a href="#__RefHeading__11571_1050592842">例子<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	93</a></span></font></font></p>
	<p style="margin-left: 1cm; margin-bottom: 0cm"><a href="#__RefHeading__11573_1050592842">如何使用<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	94</a></span></font></font></p>
	<p style="margin-left: 0.5cm; margin-bottom: 0cm"><a href="#__RefHeading__11575_1050592842">如何使用性能计数器<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	95</a></span></font></font></p>
	<p style="margin-left: 1cm; margin-bottom: 0cm"><a href="#__RefHeading__11577_1050592842">定义一个<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">perf
	event trace</a></span></font></font><a href="#__RefHeading__11577_1050592842">状态变量<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	96</a></span></font></font></p>
	<p style="margin-left: 1cm; margin-bottom: 0cm"><a href="#__RefHeading__11579_1050592842">定义一个<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">per_cpu
	perf event trace</a></span></font></font><a href="#__RefHeading__11579_1050592842">状态变量<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	97</a></span></font></font></p>
	<p style="margin-left: 1cm; margin-bottom: 0cm"><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US"><a href="#__RefHeading__11581_1050592842">perf
	event</a></span></font></font><a href="#__RefHeading__11581_1050592842">的类型和配置<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	98</a></span></font></font></p>
	<p style="margin-left: 1cm; margin-bottom: 0cm"><a href="#__RefHeading__11583_1050592842">用<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">$p_pe_en</a></span></font></font><a href="#__RefHeading__11583_1050592842">打开和关闭一个<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">CPU</a></span></font></font><a href="#__RefHeading__11583_1050592842">上所有的<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">perf
	event	100</a></span></font></font></p>
	<p style="margin-left: 1cm; margin-bottom: 0cm"><a href="#__RefHeading__11585_1050592842">用来帮助设置和取得<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">perf
	event trace</a></span></font></font><a href="#__RefHeading__11585_1050592842">状态变量的<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</a></span></font></font><a href="#__RefHeading__11585_1050592842">脚本<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	101</a></span></font></font></p>
	<p style="margin-bottom: 0cm"><a href="#__RefHeading__11597_1305468286">附录<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">A
	</a></span></font></font><a href="#__RefHeading__11597_1305468286">使用<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">KGTP</a></span></font></font><a href="#__RefHeading__11597_1305468286">前的准备工作<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	104</a></span></font></font></p>
	<p style="margin-left: 0.5cm; margin-bottom: 0cm"><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US"><a href="#__RefHeading__10124_71337508">Linux</a></span></font></font><a href="#__RefHeading__10124_71337508">内核<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	104</a></span></font></font></p>
	<p style="margin-left: 1cm; margin-bottom: 0cm"><a href="#__RefHeading__10126_71337508">如果你的系统内核是自己编译的<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	104</a></span></font></font></p>
	<p style="margin-left: 1cm; margin-bottom: 0cm"><a href="#__RefHeading__10128_71337508">如果是<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">Android</a></span></font></font><a href="#__RefHeading__10128_71337508">内核<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	105</a></span></font></font></p>
	<p style="margin-left: 1cm; margin-bottom: 0cm"><a href="#__RefHeading__10130_71337508">如果你的系统内核是发行版自带的<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	106</a></span></font></font></p>
	<p style="margin-left: 1.5cm; margin-bottom: 0cm"><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US"><a href="#__RefHeading__10132_71337508">Ubuntu	106</a></span></font></font></p>
	<p style="margin-left: 2cm; margin-bottom: 0cm"><a href="#__RefHeading__10134_71337508">安装<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">Linux</a></span></font></font><a href="#__RefHeading__10134_71337508">内核调试镜像的标准方法<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	106</a></span></font></font></p>
	<p style="margin-left: 2cm; margin-bottom: 0cm"><a href="#__RefHeading__10136_71337508">安装<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">Linux</a></span></font></font><a href="#__RefHeading__10136_71337508">内核调试镜像的第二方法<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	106</a></span></font></font></p>
	<p style="margin-left: 2cm; margin-bottom: 0cm"><a href="#__RefHeading__10138_71337508">安装内核头文件包<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	107</a></span></font></font></p>
	<p style="margin-left: 2cm; margin-bottom: 0cm"><a href="#__RefHeading__10140_71337508">安装内核源码<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	107</a></span></font></font></p>
	<p style="margin-left: 2.5cm; margin-bottom: 0cm"><a href="#__RefHeading__10657_680043226">新方法<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	107</a></span></font></font></p>
	<p style="margin-left: 2.5cm; margin-bottom: 0cm"><a href="#__RefHeading__10659_680043226">老方法<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	107</a></span></font></font></p>
	<p style="margin-left: 1.5cm; margin-bottom: 0cm"><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US"><a href="#__RefHeading__10142_71337508">Fedora	108</a></span></font></font></p>
	<p style="margin-left: 2cm; margin-bottom: 0cm"><a href="#__RefHeading__10144_71337508">安装<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">Linux</a></span></font></font><a href="#__RefHeading__10144_71337508">内核调试镜像<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	108</a></span></font></font></p>
	<p style="margin-left: 2cm; margin-bottom: 0cm"><a href="#__RefHeading__10146_71337508">安装<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">Linux</a></span></font></font><a href="#__RefHeading__10146_71337508">内核开发包<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	108</a></span></font></font></p>
	<p style="margin-left: 1.5cm; margin-bottom: 0cm"><a href="#__RefHeading__10148_71337508">其他系统<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	109</a></span></font></font></p>
	<p style="margin-left: 1cm; margin-bottom: 0cm"><a href="#__RefHeading__10150_71337508">确定<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">Linux</a></span></font></font><a href="#__RefHeading__10150_71337508">内核调试镜像是正确的<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	110</a></span></font></font></p>
	<p style="margin-left: 1.5cm; margin-bottom: 0cm"><a href="#__RefHeading__10152_71337508">当前<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">Linux</a></span></font></font><a href="#__RefHeading__10152_71337508">内核调试镜像在哪<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	111</a></span></font></font></p>
	<p style="margin-left: 1.5cm; margin-bottom: 0cm"><a href="#__RefHeading__10154_71337508">使用<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">/proc/kallsyms	112</a></span></font></font></p>
	<p style="margin-left: 1.5cm; margin-bottom: 0cm"><a href="#__RefHeading__10156_71337508">使用<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">linux_banner	113</a></span></font></font></p>
	<p style="margin-left: 1cm; margin-bottom: 0cm"><a href="#__RefHeading__10754_71337508">处理<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">Linux</a></span></font></font><a href="#__RefHeading__10754_71337508">内核调试镜像地址信息和<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">Linux</a></span></font></font><a href="#__RefHeading__10754_71337508">内核执行时不同的问题<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	114</a></span></font></font></p>
	<p style="margin-left: 0.5cm; margin-bottom: 0cm"><a href="#__RefHeading__10756_71337508">取得<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">KGTP	115</a></span></font></font></p>
	<p style="margin-left: 1cm; margin-bottom: 0cm"><a href="#__RefHeading__10758_71337508">通过<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">http</a></span></font></font><a href="#__RefHeading__10758_71337508">下载<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">KGTP	115</a></span></font></font></p>
	<p style="margin-left: 1cm; margin-bottom: 0cm"><a href="#__RefHeading__10760_71337508">通过<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">git</a></span></font></font><a href="#__RefHeading__10760_71337508">下载<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">KGTP	116</a></span></font></font></p>
	<p style="margin-left: 1cm; margin-bottom: 0cm"><a href="#__RefHeading__10791_1267614711">镜像<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	117</a></span></font></font></p>
	<p style="margin-left: 0.5cm; margin-bottom: 0cm"><a href="#__RefHeading__10762_71337508">配置<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">KGTP	118</a></span></font></font></p>
	<p style="margin-left: 0.5cm; margin-bottom: 0cm"><a href="#__RefHeading__10764_71337508">编译<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">KGTP	119</a></span></font></font></p>
	<p style="margin-left: 1cm; margin-bottom: 0cm"><a href="#__RefHeading__10766_71337508">普通编译<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	119</a></span></font></font></p>
	<p style="margin-left: 1cm; margin-bottom: 0cm"><a href="#__RefHeading__10768_71337508">用一些特殊选项编译<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">KGTP	120</a></span></font></font></p>
	<p style="margin-left: 0.5cm; margin-bottom: 0cm"><a href="#__RefHeading__10770_71337508">安装和卸载
	<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">KGTP	121</a></span></font></font></p>
	<p style="margin-left: 0.5cm; margin-bottom: 0cm"><a href="#__RefHeading__10772_71337508">和<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">DKMS</a></span></font></font><a href="#__RefHeading__10772_71337508">一起使用<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">KGTP	122</a></span></font></font></p>
	<p style="margin-left: 0.5cm; margin-bottom: 0cm"><a href="#__RefHeading__10774_71337508">使用<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">KGTP
	Linux</a></span></font></font><a href="#__RefHeading__10774_71337508">内核<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">patch	123</a></span></font></font></p>
	<p style="margin-left: 0.5cm; margin-bottom: 0cm"><a href="#__RefHeading__10776_71337508">安装可以和<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">KGTP</a></span></font></font><a href="#__RefHeading__10776_71337508">一起使用的<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB	124</a></span></font></font></p>
	<p style="margin-bottom: 0cm"><a href="#__RefHeading__11575_71337508">附录<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">B
	</a></span></font></font><a href="#__RefHeading__11575_71337508">如何让<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</a></span></font></font><a href="#__RefHeading__11575_71337508">连接<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">KGTP	125</a></span></font></font></p>
	<p style="margin-left: 0.5cm; margin-bottom: 0cm"><a href="#__RefHeading__11577_71337508">普通<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">Linux	125</a></span></font></font></p>
	<p style="margin-left: 1cm; margin-bottom: 0cm"><a href="#__RefHeading__11579_71337508">安装<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">KGTP</a></span></font></font><a href="#__RefHeading__11579_71337508">模块<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	125</a></span></font></font></p>
	<p style="margin-left: 1cm; margin-bottom: 0cm"><a href="#__RefHeading__11581_71337508">处理找不到<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">&quot;/sys/kernel/debug/gtp&quot;</a></span></font></font><a href="#__RefHeading__11581_71337508">的问题<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	126</a></span></font></font></p>
	<p style="margin-left: 1cm; margin-bottom: 0cm"><a href="#__RefHeading__11583_71337508">让<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</a></span></font></font><a href="#__RefHeading__11583_71337508">连接到<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">KGTP	127</a></span></font></font></p>
	<p style="margin-left: 1.5cm; margin-bottom: 0cm"><a href="#__RefHeading__10902_1675807557">装载<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">Linux</a></span></font></font><a href="#__RefHeading__10902_1675807557">内核调试镜像到<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB	127</a></span></font></font></p>
	<p style="margin-left: 1.5cm; margin-bottom: 0cm"><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US"><a href="#__RefHeading__11585_71337508">GDB</a></span></font></font><a href="#__RefHeading__11585_71337508">在本地主机上<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	128</a></span></font></font></p>
	<p style="margin-left: 1.5cm; margin-bottom: 0cm"><a href="#__RefHeading__11587_71337508">如果<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</a></span></font></font><a href="#__RefHeading__11587_71337508">在远程主机上<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	129</a></span></font></font></p>
	<p style="margin-left: 0.5cm; margin-bottom: 0cm"><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US"><a href="#__RefHeading__11589_71337508">Android	130</a></span></font></font></p>
	<p style="margin-left: 1cm; margin-bottom: 0cm"><a href="#__RefHeading__11591_71337508">安装<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">KGTP</a></span></font></font><a href="#__RefHeading__11591_71337508">模块<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	131</a></span></font></font></p>
	<p style="margin-left: 1cm; margin-bottom: 0cm"><a href="#__RefHeading__11593_71337508">处理找不到<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">&quot;/sys/kernel/debug/gtp&quot;</a></span></font></font><a href="#__RefHeading__11593_71337508">的问题<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	132</a></span></font></font></p>
	<p style="margin-left: 1cm; margin-bottom: 0cm"><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US"><a href="#__RefHeading__11595_71337508">GDB</a></span></font></font><a href="#__RefHeading__11595_71337508">连接<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">KGTP	133</a></span></font></font></p>
	<p style="margin-bottom: 0cm"><a href="#__RefHeading__11597_71337508">附录<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">C
	</a></span></font></font><a href="#__RefHeading__11597_71337508">增加模块的符号信息到<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB	134</a></span></font></font></p>
	<p style="margin-left: 0.5cm; margin-bottom: 0cm"><a href="#__RefHeading__11599_71337508">如何使用<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">getmod	135</a></span></font></font></p>
	<p style="margin-left: 0.5cm; margin-bottom: 0cm"><a href="#__RefHeading__11601_71337508">如何使用<font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">getmod.py	136</a></span></font></font></p>
</div>
<p align="center"><br><br>
</p>
<h1 class="cjk" align="left" style="page-break-before: always"><a name="__RefHeading__10649_680043226"></a>
关于本文</h1>
<p><a name="__RefHeading__10651_680043226"></a><font face="DejaVu Serif, serif"><span lang="en-US"><a href="http://teawater.github.io/kgtp/kgtpcn.html">http://teawater.github.io/kgtp/kgtpcn.html</a>
</span></font>是<font face="DejaVu Serif, serif"><span lang="en-US">HTML</span></font>格式的本文最后版本。</p>
<p><a name="__RefHeading__10653_680043226"></a><font face="DejaVu Serif, serif"><span lang="en-US"><a href="https://raw.github.com/teawater/kgtp/master/kgtpcn.pdf">https://raw.github.com/teawater/kgtp/master/kgtpcn.pdf</a>
</span></font>是<font face="DejaVu Serif, serif"><span lang="en-US">PDF</span></font>格式的本文最后版本。</p>
<p><a name="__RefHeading__10655_680043226"></a><font face="DejaVu Serif, serif"><span lang="en-US"><a href="https://raw.github.com/teawater/kgtp/release/kgtpcn.pdf">https://raw.github.com/teawater/kgtp/release/kgtpcn.pdf</a>
</span></font>是<font face="DejaVu Serif, serif"><span lang="en-US">PDF</span></font>格式的本文最后发布版本。</p>
<h1 class="cjk" align="left" style="page-break-before: always"><a name="__RefHeading__5345_683619096"></a>
什么是<font face="DejaVu Sans, sans-serif"><span lang="en-US">KGTP</span></font></h1>
<p align="left"><font face="DejaVu Serif, serif"><span lang="en-US"><b>KGTP</b></span></font>是一个能在产品系统上实时分析<font face="DejaVu Serif, serif"><span lang="en-US">Linux</span></font>内核和应用程序<font face="DejaVu Serif, serif"><span lang="en-US">(</span></font>包括<font face="DejaVu Serif, serif"><span lang="en-US">Android)</span></font>问题的全面动态跟踪器。</p>
<p align="left">使用<font face="DejaVu Serif, serif"><span lang="en-US">KGTP
</span></font>不需要 在<font face="DejaVu Serif, serif"><span lang="en-US">Linux</span></font>内核上打<font face="DejaVu Serif, serif"><span lang="en-US">PATCH</span></font>或者重新编译，只要编译<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>模块并<font face="DejaVu Serif, serif"><span lang="en-US">insmod</span></font>就可以。</p>
<p align="left">其让<font face="DejaVu Serif, serif"><span lang="en-US">Linux</span></font>内核提供一个远程<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>调试接口，于是在本地或者远程的主机上的<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>可以在不需要停止内核的情况下用<font face="DejaVu Serif, serif"><span lang="en-US">GDB
tracepoint</span></font>和其他一些功能 <b>调试</b> 和 <b>跟踪</b>
<font face="DejaVu Serif, serif"><span lang="en-US">Linux</span></font>内核和应用程序。</p>
<p align="left">即使板子上没有<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>而且其没有可用的远程接口，<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>也可以用离线调试的功能调试内核（见<font face="DejaVu Serif, serif"><span lang="en-US"><a href="#/sys/kernel/debug/gtpframe和离线调试|outline">/sys/kernel/debug/gtpframe</a></span></font><a href="#/sys/kernel/debug/gtpframe和离线调试|outline">和离线调试</a>）。</p>
<p align="left"><br><br>
</p>
<p align="left"><font face="DejaVu Serif, serif"><span lang="en-US"><a href="http://www.youtube.com/watch?v=7nfGAbNsEZY">http://www.youtube.com/watch?v=7nfGAbNsEZY</a>
</span></font>或者 <font face="DejaVu Serif, serif"><span lang="en-US"><a href="http://www.tudou.com/programs/view/fPu_koiKo38/">http://www.tudou.com/programs/view/fPu_koiKo38/</a>
</span></font>是介绍<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>的<b>英文</b>视频。
</p>
<p align="left"><font face="DejaVu Serif, serif"><span lang="en-US"><a href="http://www.infoq.com/cn/presentations/gdb-sharp-knife-kgtp-linux-kernel">http://www.infoq.com/cn/presentations/gdb-sharp-knife-kgtp-linux-kernel</a>
</span></font>是介绍<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>的<b>中文</b>视频。</p>
<p align="left"><br><br>
</p>
<p align="left"><font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>支持
<font face="DejaVu Serif, serif"><span lang="en-US"><b>X86-32</b> </span></font>，
<font face="DejaVu Serif, serif"><span lang="en-US"><b>X86-64</b> </span></font>，
<font face="DejaVu Serif, serif"><span lang="en-US"><b>MIPS</b> </span></font>和
<font face="DejaVu Serif, serif"><span lang="en-US"><b>ARM</b> </span></font>。</p>
<p align="left"><font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>支持大部分版本的<font face="DejaVu Serif, serif"><span lang="en-US">Linux</span></font>内核
<font face="DejaVu Serif, serif"><span lang="en-US">(</span></font>从<font face="DejaVu Serif, serif"><span lang="en-US"><b>2.6.18</b>
</span></font>到<b>最新版</b><font face="DejaVu Serif, serif"><span lang="en-US">)</span></font>。</p>
<p align="left"><br><br>
</p>
<p align="left">请到 <font face="DejaVu Serif, serif"><span lang="en-US"><a href="#https://code.google.com/p/kgtp/wiki/UPDATE">UPDATE</a>
</span></font>去看<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>的更新信息。</p>
<p align="left"><br><br>
</p>
<h1 class="cjk" style="page-break-before: always"><a name="__RefHeading__11595_1305468286"></a><a name="3.快速配置和启动KGTP|outline"></a>
快速配置和启动<font face="DejaVu Sans, sans-serif"><span lang="en-US">KGTP</span></font></h1>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#kgtp.py</i></span></font>将在本机上自动配置和启动<font face="DejaVu Serif, serif"><span lang="en-US"><i>KGTP</i></span></font>和<font face="DejaVu Serif, serif"><span lang="en-US"><i>GDB</i></span></font>。
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#</i></span></font>第一次使用这个脚本需要等一段时间因为有一些包需要下载。
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>wget
https://raw.githubusercontent.com/teawater/kgtp/master/kgtp.py </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>sudo
python kgtp.py </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#</i></span></font>访问内核的内存。
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
p jiffies_64 </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>$2
= 5081634360 </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#</i></span></font>在函数<font face="DejaVu Serif, serif"><span lang="en-US"><i>vfs_read</i></span></font>上设置<font face="DejaVu Serif, serif"><span lang="en-US"><i>trace</i></span></font>点并收集这个函数的<font face="DejaVu Serif, serif"><span lang="en-US"><i>backtrace</i></span></font>信息。
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
trace vfs_read </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Tracepoint
1 at 0xffffffff811b8c70: file fs/read_write.c, line 382. </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
actions </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Enter
actions for tracepoint 1, one per line. </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>End
with a line saying just &quot;end&quot;. </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;collect
$bt </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;end
</i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
tstart </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
tstop </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
tfind </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Found
trace frame 0, tracepoint 1 </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#0
vfs_read (file=file@entry=0xffff88022017b000, </i></span></font>
</blockquote>
<blockquote class="cjk"> <font face="DejaVu Serif, serif"><span lang="en-US"><i>buf=buf@entry=0x7fff0fdd80f0
&lt;Address 0x7fff0fdd80f0 out of bounds&gt;, </i></span></font>
</blockquote>
<blockquote class="cjk"> <font face="DejaVu Serif, serif"><span lang="en-US"><i>count=count@entry=16,
pos=pos@entry=0xffff8800626aff50) at fs/read_write.c:382 </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>382
{ </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
bt </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#0
vfs_read (file=file@entry=0xffff88022017b000, </i></span></font>
</blockquote>
<blockquote class="cjk"> <font face="DejaVu Serif, serif"><span lang="en-US"><i>buf=buf@entry=0x7fff0fdd80f0
&lt;Address 0x7fff0fdd80f0 out of bounds&gt;, </i></span></font>
</blockquote>
<blockquote class="cjk"> <font face="DejaVu Serif, serif"><span lang="en-US"><i>count=count@entry=16,
pos=pos@entry=0xffff8800626aff50) at fs/read_write.c:382 </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#1
0xffffffff811b9819 in SYSC_read (count=16, </i></span></font>
</blockquote>
<blockquote class="cjk"> <font face="DejaVu Serif, serif"><span lang="en-US"><i>buf=0x7fff0fdd80f0
&lt;Address 0x7fff0fdd80f0 out of bounds&gt;, fd=&lt;optimized out&gt;)
</i></span></font>
</blockquote>
<blockquote class="cjk"> <font face="DejaVu Serif, serif"><span lang="en-US"><i>at
fs/read_write.c:506</i></span></font></blockquote>
<p><br><br>
</p>
<p>如果要在远程主机或者和<font face="DejaVu Serif, serif"><span lang="en-US">Android</span></font>一起使用<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>，请阅读<a href="#7.附录A 使用KGTP前的准备工作|outline">附录<font face="DejaVu Serif, serif"><span lang="en-US">A
</a></span></font><a href="#7.附录A 使用KGTP前的准备工作|outline">使用<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</a></span></font><a href="#7.附录A 使用KGTP前的准备工作|outline">前的准备工作</a>和<a href="#8.附录B 如何让GDB连接KGTP|outline">附录<font face="DejaVu Serif, serif"><span lang="en-US">B
</a></span></font><a href="#8.附录B 如何让GDB连接KGTP|outline">如何让<font face="DejaVu Serif, serif"><span lang="en-US">GDB</a></span></font><a href="#8.附录B 如何让GDB连接KGTP|outline">连接<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</a></span></font>。</p>
<h1 class="cjk" style="page-break-before: always"><a name="__RefHeading__3899_71337508"></a><a name="需要帮助或者汇报问题|outline"></a>
需要帮助或者汇报问题</h1>
<p align="left">请把问题发到<font face="DejaVu Serif, serif"><span lang="en-US"><a href="https://github.com/teawater/kgtp/issues">https://github.com/teawater/kgtp/issues</a></span></font>。</p>
<p align="left">或者写信到<font face="DejaVu Serif, serif"><span lang="en-US"><a href="mailto:teawater@gmail.com?Subject=汇报一个KGTP的问题">mailto:</a><a href="mailto:teawater@gmail.com">teawater@gmail.com</a><a href="mailto:teawater@gmail.com?Subject=汇报一个KGTP的问题">?Subject=</a></span></font><a href="mailto:teawater@gmail.com?Subject=汇报一个KGTP的问题">汇报一个<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</a></span></font><a href="mailto:teawater@gmail.com?Subject=汇报一个KGTP的问题">的问题</a>。</p>
<p align="left">或者汇报到<font face="DejaVu Serif, serif"><span lang="en-US">QQ</span></font>群<font face="DejaVu Serif, serif"><span lang="en-US"><b>317654748</b></span></font>。</p>
<p align="left"><font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>小组将尽全力帮助你。</p>
<p align="left"><br><br>
</p>
<p align="left">请到 <font face="DejaVu Serif, serif"><span lang="en-US"><a href="https://code.google.com/p/kgtp/issues/list">https://code.google.com/p/kgtp/issues/list</a>
</span></font>访问旧问题列表。</p>
<h1 class="cjk" style="page-break-before: always"><a name="__RefHeading__10120_71337508"></a>
<font face="DejaVu Sans, sans-serif"><span lang="en-US">GDB</span></font>调试普通程序和<font face="DejaVu Sans, sans-serif"><span lang="en-US">KGTP</span></font>的区别表</h1>
<p align="left">这个表是给在使用过<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>调试程序的人准备的，他可以帮助你理解和记住<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>的功能。</p>
<table width="643" cellpadding="4" cellspacing="0">
	<col width="118">
	<col width="163">
	<col width="336">
	<tr valign="top">
		<td width="118" style="border-top: 1px solid #000000; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0.1cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt"><b>功能</b></font></p>
		</td>
		<td width="163" style="border-top: 1px solid #000000; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0.1cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US"><b>GDB</b></span></font></font><font size="3" style="font-size: 12pt"><b>调试普通程序</b></font></p>
		</td>
		<td width="336" style="border: 1px solid #000000; padding: 0.1cm">
			<p align="left"><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US"><b>GDB</b></span></font></font><font size="3" style="font-size: 12pt"><b>控制</b></font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US"><b>KGTP</b></span></font></font><font size="3" style="font-size: 12pt"><b>调试</b></font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US"><b>Linux</b></span></font></font><font size="3" style="font-size: 12pt"><b>内核</b></font></p>
		</td>
	</tr>
	<tr valign="top">
		<td width="118" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt">准备工作</font></p>
		</td>
		<td width="163" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt">系统里安装了</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</span></font></font><font size="3" style="font-size: 12pt">。</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US"><br></span></font></font><font size="3" style="font-size: 12pt">程序用
			</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">&quot;-g&quot;</span></font></font><font size="3" style="font-size: 12pt">选项编译。</font></p>
		</td>
		<td rowspan="2" width="336" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: 1px solid #000000; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0.1cm">
			<p align="left"><a href="#3.快速配置和启动KGTP|outline"><font size="3" style="font-size: 12pt">快速配置和启动</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US"><font size="3" style="font-size: 12pt">KGTP</font></a></span></font></font></p>
		</td>
	</tr>
	<tr valign="top">
		<td width="118" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">Attach</span></font></font></p>
		</td>
		<td width="163" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt">使用命令</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">&quot;gdb
			-p pid&quot;</span></font></font><font size="3" style="font-size: 12pt">或者</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</span></font></font><font size="3" style="font-size: 12pt">命令</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">&quot;attach
			pid&quot;</span></font></font><font size="3" style="font-size: 12pt">可以</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">attach</span></font></font><font size="3" style="font-size: 12pt">系统中的某个程序</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">.</span></font></font></p>
		</td>
	</tr>
	<tr valign="top">
		<td width="118" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">Breakpoints</span></font></font></p>
		</td>
		<td width="163" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</span></font></font><font size="3" style="font-size: 12pt">命令</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">&quot;b
			place_will_stop&quot;</span></font></font><font size="3" style="font-size: 12pt">，让程序在执行这个命令后执行，则程序将停止在设置这个断点的地方。</font></p>
		</td>
		<td width="336" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: 1px solid #000000; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0.1cm">
			<p align="left"><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">KGTP</span></font></font><font size="3" style="font-size: 12pt">不支持断点但是支持</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tracepoint</span></font></font><font size="3" style="font-size: 12pt">。</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">Tracepoints</span></font></font><font size="3" style="font-size: 12pt">可以被看作一种特殊的断点。其可以设置在</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">Linux
			kernel</span></font></font><font size="3" style="font-size: 12pt">中的一些地方然后定义一些命令到它的</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">action</span></font></font><font size="3" style="font-size: 12pt">中。当</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tracepoint</span></font></font><font size="3" style="font-size: 12pt">开始的时候，他们将会在内核执行到这些地方的时候执行这些命令。当</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tracepoint</span></font></font><font size="3" style="font-size: 12pt">停止的时候，你可以像断点停止程序后你做的那样用</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</span></font></font><font size="3" style="font-size: 12pt">命令分析</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tracepoint</span></font></font><font size="3" style="font-size: 12pt">得到的数据。
			<b>区别</b>是断点会停止程序但是</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">KGTP</span></font></font><font size="3" style="font-size: 12pt">中的</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tracepoint</span></font></font><font size="3" style="font-size: 12pt">不会。
			请到 </font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US"><a href="#GDB tracepoint|outline">GDB
			tracepoint</a> </span></font></font><font size="3" style="font-size: 12pt">看如何使用它。</font></p>
		</td>
	</tr>
	<tr valign="top">
		<td width="118" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt">读</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">Memory</span></font></font></p>
		</td>
		<td width="163" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</span></font></font><font size="3" style="font-size: 12pt">停止程序后</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">(</span></font></font><font size="3" style="font-size: 12pt">也许不需要</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">)</span></font></font><font size="3" style="font-size: 12pt">，它可以用</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</span></font></font><font size="3" style="font-size: 12pt">命令</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">&quot;print&quot;</span></font></font><font size="3" style="font-size: 12pt">或者</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">&quot;x&quot;</span></font></font><font size="3" style="font-size: 12pt"
>等应用程序的内存。</font></p>
		</td>
		<td width="336" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: 1px solid #000000; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0.1cm">
			<p align="left"><font size="3" style="font-size: 12pt">你可以在</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tracepoint</span></font></font><font size="3" style="font-size: 12pt">中设置特殊的</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">action</span></font></font><font size="3" style="font-size: 12pt">收集内存到</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">traceframe</span></font></font><font size="3" style="font-size: 12pt">中，在</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tracepoint</span></font></font><font size="3" style="font-size: 12pt">停止后取得他们的值。</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US"><a href="#collect expr1, expr2, ...|outline">collect
			expr1, expr2, ...</a> </span></font></font><font size="3" style="font-size: 12pt"><a href="#用tfind选择trace帧缓存里面的条目|outline">用</a></font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US"><a href="#用tfind选择trace帧缓存里面的条目|outline">tfind</a></span></font></font><font size="3" style="font-size: 12pt"><a href="#用tfind选择trace帧缓存里面的条目|outline">选择</a></font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US"><a href="#用tfind选择trace帧缓存里面的条目|outline">trace</a></span></font></font><font size="3" style="font-size: 12pt"><a href="#用tfind选择trace帧缓存里面的条目|outline">帧缓存里面的条目</a>
			</font>
			</p>
			<p align="left"><font size="3" style="font-size: 12pt">或者你可以在内核或者应用程序执行的时候直接读他们的内存。<a href="#在普通模式直接访问当前值|outline">在普通模式直接访问当前值</a></font></p>
		</td>
	</tr>
	<tr valign="top">
		<td width="118" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">Step
			</span></font></font><font size="3" style="font-size: 12pt">和
			</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">continue</span></font></font></p>
		</td>
		<td width="163" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</span></font></font><font size="3" style="font-size: 12pt">可以用命令</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">&quot;continue&quot;</span></font></font><font size="3" style="font-size: 12pt">继续程序的执行，用</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">CTRL-C</span></font></font><font size="3" style="font-size: 12pt">停止其。</font></p>
		</td>
		<td width="336" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: 1px solid #000000; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0.1cm">
			<p align="left"><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US"><font size="3" style="font-size: 12pt">KGTP</font></span></font></font><font size="3" style="font-size: 12pt">不会停止</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US"><font size="3" style="font-size: 12pt">Linux</font></span></font></font><font size="3" style="font-size: 12pt">内核，但是</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US"><font size="3" style="font-size: 12pt">tracepoint</font></span></font></font><font size="3" style="font-size: 12pt">可以开始和停止。<a href="#启动和停止 tracepoint|outline">启动和停止
			</a></font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US"><font size="3" style="font-size: 12pt"><a href="#启动和停止 tracepoint|outline">tracepoint</a></font></span></font></font></p>
			<p align="left"><font size="3" style="font-size: 12pt">或者用
			</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US"><font size="3" style="font-size: 12pt">while-stepping
			tracepoint</font></span></font></font><font size="3" style="font-size: 12pt">记录一定次数的</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US"><font size="3" style="font-size: 12pt">single-stepping</font></span></font></font><font size="3" style="font-size: 12pt">然后让</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US"><font size="3" style="font-size: 12pt">KGTP</font></span></font></font><font size="3" style="font-size: 12pt">切换到回放模式。这样其就支持执行和方向执行命令了。
			<a href="#使用while-stepping让Linux内核做单步|outline">使用</a></font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US"><font size="3" style="font-size: 12pt"><a href="#使用while-stepping让Linux内核做单步|outline">while-stepping</a></font></span></font></font><font size="3" style="font-size: 12pt"><a href="#使用while-stepping让Linux内核做单步|outline">让</a></font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US"><font size="3" style="font-size: 12pt"><a href="#使用while-stepping让Linux内核做单步|outline">Linux</a></font></span></font></font><font size="3" style="font-size: 12pt"><a href="#使用while-stepping让Linux内核做单步|outline">内核做单步</a></font></p>
		</td>
	</tr>
	<tr valign="top">
		<td width="118" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">Backtrace</span></font></font></p>
		</td>
		<td width="163" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</span></font></font><font size="3" style="font-size: 12pt">可以用命令</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">&quot;backtrace&quot;</span></font></font><font size="3" style="font-size: 12pt">打印全部调用栈。</font></p>
		</td>
		<td width="336" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: 1px solid #000000; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0.1cm">
			<p align="left"><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US"><font size="3" style="font-size: 12pt">KGTP</font></span></font></font><font size="3" style="font-size: 12pt">也可以。<a href="#如何 backtrace (stack dump)|outline">如何
			</a></font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US"><font size="3" style="font-size: 12pt"><a href="#如何 backtrace (stack dump)|outline">backtrace
			(stack dump)</a></font></span></font></font></p>
		</td>
	</tr>
	<tr valign="top">
		<td width="118" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">Watchpoint</span></font></font></p>
		</td>
		<td width="163" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</span></font></font><font size="3" style="font-size: 12pt">可以用</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">watchpoint</span></font></font><font size="3" style="font-size: 12pt">让程序在某些内存访问发生的时候停止。</font></p>
		</td>
		<td width="336" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: 1px solid #000000; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0.1cm">
			<p align="left"><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US"><font size="3" style="font-size: 12pt">KGTP</font></span></font></font><font size="3" style="font-size: 12pt">可以用</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US"><font size="3" style="font-size: 12pt">watch
			tracepoint</font></span></font></font><font size="3" style="font-size: 12pt">记录内存访问。
			<a href="#如何用watch tracepoint控制硬件断点记录内存访问|outline">如何用</a></font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US"><font size="3" style="font-size: 12pt"><a href="#如何用watch tracepoint控制硬件断点记录内存访问|outline">watch
			tracepoint</a></font></span></font></font><font size="3" style="font-size: 12pt"><a href="#如何用watch tracepoint控制硬件断点记录内存访问|outline">控制硬件断点记录</a><a href="#如何用watch tracepoint控制硬件断点记录内存访问|outline">内存访问</a></font></p>
		</td>
	</tr>
	<tr valign="top">
		<td width="118" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt">调用函数</font></p>
		</td>
		<td width="163" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</span></font></font><font size="3" style="font-size: 12pt">可以用命令</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">&quot;call
			function(xx,xx)&quot;</span></font></font><font size="3" style="font-size: 12pt">调用程序中的函数。</font></p>
		</td>
		<td width="336" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: 1px solid #000000; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0.1cm">
			<p align="left"><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US"><font size="3" style="font-size: 12pt">KGTP</font></span></font></font><font size="3" style="font-size: 12pt">可以用插件调用内核中的函数。<a href="#如何增加用C写的插件|outline">如何增加用</a></font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US"><font size="3" style="font-size: 12pt"><a href="#如何增加用C写的插件|outline">C</a></font></span></font></font><font size="3" style="font-size: 12pt"><a href="#如何增加用C写的插件|outline">写的插件</a></font></p>
		</td>
	</tr>
</table>
<p align="left"><br><br>
</p>
<h1 class="cjk"><br><br>
</h1>
<p align="left"><br><br>
</p>
<h1 class="cjk" style="page-break-before: always"><a name="__RefHeading__11603_71337508"></a>
如何使用<font face="DejaVu Sans, sans-serif"><span lang="en-US">GDB</span></font>控制<font face="DejaVu Sans, sans-serif"><span lang="en-US">KGTP</span></font>跟踪和调试<font face="DejaVu Sans, sans-serif"><span lang="en-US">Linux</span></font>内核</h1>
<h2 class="cjk"><a name="__RefHeading__11605_71337508"></a><a name="在普通模式直接访问当前值|outline"></a><a name="在普通模式直接访问当前值|outline"></a><a name="在普通模式直接访问当前值|outline"></a>
在普通模式直接访问当前值</h2>
<p align="left">在<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>连到<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>上以后，如果没有用<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>命令<font face="DejaVu Serif, serif"><span lang="en-US">&quot;tfind&quot;</span></font>选择一条<font face="DejaVu Serif, serif"><span lang="en-US">trace</span></font>帧缓存里面的条目，<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>就处于
<b>普通模式</b>。于是你可以直接访问内存<font face="DejaVu Serif, serif"><span lang="en-US">(Linux</span></font>内核或者用户程序<font face="DejaVu Serif, serif"><span lang="en-US">)</span></font>的值和<font face="DejaVu Serif, serif"><span lang="en-US">trace</span></font>状态变量的值。</p>
<p align="left">如果你选择了一个<font face="DejaVu Serif, serif"><span lang="en-US">trace</span></font>帧条目，可以用<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>命令<font face="DejaVu Serif, serif"><span lang="en-US">&quot;tfind
-1&quot;</span></font>返回到普通模式。请到<a href="#在普通模式直接访问当前值|outline">在普通模式直接访问当前值</a>取得<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>命令<font face="DejaVu Serif, serif"><span lang="en-US">&quot;tfind&quot;</span></font>的更多信息。</p>
<p align="left"><br><br>
</p>
<h3 class="cjk" style="page-break-before: always"><a name="__RefHeading__11607_71337508"></a>
<font face="DejaVu Serif, serif"><span lang="en-US">Linux</span></font>内核的内存</h3>
<p align="left">例如你可以用下面的命令访问<font face="DejaVu Serif, serif"><span lang="en-US">&quot;jiffies_64&quot;</span></font>：</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
p jiffies_64</i></span></font></blockquote>
<p align="left"><br><br>
</p>
<p align="left">或者你可以用下面的命令访问<font face="DejaVu Serif, serif"><span lang="en-US">&quot;static
LIST_HEAD(modules)&quot;</span></font>的第一条记录：</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
p *((struct module *)((char *)modules-&gt;next - ((size_t) &amp;(((struct
module *)0)-&gt;list))))<br></i></span></font><br>
</blockquote>
<p align="left">或者你可以访问<font face="DejaVu Serif, serif"><span lang="en-US">&quot;DEFINE_PER_CPU(struct
device *, mce_device);&quot;CPU0</span></font>的数据：</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>p
*(struct device *)(__per_cpu_offset[0]+(uint64_t)(&amp;mce_device))</i></span></font></blockquote>
<p align="left"><br><br>
</p>
<p align="left">如果想在用一个<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>命令显示多个变量，请使用下面的例子：</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
printf &quot;%4d %4d %4d %4d %4d %4d %18d %lu\n&quot;, this_rq-&gt;cpu,
this_rq-&gt;nr_running, this_rq-&gt;nr_uninterruptible, nr_active,
calc_load_tasks-&gt;counter, this_rq-&gt;calc_load_active, delta,
this_rq-&gt;calc_load_update</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>2
1 0 0 0 0 673538312 717077240<br></i></span></font><br>
</blockquote>
<p align="left"><br><br>
</p>
<h3 class="cjk" style="page-break-before: always"><a name="__RefHeading__11611_71337508"></a>
<font face="DejaVu Serif, serif"><span lang="en-US">trace</span></font>状态变量</h3>
<p align="left">你可以使用和访问内存一样的命令访问<font face="DejaVu Serif, serif"><span lang="en-US">TSV</span></font>。
请到 <a href="#如何使用trace状态变量|outline">如何使用<font face="DejaVu Serif, serif"><span lang="en-US">trace</a></span></font><a href="#如何使用trace状态变量|outline">状态变量</a>
取得更多<font face="DejaVu Serif, serif"><span lang="en-US">TSV</span></font>的信息。</p>
<p align="left"><br><br>
</p>
<h2 class="cjk" style="page-break-before: always"><a name="__RefHeading__11613_71337508"></a><a name="GDB tracepoint|outline"></a><a name="GDB tracepoint|outline"></a>
<font face="DejaVu Serif, serif"><span lang="en-US">GDB tracepoint</span></font></h2>
<p align="left"><font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>就是<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>定义一些地址和一些动作。在<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>启动之后，当<font face="DejaVu Serif, serif"><span lang="en-US">Linux</span></font>内核执行到那些地址的时候，<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>将执行这些动作<font face="DejaVu Serif, serif"><span lang="en-US">(</span></font>它们中的有些会收集数据并存入<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>帧缓冲<font face="DejaVu Serif, serif"><span lang="en-US">)</span></font>并把它们发给调试目标<font face="DejaVu Serif, serif"><span lang="en-US">(KGTP)</span></font>。而后，<font face="DejaVu Serif, serif"><span lang="en-US">Linux</span></font>内核将继续执行。</p>
<p align="left"><font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>提供了一些接口可以让<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>或者其他程序取出<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>帧缓冲的数据做分析。</p>
<p align="left">关于这些接口，文档前面已经介绍了<font face="DejaVu Serif, serif"><span lang="en-US">&quot;/sys/kernel/debug/gtp&quot;</span></font>，将在后面介绍<font face="DejaVu Serif, serif"><span lang="en-US">&quot;/sys/kernel/debug/gtpframe&quot;
</span></font>和 <font face="DejaVu Serif, serif"><span lang="en-US">&quot;/sys/kernel/debug/gtpframe_pipe&quot;</span></font>。</p>
<p align="left"><br><br>
</p>
<p align="left"><font face="DejaVu Serif, serif"><span lang="en-US">GDB
tracepoint</span></font>文档在
<font face="DejaVu Serif, serif"><span lang="en-US"><a href="http://sourceware.org/gdb/current/onlinedocs/gdb/Tracepoints.html">http://sourceware.org/gdb/current/onlinedocs/gdb/Tracepoints.html</a></span></font>。</p>
<p align="left"><br><br>
</p>
<h3 class="cjk" style="page-break-before: always"><a name="__RefHeading__12707_71337508"></a>
设置<font face="DejaVu Serif, serif"><span lang="en-US">tracepint</span></font></h3>
<p align="left"><font face="DejaVu Serif, serif"><span lang="en-US">trace</span></font>命令非常类似<font face="DejaVu Serif, serif"><span lang="en-US">break</span></font>命令，它的参数可以是文件行，函数名或者一个地址。<font face="DejaVu Serif, serif"><span lang="en-US">trace</span></font>将定义一个或者多个地址定义一个<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>，<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>将在这个点做一些动作。</p>
<p align="left">这是一些使用<font face="DejaVu Serif, serif"><span lang="en-US">trace</span></font>命令的例子：</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
trace foo.c:121    // </i></span></font>一个文件和行号</blockquote>
<blockquote class="cjk"><br>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
trace +2           // 2</i></span></font>行以后</blockquote>
<blockquote class="cjk"><br>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
trace my_function  // </i></span></font>函数的第一行</blockquote>
<blockquote class="cjk"><br>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
trace *my_function // </i></span></font>函数的第一个地址</blockquote>
<blockquote class="cjk"><br>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
trace *0x2117c4    // </i></span></font>一个地址</blockquote>
<p align="left"><br><br>
</p>
<h4 class="cjk" style="page-break-before: always"><a name="__RefHeading__12709_71337508"></a>
这个函数确实存在但是设置<font face="DejaVu Sans, sans-serif"><span lang="en-US">tracepoint</span></font>到上面会失败如何处理</h4>
<p align="left"><font face="DejaVu Serif, serif"><span lang="en-US">GCC</span></font>为了提高程序执行效率会<font face="DejaVu Serif, serif"><span lang="en-US">inline</span></font>一些<font face="DejaVu Serif, serif"><span lang="en-US">static</span></font>函数。因为目标文件没有<font face="DejaVu Serif, serif"><span lang="en-US">inline</span></font>函数的符号，所以你不能设置<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>在函数名上。</p>
<p align="left">你可以用<font face="DejaVu Serif, serif"><span lang="en-US">&quot;trace
</span></font>文件<font face="DejaVu Serif, serif"><span lang="en-US">:</span></font>行号<font face="DejaVu Serif, serif"><span lang="en-US">&quot;</span></font>在其上设置断点。</p>
<p align="left"><br><br>
</p>
<h3 class="cjk" style="page-break-before: always"><a name="__RefHeading__12711_71337508"></a>
如何设置条件<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font></h3>
<p align="left"><font face="DejaVu Serif, serif"><span lang="en-US"><a href="http://sourceware.org/gdb/current/onlinedocs/gdb/Tracepoint-Conditions.html">http://sourceware.org/gdb/current/onlinedocs/gdb/Tracepoint-Conditions.html</a></span></font></p>
<p align="left">和<font face="DejaVu Serif, serif"><span lang="en-US">breakpoint</span></font>一样，我们可以设置<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>的触发条件。而且因为条件检查是在<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>执行的，所以速度比<font face="DejaVu Serif, serif"><span lang="en-US">breakpoint</span></font>的条件检查快很多。</p>
<p align="left">例如：</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
trace handle_irq if (irq == 47)</i></span></font></blockquote>
<p align="left"><font face="DejaVu Serif, serif"><span lang="en-US">tracepoint
1</span></font>的动作将只在<font face="DejaVu Serif, serif"><span lang="en-US">irq</span></font>是<font face="DejaVu Serif, serif"><span lang="en-US">47</span></font>的时候才被执行。</p>
<p align="left"><br><br>
</p>
<p align="left">你还可以用<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>命令<font face="DejaVu Serif, serif"><span lang="en-US">&quot;condition&quot;</span></font>设置<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>的触发条件。<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>命令<font face="DejaVu Serif, serif"><span lang="en-US">&quot;condition
N COND&quot;</span></font>将设置<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint
N</span></font>只有条件<font face="DejaVu Serif, serif"><span lang="en-US">COND</span></font>为真的时候执行。</p>
<p align="left">例如：</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
trace handle_irq</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
condition 1 (irq == 47)</i></span></font></blockquote>
<p align="left"><font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>命令<font face="DejaVu Serif, serif"><span lang="en-US">&quot;info
tracepoint&quot;</span></font>将显示<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>的<font face="DejaVu Serif, serif"><span lang="en-US">ID</span></font>。</p>
<p align="left"><br><br>
</p>
<p align="left"><font face="DejaVu Serif, serif"><span lang="en-US">$bpnum</span></font>的值是最后一个<font face="DejaVu Serif, serif"><span lang="en-US">GDB
tracepoint</span></font>的<font face="DejaVu Serif, serif"><span lang="en-US">ID</span></font>，所以你可以不取得<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>的<font face="DejaVu Serif, serif"><span lang="en-US">ID</span></font>就用<font face="DejaVu Serif, serif"><span lang="en-US">condition</span></font>来设置最后设置的<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>的条件，例如：</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
trace handle_irq</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
condition $bpnum (irq == 47)</i></span></font></blockquote>
<blockquote class="cjk" style="margin-left: 0cm"><br>
</blockquote>
<h4 class="cjk" style="page-break-before: always"><a name="__RefHeading__12713_71337508"></a>
如何处理错误 <font face="DejaVu Sans, sans-serif"><span lang="en-US">&quot;Unsupported
operator (null) (52) in expression.&quot;</span></font></h4>
<p align="left">如果你使用关于字符串的条件<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>，你在调用<font face="DejaVu Serif, serif"><span lang="en-US">&quot;tstart&quot;</span></font>的时候可能得到这个出错信息。</p>
<p align="left">你可以转化<font face="DejaVu Serif, serif"><span lang="en-US">char</span></font>为<font face="DejaVu Serif, serif"><span lang="en-US">int</span></font>来处理这个问题，例如：</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
p/x 'A'</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>$4
= 0x41</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
condition 1 (buf[0] == 0x41)</i></span></font></blockquote>
<blockquote class="cjk" style="margin-left: 0cm"><br>
</blockquote>
<h3 class="cjk" style="page-break-before: always"><a name="__RefHeading__12715_71337508"></a>
<font face="DejaVu Serif, serif"><span lang="en-US">actions [num]</span></font></h3>
<p align="left">这个命令将设置一组<font face="DejaVu Serif, serif"><span lang="en-US">action</span></font>当<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint
num</span></font>触发的时候执行。如果没有设置<font face="DejaVu Serif, serif"><span lang="en-US">num</span></font>则将设置<font face="DejaVu Serif, serif"><span lang="en-US">action</span></font>到最近创建的<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>上<font face="DejaVu Serif, serif"><span lang="en-US">(</span></font>因此你可以定义一个<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>然后直接输入<font face="DejaVu Serif, serif"><span lang="en-US">actions</span></font>而不需要参数<font face="DejaVu Serif, serif"><span lang="en-US">)</span></font>。然后就要在后面输入<font face="DejaVu Serif, serif"><span lang="en-US">action</span></font>，最后以<font face="DejaVu Serif, serif"><span lang="en-US">end</span></font>为结束。到目前为止，支持的<font face="DejaVu Serif, serif"><span lang="en-US">action</span></font>有<font face="DejaVu Serif, serif"><span lang="en-US">collect</span></font>，<font face="DejaVu Serif, serif"><span lang="en-US">teval</span></font>和<font face="DejaVu Serif, serif"><span lang="en-US">while-stepping</
span></font>。</p>
<p align="left"><br><br>
</p>
<h4 class="cjk" style="page-break-before: always"><a name="__RefHeading__12717_71337508"></a><a name="collect expr1, expr2, ...|outline"></a><a name="collect expr1, expr2, ...|outline"></a>
<font face="DejaVu Sans, sans-serif"><span lang="en-US">collect
expr1, expr2, ...</span></font></h4>
<p align="left">当<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>触发的时候，收集表达式的值。这个命令可接受用逗号分割的一组列表，这些列表除了可以是全局，局部或者本地变量，还可以是下面的这些参数：</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>$regs
  </i></span></font>收集全部寄存器。</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>$args
  </i></span></font>收集函数参数。</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>$locals
</i></span></font>收集全部局部变量。</blockquote>
<p align="left">请 <b>注意</b> <font face="DejaVu Serif, serif"><span lang="en-US">collect
</span></font>一个指针<font face="DejaVu Serif, serif"><span lang="en-US">(collect
ptr)</span></font>将只能<font face="DejaVu Serif, serif"><span lang="en-US">collect</span></font>这个指针的地址<font face="DejaVu Serif, serif"><span lang="en-US">.
</span></font>在指针前面增加一个 <font face="DejaVu Serif, serif"><span lang="en-US">*
</span></font>将会让<font face="DejaVu Serif, serif"><span lang="en-US">action
collect</span></font>指针指向的数据<font face="DejaVu Serif, serif"><span lang="en-US">(collect
*ptr)</span></font>。</p>
<p align="left"><br><br>
</p>
<h4 class="cjk" style="page-break-before: always"><a name="__RefHeading__12719_71337508"></a><a name="teval expr1, expr2, ...|outline"></a>
<font face="DejaVu Sans, sans-serif"><span lang="en-US">teval expr1,
expr2, ...</span></font></h4>
<p align="left">当<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>触发的时候，执行指定的表达式。这个命令可接受用逗号分割的一组列表。表达式的结果将被删除，所以最主要的作用是把值设置到<font face="DejaVu Serif, serif"><span lang="en-US">trace</span></font>状态变量中
<font face="DejaVu Serif, serif"><span lang="en-US">(see
</span></font><a href="#普通trace状态变量|outline">普通<font face="DejaVu Serif, serif"><span lang="en-US">trace</a></span></font><a href="#普通trace状态变量|outline">状态变量</a><font face="DejaVu Serif, serif"><span lang="en-US">)</span></font>，而不用想<font face="DejaVu Serif, serif"><span lang="en-US">collect</span></font>一样把这些值存到<font face="DejaVu Serif, serif"><span lang="en-US">trace</span></font>帧中。</p>
<p align="left"><br><br>
</p>
<h4 class="cjk" style="page-break-before: always"><a name="__RefHeading__12721_71337508"></a>
<font face="DejaVu Sans, sans-serif"><span lang="en-US">while-stepping
n</span></font></h4>
<p align="left">请到 <a href="#使用while-stepping让Linux内核做单步|outline">使用<font face="DejaVu Serif, serif"><span lang="en-US">while-stepping</a></span></font><a href="#使用while-stepping让Linux内核做单步|outline">让<font face="DejaVu Serif, serif"><span lang="en-US">Linux</a></span></font><a href="#使用while-stepping让Linux内核做单步|outline">内核做单步</a>
去看如何使用它。</p>
<p align="left"><br><br>
</p>
<h3 class="cjk" style="page-break-before: always"><a name="__RefHeading__12723_71337508"></a><a name="启动和停止 tracepoint|outline"></a>
启动和停止 <font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font></h3>
<p align="left"><font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>只有在用下面的<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>命令启动后才可以执行<font face="DejaVu Serif, serif"><span lang="en-US">action</span></font>：</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
tstart</i></span></font></blockquote>
<p align="left"><br><br>
</p>
<p align="left">它可以用下面的命令停止：</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
tstop</i></span></font></blockquote>
<p align="left"><br><br>
</p>
<h3 class="cjk" style="page-break-before: always"><a name="__RefHeading__12725_71337508"></a>
<font face="DejaVu Serif, serif"><span lang="en-US">Enable </span></font>和
<font face="DejaVu Serif, serif"><span lang="en-US">disable
tracepoint</span></font></h3>
<p align="left">和<font face="DejaVu Serif, serif"><span lang="en-US">breakpoint</span></font>一样，<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>可以使用<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>命令
<font face="DejaVu Serif, serif"><span lang="en-US">&quot;enable&quot;
</span></font>和 <font face="DejaVu Serif, serif"><span lang="en-US">&quot;disable&quot;</span></font>。但是请
<b>注意</b> 它们只在<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>停止的时候有效。</p>
<p align="left"><br><br>
</p>
<h3 class="cjk" style="page-break-before: always"><a name="__RefHeading__12727_71337508"></a><a name="用tfind选择trace帧缓存里面的条目|outline"></a><a name="用tfind选择trace帧缓存里面的条目|outline"></a>
用<font face="DejaVu Serif, serif"><span lang="en-US">tfind</span></font>选择<font face="DejaVu Serif, serif"><span lang="en-US">trace</span></font>帧缓存里面的条目</h3>
<p align="left"><font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>停止的时候，<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>命令<font face="DejaVu Serif, serif"><span lang="en-US">&quot;tfind&quot;</span></font>可以用来选择<font face="DejaVu Serif, serif"><span lang="en-US">trace</span></font>帧缓存里面的条目。</p>
<p align="left">当<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>在<font face="DejaVu Serif, serif"><span lang="en-US">&quot;tfind&quot;</span></font>模式的时候，其只能显示<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint
action
collect</span></font>的存在于这个条目中的数据。所以<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>将输出一些错误信息如果想打印没有<font face="DejaVu Serif, serif"><span lang="en-US">collect</span></font>的数据例如函数的参数。这不是<font face="DejaVu Serif, serif"><span lang="en-US">bug</span></font>，不用担心。</p>
<p align="left">如果想选择下一个条目，可以再次使用命令<font face="DejaVu Serif, serif"><span lang="en-US">&quot;tfind&quot;</span></font>。还可以用<font face="DejaVu Serif, serif"><span lang="en-US">&quot;tfind
</span></font>条目<font face="DejaVu Serif, serif"><span lang="en-US">ID&quot;</span></font>去选择某个条目。</p>
<p align="left">要回到普通模式<font face="DejaVu Serif, serif"><span lang="en-US">(</span></font><a href="#在普通模式直接访问当前值|outline">在普通模式直接访问当前值</a><font face="DejaVu Serif, serif"><span lang="en-US">)</span></font>，请使用<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>命令<font face="DejaVu Serif, serif"><span lang="en-US">&quot;tfind
-1&quot;</span></font>。 请到
<font face="DejaVu Serif, serif"><span lang="en-US"><a href="http://sourceware.org/gdb/current/onlinedocs/gdb/tfind.html">http://sourceware.org/gdb/current/onlinedocs/gdb/tfind.html</a>
</span></font>取得它的详细信息。</p>
<p align="left"><br><br>
</p>
<h4 class="cjk" style="page-break-before: always"><a name="__RefHeading__12729_71337508"></a>
如何处理错误 <font face="DejaVu Sans, sans-serif"><span lang="en-US">&quot;No
such file or directory.&quot; </span></font>或者 <font face="DejaVu Sans, sans-serif"><span lang="en-US">&quot;</span></font>没有那个文件或目录<font face="DejaVu Sans, sans-serif"><span lang="en-US">.&quot;</span></font></h4>
<p align="left">当<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>不能找到<font face="DejaVu Serif, serif"><span lang="en-US">Linux</span></font>内核源码的时候，其就会显示这个错误信息。
例如：</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
tfind </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Found
trace frame 0, tracepoint 1</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#0
 vfs_read (file=0xffff8801b6c3a500, buf=0x3f588b8 &lt;Address
0x3f588b8 out of bounds&gt;, count=8192, </i></span></font>
</blockquote>
<blockquote class="cjk">    <font face="DejaVu Serif, serif"><span lang="en-US"><i>pos=0xffff8801eee49f48)
at /build/buildd/linux-3.2.0/fs/read_write.c:365</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>365
    /build/buildd/linux-3.2.0/fs/read_write.c: </i></span></font>没有那个文件或目录<font face="DejaVu Serif, serif"><span lang="en-US"><i>.</i></span></font></blockquote>
<blockquote class="cjk" style="margin-left: 0cm"><br>
</blockquote>
<p align="left">你可以用<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>命令
<font face="DejaVu Serif, serif"><span lang="en-US">&quot;set
substitute-path&quot;
</span></font>处理它。前面这个例子<font face="DejaVu Serif, serif"><span lang="en-US">Linux</span></font>内核源码在<font face="DejaVu Serif, serif"><span lang="en-US">&quot;/build/buildd/test/linux-3.2.0/&quot;</span></font>但是<font face="DejaVu Serif, serif"><span lang="en-US">vmlinux</span></font>让<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>在<font face="DejaVu Serif, serif"><span lang="en-US">&quot;/build/buildd/linux-3.2.0/&quot;</span></font>找内核远啊，你可以处理他们：</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
set substitute-path /build/buildd/linux-3.2.0/
/build/buildd/test/linux-3.2.0/</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
tfind </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Found
trace frame 1, tracepoint 1</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#0
 vfs_read (file=0xffff8801c36e6400, buf=0x7fff51a8f110 &lt;Address
0x7fff51a8f110 out of bounds&gt;, count=16, </i></span></font>
</blockquote>
<blockquote class="cjk">    <font face="DejaVu Serif, serif"><span lang="en-US"><i>pos=0xffff8801761dff48)
at /build/buildd/linux-3.2.0/fs/read_write.c:365</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>365
    {</i></span></font></blockquote>
<p align="left"><font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>还提供其他的命令处理源码问题，请到<font face="DejaVu Serif, serif"><span lang="en-US"><a href="http://sourceware.org/gdb/current/onlinedocs/gdb/Source-Path.html">http://sourceware.org/gdb/current/onlinedocs/gdb/Source-Path.html</a></span></font>取得他们的介绍。</p>
<p align="left"><br><br>
</p>
<h3 class="cjk" style="page-break-before: always"><a name="__RefHeading__12731_71337508"></a>
保存<font face="DejaVu Serif, serif"><span lang="en-US">trace</span></font>帧信息到一个文件中</h3>
<p align="left"><font face="DejaVu Serif, serif"><span lang="en-US">/sys/kernel/debug/gtpframe</span></font>是一个当<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>停止时的<font face="DejaVu Serif, serif"><span lang="en-US">tfine</span></font>格式（<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>可以读取它）的接口。</p>
<p align="left">请 <b>注意</b> 有些<font face="DejaVu Serif, serif"><span lang="en-US">&quot;cp&quot;</span></font>不能很好的处理这个问题，可以用<font face="DejaVu Serif, serif"><span lang="en-US">&quot;cat
/sys/kernel/debug/gtpframe &gt; ./gtpframe&quot;</span></font>拷贝它。</p>
<p align="left">你可以在需要的时候打开文件<font face="DejaVu Serif, serif"><span lang="en-US">gtpframe:</span></font></p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
target tfile ./gtpframe</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Tracepoint
1 at 0xffffffff8114f3dc: file
/home/teawater/kernel/linux-2.6/fs/readdir.c, line 24.</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Created
tracepoint 1 for target's tracepoint 1 at 0xffffffff8114f3c0.</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
tfind </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Found
trace frame 0, tracepoint 1</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#0
 vfs_readdir (file=0xffff880036e8f300, filler=0xffffffff8114f240
&lt;filldir&gt;, buf=0xffff880001e5bf38)</i></span></font></blockquote>
<blockquote class="cjk">    <font face="DejaVu Serif, serif"><span lang="en-US"><i>at
/home/teawater/kernel/linux-2.6/fs/readdir.c:24</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>24
     {</i></span></font></blockquote>
<h3 class="cjk"><br><br>
</h3>
<h3 class="cjk" style="page-break-before: always"><a name="__RefHeading__12733_71337508"></a>
显示和存储<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font></h3>
<p align="left">你可以用<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>命令<font face="DejaVu Serif, serif"><span lang="en-US">&quot;info
tracepoints&quot;</span></font>显示所有的<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>。</p>
<p align="left">你可以用<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>命令<font face="DejaVu Serif, serif"><span lang="en-US">&quot;save
tracepoints
filename&quot;</span></font>保存所有的设置<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>的命令到文件<font face="DejaVu Serif, serif"><span lang="en-US">filename</span></font>里。于是你可以在之后用<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>命令<font face="DejaVu Serif, serif"><span lang="en-US">&quot;source
filename&quot;</span></font>设置重新这些<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>。</p>
<p align="left"><br><br>
</p>
<h3 class="cjk" style="page-break-before: always"><a name="__RefHeading__12735_71337508"></a>
删除<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font></h3>
<p align="left"><font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>命令<font face="DejaVu Serif, serif"><span lang="en-US">&quot;delete
id&quot;</span></font>将删除<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint
id</span></font>。如果<font face="DejaVu Serif, serif"><span lang="en-US">&quot;delete&quot;</span></font>没有参数，则删除所有<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>。</p>
<p align="left"><br><br>
</p>
<h3 class="cjk" style="page-break-before: always"><a name="__RefHeading__12737_71337508"></a>
用<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>从内核中某点取得寄存器信息</h3>
<p align="left">下面是记录内核调用函数<font face="DejaVu Serif, serif"><span lang="en-US">&quot;vfs_readdir&quot;</span></font>时的寄存器信息的例子：</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
target remote /sys/kernel/debug/gtp</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
trace vfs_readdir</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Tracepoint
1 at 0xc01a1ac0: file</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>/home/teawater/kernel/linux-2.6/fs/readdir.c,
line 23.</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
actions</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Enter
actions for tracepoint 1, one per line.</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>End
with a line saying just &quot;end&quot;.</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;collect
$reg</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;end</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
tstart</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
shell ls</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
tstop</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
tfind</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Found
trace frame 0, tracepoint 1</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#0
 0xc01a1ac1 in vfs_readdir (file=0xc5528d00, filler=0xc01a1900
&lt;filldir64&gt;,</i></span></font></blockquote>
<blockquote class="cjk">   <font face="DejaVu Serif, serif"><span lang="en-US"><i>buf=0xc0d09f90)
at /home/teawater/kernel/linux-2.6/fs/readdir.c:23</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>23
     /home/teawater/kernel/linux-2.6/fs/readdir.c: No such file or
directory.</i></span></font></blockquote>
<blockquote class="cjk">       <font face="DejaVu Serif, serif"><span lang="en-US"><i>in
/home/teawater/kernel/linux-2.6/fs/readdir.c</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
info reg</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>eax
           0xc5528d00       -984445696</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>ecx
           0xc0d09f90       -1060069488</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>edx
           0xc01a1900       -1072031488</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>ebx
           0xfffffff7       -9</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>esp
           0xc0d09f8c       0xc0d09f8c</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>ebp
           0x0      0x0</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>esi
           0x8061480        134616192</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>edi
           0xc5528d00       -984445696</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>eip
           0xc01a1ac1       0xc01a1ac1 &lt;vfs_readdir+1&gt;</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>eflags
        0x286    [ PF SF IF ]</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>cs
            0x60     96</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>ss
            0x8061480        134616192</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>ds
            0x7b     123</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>es
            0x7b     123</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>fs
            0x0      0</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>gs
            0x0      0</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
tfind</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Found
trace frame 1, tracepoint 1</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>0xc01a1ac1
     23      in /home/teawater/kernel/linux-2.6/fs/readdir.c</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
info reg</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>eax
           0xc5528d00       -984445696</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>ecx
           0xc0d09f90       -1060069488</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>edx
           0xc01a1900       -1072031488</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>ebx
           0xfffffff7       -9</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>esp
           0xc0d09f8c       0xc0d09f8c</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>ebp
           0x0      0x0</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>esi
           0x8061480        134616192</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>edi
           0xc5528d00       -984445696</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>eip
           0xc01a1ac1       0xc01a1ac1 &lt;vfs_readdir+1&gt;</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>eflags
        0x286    [ PF SF IF ]</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>cs
            0x60     96</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>ss
            0x8061480        134616192</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>ds
            0x7b     123</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>es
            0x7b     123</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>fs
            0x0      0</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>gs
            0x0      0</i></span></font></blockquote>
<blockquote class="cjk" style="margin-left: 0cm"><br>
</blockquote>
<h3 class="cjk" style="page-break-before: always"><a name="__RefHeading__12739_71337508"></a>
用<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>从内核中某点取得变量的值</h3>
<p align="left">下面是记录内核调用函数<font face="DejaVu Serif, serif"><span lang="en-US">&quot;vfs_readdir&quot;</span></font>时<font face="DejaVu Serif, serif"><span lang="en-US">&quot;jiffies_64&quot;</span></font>的值的例子：</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
target remote /sys/kernel/debug/gtp</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
trace vfs_readdir </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Tracepoint
1 at 0xc01ed740: file /home/teawater/kernel/linux-2.6/fs/readdir.c,
line 24.</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
actions </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Enter
actions for tracepoint 1, one per line.</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>End
with a line saying just &quot;end&quot;.</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;collect
jiffies_64</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;collect
file-&gt;f_path.dentry-&gt;d_iname</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;end</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
tstart </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
shell ls</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>arch
   drivers   include  kernel    mm               Module.symvers 
security  System.map  virt</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>block
  firmware  init     lib       modules.builtin  net             sound
    t           vmlinux</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>crypto
 fs        ipc      Makefile  modules.order    scripts         source
   usr         vmlinux.o</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
tstop </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
tfind </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Found
trace frame 0, tracepoint 1</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#0
 0xc01ed741 in vfs_readdir (file=0xf4063000, filler=0xc01ed580
&lt;filldir64&gt;, buf=0xd6dfdf90)</i></span></font></blockquote>
<blockquote class="cjk">    <font face="DejaVu Serif, serif"><span lang="en-US"><i>at
/home/teawater/kernel/linux-2.6/fs/readdir.c:24</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>24
     {</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
p jiffies_64</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>$1
= 4297248706</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
p file-&gt;f_path.dentry-&gt;d_iname</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>$1
= &quot;b26&quot;, '\000' &lt;repeats 28 times&gt;</i></span></font></blockquote>
<blockquote class="cjk" style="margin-left: 0cm"><br>
</blockquote>
<h3 class="cjk" style="page-break-before: always"><a name="__RefHeading__12741_71337508"></a>
显示当前这一条<font face="DejaVu Serif, serif"><span lang="en-US">trace</span></font>缓存里存储的所有信息</h3>
<p align="left">在用<font face="DejaVu Serif, serif"><span lang="en-US">&quot;tfind&quot;</span></font>选择好一个条目后，你可以用<font face="DejaVu Serif, serif"><span lang="en-US">&quot;tdump&quot;</span></font>。</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
tdump </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Data
collected at tracepoint 1, trace frame 0:</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>$cr
= void</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>file-&gt;f_path.dentry-&gt;d_iname
=
&quot;gtp\000.google.chrome.g05ZYO\000\235\337\000\000\000\000\200\067k\364\200\067&quot;,
&lt;incomplete sequence \364&gt;</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>jiffies_64
= 4319751455</i></span></font></blockquote>
<blockquote class="cjk" style="margin-left: 0cm"><br>
</blockquote>
<h3 class="cjk" style="page-break-before: always"><a name="__RefHeading__12743_71337508"></a>
取得 <font face="DejaVu Serif, serif"><span lang="en-US">tracepoint
</span></font>的状态</h3>
<p align="left">请用<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>命令<font face="DejaVu Serif, serif"><span lang="en-US">&quot;tstatus&quot;</span></font>。</p>
<p align="left"><br><br>
</p>
<h3 class="cjk" style="page-break-before: always"><a name="__RefHeading__12745_71337508"></a>
设置<font face="DejaVu Serif, serif"><span lang="en-US">trace</span></font>缓存为循环缓存</h3>
<p align="left"><font face="DejaVu Serif, serif"><span lang="en-US"><a href="http://sourceware.org/gdb/current/onlinedocs/gdb/Starting-and-Stopping-Trace-Experiments.html">http://sourceware.org/gdb/current/onlinedocs/gdb/Starting-and-Stopping-Trace-Experiments.html</a></span></font></p>
<p align="left">帧缓存默认情况下不是循环缓存。当缓存满了的时候，<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>将停止。</p>
<p align="left">下面的命令将设置<font face="DejaVu Serif, serif"><span lang="en-US">trace</span></font>缓存为循环缓存，当缓存满了的时候，其将自动删除最早的数据并继续<font face="DejaVu Serif, serif"><span lang="en-US">trace</span></font>。</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
set circular-trace-buffer on</i></span></font></blockquote>
<p align="left"><br><br>
</p>
<h3 class="cjk" style="page-break-before: always"><a name="__RefHeading__12747_71337508"></a><a name="GDB断开的时候不要停止tracepoint|outline"></a>
<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>断开的时候不要停止<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font></h3>
<p align="left"><font face="DejaVu Serif, serif"><span lang="en-US"><a href="http://sourceware.org/gdb/current/onlinedocs/gdb/Starting-and-Stopping-Trace-Experiments.html">http://sourceware.org/gdb/current/onlinedocs/gdb/Starting-and-Stopping-Trace-Experiments.html</a></span></font></p>
<p align="left">默认情况下，当<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>断开<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>的时候将自动停止<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>并删除<font face="DejaVu Serif, serif"><span lang="en-US">trace</span></font>帧。</p>
<p align="left">下面的命令将打开<font face="DejaVu Serif, serif"><span lang="en-US">KGTP
disconnect-trace</span></font>。在设置之后，当<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>断开<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>的时候，<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>将不停止<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>。<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>重新连到<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>的时候，其可以继续控制<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>。</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
set disconnected-tracing on</i></span></font></blockquote>
<p align="left"><br><br>
</p>
<h3 class="cjk" style="page-break-before: always"><a name="__RefHeading__12749_71337508"></a>
<font face="DejaVu Serif, serif"><span lang="en-US">kprobes-optimization</span></font>和<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>的执行速度</h3>
<p align="left">因为<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>是和<font face="DejaVu Serif, serif"><span lang="en-US">Linux</span></font>内核一起执行，所以它的速度将影响到系统执行的速度。</p>
<p align="left"><font face="DejaVu Serif, serif"><span lang="en-US">KGTP
tracepoint</span></font>是基于<font face="DejaVu Serif, serif"><span lang="en-US">Linux</span></font>内核<font face="DejaVu Serif, serif"><span lang="en-US">kprobe</span></font>。因为普通<font face="DejaVu Serif, serif"><span lang="en-US">kprobe</span></font>是基于断点指令，所以它的速度不是很快。</p>
<p align="left"><br><br>
</p>
<p align="left">但是如果你的<font face="DejaVu Serif, serif"><span lang="en-US">arch</span></font>是<font face="DejaVu Serif, serif"><span lang="en-US">X86_64
</span></font>或者 <font face="DejaVu Serif, serif"><span lang="en-US">X86_32
</span></font>而且内核配置没有打开<font face="DejaVu Serif, serif"><span lang="en-US">&quot;Preemptible
Kernel&quot; (PREEMPT)</span></font>，<font face="DejaVu Serif, serif"><span lang="en-US">kprobe</span></font>的速度将被<font face="DejaVu Serif, serif"><span lang="en-US">kprobes-optimization
(CONFIG_OPTPROBES)</span></font>提高很多。</p>
<p align="left">可以用下面的命令来确认：</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>sysctl
-A | grep kprobe</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>debug.kprobes-optimization
= 1</i></span></font></blockquote>
<p align="left">这个的意思就是你的系统支持<font face="DejaVu Serif, serif"><span lang="en-US">kprobes-optimization</span></font>。</p>
<p align="left">请 <b>注意</b>
一些<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>的功能会导致<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>只能使用普通<font face="DejaVu Serif, serif"><span lang="en-US">kprobe</span></font>即使系统支持<font face="DejaVu Serif, serif"><span lang="en-US">kprobes-optimization</span></font>。文档将在介绍这些功能的时候增加提醒，如果你很介意<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>的速度就请避免使用这些功能。</p>
<p align="left"><br><br>
</p>
<h2 class="cjk" style="page-break-before: always"><a name="__RefHeading__12751_71337508"></a><a name="如何使用trace状态变量|outline"></a>
如何使用<font face="DejaVu Serif, serif"><span lang="en-US">trace</span></font>状态变量</h2>
<p align="left"><font face="DejaVu Serif, serif"><span lang="en-US"><a href="http://sourceware.org/gdb/current/onlinedocs/gdb/Trace-State-Variables.html">http://sourceware.org/gdb/current/onlinedocs/gdb/Trace-State-Variables.html</a></span></font></p>
<p align="left"><font face="DejaVu Serif, serif"><span lang="en-US">trace</span></font>状态变量简称<font face="DejaVu Serif, serif"><span lang="en-US">TSV</span></font>。</p>
<p align="left"><font face="DejaVu Serif, serif"><span lang="en-US">TSV</span></font>可以在<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint
action</span></font>和<font face="DejaVu Serif, serif"><span lang="en-US">condition</span></font>中被访问，并且可以直接被<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>命令访问。</p>
<p align="left">请 <b>注意</b> <font face="DejaVu Serif, serif"><span lang="en-US">GDB
7.2.1</span></font>和更晚的版本直接访问<font face="DejaVu Serif, serif"><span lang="en-US">trace</span></font>状态变量，比他们老的<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>只能通过命令<font face="DejaVu Serif, serif"><span lang="en-US">&quot;info
tvariables&quot;</span></font>取得<font face="DejaVu Serif, serif"><span lang="en-US">trace</span></font>状态变量的值。</p>
<p align="left"><br><br>
</p>
<h3 class="cjk" style="page-break-before: always"><a name="__RefHeading__12753_71337508"></a><a name="普通trace状态变量|outline"></a>
普通<font face="DejaVu Serif, serif"><span lang="en-US">trace</span></font>状态变量</h3>
<p align="left">定义<font face="DejaVu Serif, serif"><span lang="en-US">trace</span></font>状态变量<font face="DejaVu Serif, serif"><span lang="en-US">$c.</span></font></p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
tvariable $c</i></span></font></blockquote>
<p align="left"><br><br>
</p>
<p align="left"><font face="DejaVu Serif, serif"><span lang="en-US">trace</span></font>状态变量
<font face="DejaVu Serif, serif"><span lang="en-US">$c </span></font>被创建并初始化<font face="DejaVu Serif, serif"><span lang="en-US">0</span></font>。
下面的<font face="DejaVu Serif, serif"><span lang="en-US">action</span></font>将使用<font face="DejaVu Serif, serif"><span lang="en-US">$c</span></font>记录内核里发生了多少次<font face="DejaVu Serif, serif"><span lang="en-US">IRQ</span></font>。</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
target remote /sys/kernel/debug/gtp</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
trace handle_irq</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
actions </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Enter
actions for tracepoint 3, one per line.</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>End
with a line saying just &quot;end&quot;.</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;collect
$c     #Save current value of $c to the trace frame buffer.</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;teval
$c=$c+1  #Increase the $c.</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;end</i></span></font></blockquote>
<blockquote class="cjk" style="margin-left: 0cm"><br>
</blockquote>
<p align="left">你还可以将某个变量的值传到状态变量里，但是别忘记转化这个值为<font face="DejaVu Serif, serif"><span lang="en-US">&quot;uint64_t&quot;</span></font>。</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;teval
$c=(uint64_t)a</i></span></font></blockquote>
<p align="left"><br><br>
</p>
<p align="left">你可以取得<font face="DejaVu Serif, serif"><span lang="en-US">$c</span></font>的值当<font face="DejaVu Serif, serif"><span lang="en-US">trace</span></font>在运行或者停止的时候。</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
tstart</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
info tvariables</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>$c
             0           31554</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
p $c</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>$5
= 33652</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
tstop</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
p $c</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>$9
= 105559</i></span></font></blockquote>
<p align="left"><br><br>
</p>
<p align="left">当使用<font face="DejaVu Serif, serif"><span lang="en-US">tfind</span></font>的时候，你可以分析<font face="DejaVu Serif, serif"><span lang="en-US">trace
frame buffer</span></font>。如果<font face="DejaVu Serif, serif"><span lang="en-US">trace</span></font>状态变量被收集了，你可以把它取出来。</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
tstop </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
tfind </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
info tvariables</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>$c
             0           0</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
p $c</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>$6
= 0</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
tfind 100</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
p $c</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>$7
= 100</i></span></font></blockquote>
<blockquote class="cjk" style="margin-left: 0cm"><br>
</blockquote>
<p align="left">如果需要的时候，访问<font face="DejaVu Serif, serif"><span lang="en-US">trace</span></font>状态变量的<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint
action</span></font>将自动加锁，所以其可以很好的处理<font face="DejaVu Serif, serif"><span lang="en-US">trace</span></font>状态变量的竞态条件问题。</p>
<p align="left">下面这个例子即使在一个多<font face="DejaVu Serif, serif"><span lang="en-US">CPU</span></font>的环境也可以正常使用。</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;teval
$c=$c+1</i></span></font></blockquote>
<blockquote class="cjk" style="margin-left: 0cm"><br>
</blockquote>
<h3 class="cjk" style="page-break-before: always"><a name="__RefHeading__12755_71337508"></a><a name="Per_cpu trace状态变量|outline"></a>
<font face="DejaVu Serif, serif"><span lang="en-US">Per_cpu trace</span></font>状态变量</h3>
<p align="left"><font face="DejaVu Serif, serif"><span lang="en-US">Per_cpu
trace</span></font>状态变量是一种特殊的普通<font face="DejaVu Serif, serif"><span lang="en-US">trace</span></font>状态变量。
当一个<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint
action</span></font>访问到其的时候，其将自动访问这个<font face="DejaVu Serif, serif"><span lang="en-US">CPU</span></font>的<font face="DejaVu Serif, serif"><span lang="en-US">Per_cpu
trace</span></font>状态变量。</p>
<p align="left">它有两个优点：</p>
<p align="left"><font face="DejaVu Serif, serif"><span lang="en-US">1.
</span></font>访问<font face="DejaVu Serif, serif"><span lang="en-US">Per_cpu
trace</span></font>状态变量的<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint
actions</span></font>不存在竞态条件问题，所以其不需要对<font face="DejaVu Serif, serif"><span lang="en-US">trace</span></font>状态变量加锁。所以其在多核的机器上速度更快。
</p>
<p align="left"><font face="DejaVu Serif, serif"><span lang="en-US">2.
</span></font>写针对记录某个<font face="DejaVu Serif, serif"><span lang="en-US">CPU</span></font>的<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint
actions</span></font>比普通<font face="DejaVu Serif, serif"><span lang="en-US">trace</span></font>状态变量更容易。</p>
<p align="left"><br><br>
</p>
<h4 class="cjk" style="page-break-before: always"><a name="__RefHeading__13574_71337508"></a>
如何定义</h4>
<p align="left"><font face="DejaVu Serif, serif"><span lang="en-US">Per_cpu
trace</span></font>状态变量有两种类型：</p>
<h5 class="cjk"><a name="__RefHeading__13576_71337508"></a>本地<font face="DejaVu Sans, sans-serif"><span lang="en-US">CPU</span></font>变量</h5>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&quot;per_cpu_&quot;+string</i></span></font></blockquote>
<p align="left">或者</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&quot;p_&quot;+string</i></span></font></blockquote>
<p align="left">例如：</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
tvariable $p_count</i></span></font></blockquote>
<p align="left">在<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint
action</span></font>中访问这个<font face="DejaVu Serif, serif"><span lang="en-US">trace</span></font>状态变量的时候，其将返回这个变量在这个<font face="DejaVu Serif, serif"><span lang="en-US">action</span></font>运行的<font face="DejaVu Serif, serif"><span lang="en-US">CPU</span></font>上的值。</p>
<h5 class="cjk"><a name="__RefHeading__13578_71337508"></a><font face="DejaVu Sans, sans-serif"><span lang="en-US">CPU
id</span></font>变量</h5>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&quot;per_cpu_&quot;+string+CPU_id</i></span></font></blockquote>
<p align="left">或者</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&quot;p_&quot;+string+CPU_id</i></span></font></blockquote>
<p align="left">例如：</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
tvariable $p_count0</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
tvariable $p_count1</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
tvariable $p_count2</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
tvariable $p_count3</i></span></font></blockquote>
<p align="left">在<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint
action</span></font>或者<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>命令行中访问这个变量的时候，其将返回这个变量在<font face="DejaVu Serif, serif"><span lang="en-US">CPU
CPI_id </span></font>上的值。 
</p>
<p align="left">下面这个例子可以自动这个这台主机上的每个<font face="DejaVu Serif, serif"><span lang="en-US">CPU</span></font>定义<font face="DejaVu Serif, serif"><span lang="en-US">CPU
id</span></font>变量。<font face="DejaVu Serif, serif"><span lang="en-US">(</span></font>请
注意 用这些命令之前需要让<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>连上<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>。<font face="DejaVu Serif, serif"><span lang="en-US">)</span></font></p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
set $tmp=0</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
while $tmp&lt;$cpu_number</i></span></font></blockquote>
<blockquote class="cjk"> <font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;eval
&quot;tvariable $p_count%d&quot;,$tmp</i></span></font></blockquote>
<blockquote class="cjk"> <font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;set
$tmp=$tmp+1</i></span></font></blockquote>
<blockquote class="cjk"> <font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;end</i></span></font></blockquote>
<blockquote class="cjk" style="margin-left: 0cm"><br>
</blockquote>
<h4 class="cjk" style="page-break-before: always"><a name="__RefHeading__13580_71337508"></a>
例子<font face="DejaVu Sans, sans-serif"><span lang="en-US">1</span></font></h4>
<p align="left">这个例子定义了一个记录每个<font face="DejaVu Serif, serif"><span lang="en-US">CPU</span></font>调用多少次<font face="DejaVu Serif, serif"><span lang="en-US">vfs_read</span></font>的<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>。</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>tvariable
$p_count</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>set
$tmp=0</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>while
$tmp&lt;$cpu_number</i></span></font></blockquote>
<blockquote class="cjk">  <font face="DejaVu Serif, serif"><span lang="en-US"><i>eval
&quot;tvariable $p_count%d&quot;,$tmp</i></span></font></blockquote>
<blockquote class="cjk">  <font face="DejaVu Serif, serif"><span lang="en-US"><i>set
$tmp=$tmp+1</i></span></font></blockquote>
<blockquote class="cjk">  <font face="DejaVu Serif, serif"><span lang="en-US"><i>end</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>trace
vfs_read</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>actions</i></span></font></blockquote>
<blockquote class="cjk">  <font face="DejaVu Serif, serif"><span lang="en-US"><i>teval
$p_count=$p_count+1</i></span></font></blockquote>
<blockquote class="cjk">  <font face="DejaVu Serif, serif"><span lang="en-US"><i>end</i></span></font></blockquote>
<blockquote class="cjk" style="margin-left: 0cm"><br>
</blockquote>
<p align="left">于是你可以在<font face="DejaVu Serif, serif"><span lang="en-US">&quot;tstart&quot;</span></font>后显示每个<font face="DejaVu Serif, serif"><span lang="en-US">CPU</span></font>调用了多少次<font face="DejaVu Serif, serif"><span lang="en-US">vfs_read</span></font>：</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
p $p_count0</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>$3
= 44802</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
p $p_count1</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>$4
= 55272</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
p $p_count2</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>$5
= 102085</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
p $p_count3</i></span></font></blockquote>
<blockquote class="cjk" style="margin-left: 0cm"><br>
</blockquote>
<h4 class="cjk" style="page-break-before: always"><a name="__RefHeading__13582_71337508"></a>
例子<font face="DejaVu Sans, sans-serif"><span lang="en-US">2</span></font></h4>
<p align="left">这个例子记录了每个<font face="DejaVu Serif, serif"><span lang="en-US">CPU</span></font>上关闭<font face="DejaVu Serif, serif"><span lang="en-US">IRQ</span></font>时间最长的函数的<font face="DejaVu Serif, serif"><span lang="en-US">stack
dump</span></font>。</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>set
pagination off</i></span></font></blockquote>
<blockquote class="cjk"><br>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>tvariable
$bt=1024</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>tvariable
$p_count</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>tvariable
$p_cc</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>set
$tmp=0</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>while
$tmp&lt;$cpu_number</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>eval
&quot;tvariable $p_cc%d&quot;,$tmp</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>set
$tmp=$tmp+1</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>end</i></span></font></blockquote>
<blockquote class="cjk"><br>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>tvariable
$ignore_error=1</i></span></font></blockquote>
<blockquote class="cjk"><br>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>trace
arch_local_irq_disable</i></span></font></blockquote>
<blockquote class="cjk">  <font face="DejaVu Serif, serif"><span lang="en-US"><i>commands</i></span></font></blockquote>
<blockquote class="cjk">    <font face="DejaVu Serif, serif"><span lang="en-US"><i>teval
$p_count=$clock</i></span></font></blockquote>
<blockquote class="cjk">  <font face="DejaVu Serif, serif"><span lang="en-US"><i>end</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>trace
arch_local_irq_enable if ($p_count &amp;&amp; $p_cc &lt; $clock -
$p_count)</i></span></font></blockquote>
<blockquote class="cjk">  <font face="DejaVu Serif, serif"><span lang="en-US"><i>commands</i></span></font></blockquote>
<blockquote class="cjk">    <font face="DejaVu Serif, serif"><span lang="en-US"><i>teval
$p_cc = $clock - $p_count</i></span></font></blockquote>
<blockquote class="cjk">    <font face="DejaVu Serif, serif"><span lang="en-US"><i>collect
$bt</i></span></font></blockquote>
<blockquote class="cjk">    <font face="DejaVu Serif, serif"><span lang="en-US"><i>collect
$p_cc</i></span></font></blockquote>
<blockquote class="cjk">    <font face="DejaVu Serif, serif"><span lang="en-US"><i>teval
$p_count=0</i></span></font></blockquote>
<blockquote class="cjk">  <font face="DejaVu Serif, serif"><span lang="en-US"><i>end</i></span></font></blockquote>
<blockquote class="cjk"><br>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>enable</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>set
pagination on</i></span></font></blockquote>
<blockquote class="cjk" style="margin-left: 0cm"><br>
</blockquote>
<h3 class="cjk" style="page-break-before: always"><a name="__RefHeading__13584_71337508"></a>
特殊<font face="DejaVu Serif, serif"><span lang="en-US">trace</span></font>状态变量
<font face="DejaVu Serif, serif"><span lang="en-US">$current_task</span></font>，<font face="DejaVu Serif, serif"><span lang="en-US">$current_task_pid</span></font>，<font face="DejaVu Serif, serif"><span lang="en-US">$current_thread_info</span></font>，<font face="DejaVu Serif, serif"><span lang="en-US">$cpu_id</span></font>，<font face="DejaVu Serif, serif"><span lang="en-US">$dump_stack</span></font>，<font face="DejaVu Serif, serif"><span lang="en-US">$printk_level</span></font>，<font face="DejaVu Serif, serif"><span lang="en-US">$printk_format</span></font>，<font face="DejaVu Serif, serif"><span lang="en-US">$printk_tmp</span></font>，<font face="DejaVu Serif, serif"><span lang="en-US">$clock</span></font>，<font face="DejaVu Serif, serif"><span lang="en-US">$hardirq_count</span></font>，<font face="DejaVu Serif, serif"><span lang="en-US">$softirq_count
</span></font>和 <font face="DejaVu Serif, serif"><span lang="en-US">$irq_count</span></font></h3>
<p align="left"><font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>特殊<font face="DejaVu Serif, serif"><span lang="en-US">trace</span></font>状态变量<font face="DejaVu Serif, serif"><span lang="en-US">$current_task</span></font>，<font face="DejaVu Serif, serif"><span lang="en-US">$current_thread_info</span></font>，<font face="DejaVu Serif, serif"><span lang="en-US">$cpu_id
</span></font>和 <font face="DejaVu Serif, serif"><span lang="en-US">$clock</span></font>可以很容易的访问各种特殊的值，当你用<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>连到<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>后就可以访问到他们。
你可以在<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>条件和<font face="DejaVu Serif, serif"><span lang="en-US">actions</span></font>里使用他们。</p>
<p align="left">在<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>条件和<font face="DejaVu Serif, serif"><span lang="en-US">actions</span></font>里访问<font face="DejaVu Serif, serif"><span lang="en-US">$current_task</span></font>可以取得<font face="DejaVu Serif, serif"><span lang="en-US">get_current()</span></font>的返回值。</p>
<p align="left">在<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>条件和<font face="DejaVu Serif, serif"><span lang="en-US">actions</span></font>里访问<font face="DejaVu Serif, serif"><span lang="en-US">$current_task_pid</span></font>可以取得<font face="DejaVu Serif, serif"><span lang="en-US">get_current()-&gt;pid</span></font>的值。</p>
<p align="left">在<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>条件和<font face="DejaVu Serif, serif"><span lang="en-US">actions</span></font>里访问<font face="DejaVu Serif, serif"><span lang="en-US">$current_thread_info</span></font>可以取得<font face="DejaVu Serif, serif"><span lang="en-US">current_thread_info()</span></font>的返回值。</p>
<p align="left">在<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>条件和<font face="DejaVu Serif, serif"><span lang="en-US">actions</span></font>里访问<font face="DejaVu Serif, serif"><span lang="en-US">$cpu_id</span></font>可以取得<font face="DejaVu Serif, serif"><span lang="en-US">smp_processor_id()</span></font>的返回值。</p>
<p align="left">在<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>条件和<font face="DejaVu Serif, serif"><span lang="en-US">actions</span></font>里访问<font face="DejaVu Serif, serif"><span lang="en-US">$clock</span></font>可以取得<font face="DejaVu Serif, serif"><span lang="en-US">local_clock()</span></font>的返回值，也就是取得纳秒为单位的时间戳。</p>
<p align="left"><font face="DejaVu Serif, serif"><span lang="en-US">$rdtsc</span></font>只在体系结构是<font face="DejaVu Serif, serif"><span lang="en-US">X86</span></font>或者<font face="DejaVu Serif, serif"><span lang="en-US">X86_64</span></font>的时候访问的到，任何时候访问它可以取得用指令<font face="DejaVu Serif, serif"><span lang="en-US">RDTSC</span></font>取得的<font face="DejaVu Serif, serif"><span lang="en-US">TSC</span></font>的值。</p>
<p align="left">在<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>条件和<font face="DejaVu Serif, serif"><span lang="en-US">actions</span></font>里访问<font face="DejaVu Serif, serif"><span lang="en-US">$hardirq_count</span></font>可以取得<font face="DejaVu Serif, serif"><span lang="en-US">hardirq_count()</span></font>的返回值。</p>
<p align="left">在<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>条件和<font face="DejaVu Serif, serif"><span lang="en-US">actions</span></font>里访问<font face="DejaVu Serif, serif"><span lang="en-US">$softirq_count</span></font>可以取得<font face="DejaVu Serif, serif"><span lang="en-US">softirq_count()</span></font>的返回值。</p>
<p align="left">在<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>条件和<font face="DejaVu Serif, serif"><span lang="en-US">actions</span></font>里访问<font face="DejaVu Serif, serif"><span lang="en-US">$irq_count</span></font>可以取得<font face="DejaVu Serif, serif"><span lang="en-US">irq_count()</span></font>的返回值。</p>
<p align="left"><br><br>
</p>
<p align="left"><font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>还有一些特殊<font face="DejaVu Serif, serif"><span lang="en-US">trace</span></font>状态变量<font face="DejaVu Serif, serif"><span lang="en-US">$dump_stack</span></font>，<font face="DejaVu Serif, serif"><span lang="en-US">$printk_level</span></font>，<font face="DejaVu Serif, serif"><span lang="en-US">$printk_format
</span></font>和 <font face="DejaVu Serif, serif"><span lang="en-US">$printk_tmp</span></font>。他们可以用来直接显示值，请看<a href="#如何让tracepoint直接输出信息|outline">如何让<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</a></span></font><a href="#如何让tracepoint直接输出信息|outline">直接输出信息</a>。</p>
<p align="left"><br><br>
</p>
<p align="left">下面是一个用<font face="DejaVu Serif, serif"><span lang="en-US">$c</span></font>记录进程<font face="DejaVu Serif, serif"><span lang="en-US">16663</span></font>调用多少次<font face="DejaVu Serif, serif"><span lang="en-US">vfs_read</span></font>并收集<font face="DejaVu Serif, serif"><span lang="en-US">thread_info</span></font>结构的例子：</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
target remote /sys/kernel/debug/gtp</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
trace vfs_read if (((struct task_struct *)$current_task)-&gt;pid ==
16663)</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
tvariable $c</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
actions</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Enter
actions for tracepoint 4, one per line.</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>End
with a line saying just &quot;end&quot;.</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;teval
$c=$c+1</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;collect
(*(struct thread_info *)$current_thread_info)</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;end</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
tstart </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
info tvariables </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Name
           Initial     Current     </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>$c
             0           184         </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>$current_task
  0           &lt;unknown&gt;   </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>$current_thread_info
0           &lt;unknown&gt;   </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>$cpu_id
        0           &lt;unknown&gt;   </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
tstop</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
tfind</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
p *(struct thread_info *)$current_thread_info</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>$10
= {task = 0xf0ac6580, exec_domain = 0xc07b1400, flags = 0, status =
0, cpu = 1, preempt_count = 2, addr_limit = {</i></span></font></blockquote>
<blockquote class="cjk">    <font face="DejaVu Serif, serif"><span lang="en-US"><i>seg
= 4294967295}, restart_block = {fn = 0xc0159fb0
&lt;do_no_restart_syscall&gt;, {{arg0 = 138300720, arg1 = 11, </i></span></font>
</blockquote>
<blockquote class="cjk">        <font face="DejaVu Serif, serif"><span lang="en-US"><i>arg2
= 1, arg3 = 78}, futex = {uaddr = 0x83e4d30, val = 11, flags = 1,
bitset = 78, time = 977063750, </i></span></font>
</blockquote>
<blockquote class="cjk">        <font face="DejaVu Serif, serif"><span lang="en-US"><i>uaddr2
= 0x0}, nanosleep = {index = 138300720, rmtp = 0xb, expires =
335007449089}, poll = {</i></span></font></blockquote>
<blockquote class="cjk">        <font face="DejaVu Serif, serif"><span lang="en-US"><i>ufds
= 0x83e4d30, nfds = 11, has_timeout = 1, tv_sec = 78, tv_nsec =
977063750}}}, </i></span></font>
</blockquote>
<blockquote class="cjk">  <font face="DejaVu Serif, serif"><span lang="en-US"><i>sysenter_return
= 0xb77ce424, previous_esp = 0, supervisor_stack = 0xef340044 &quot;&quot;,
uaccess_err = 0}</i></span></font></blockquote>
<blockquote class="cjk" style="margin-left: 0cm"><br>
</blockquote>
<p align="left">这是一个记录每个<font face="DejaVu Serif, serif"><span lang="en-US">CPU</span></font>调用了多少次<font face="DejaVu Serif, serif"><span lang="en-US">sys_read()</span></font>的例子。</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
tvariable $c0</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
tvariable $c1</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
trace sys_read </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
condition $bpnum ($cpu_id == 0)</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
actions</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;teval
$c0=$c0+1</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;end</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
trace sys_read </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
condition $bpnum ($cpu_id == 1)</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
actions</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;teval
$c1=$c1+1</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;end</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
info tvariables </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Name
           Initial     Current     </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>$current_task
  0           &lt;unknown&gt;   </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>$cpu_id
        0           &lt;unknown&gt;   </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>$c0
            0           3255        </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>$c1
            0           1904     </i></span></font>
</blockquote>
<p align="left"><font face="DejaVu Serif, serif"><span lang="en-US">sys_read()
</span></font>在<font face="DejaVu Serif, serif"><span lang="en-US">CPU0</span></font>上被执行了<font face="DejaVu Serif, serif"><span lang="en-US">3255</span></font>次，<font face="DejaVu Serif, serif"><span lang="en-US">CPU1</span></font>上执行了<font face="DejaVu Serif, serif"><span lang="en-US">1904</span></font>次。请
注意 这个例子只是为了显示如何使用<font face="DejaVu Serif, serif"><span lang="en-US">$cpu_id</span></font>，实际上用<font face="DejaVu Serif, serif"><span lang="en-US">per_cpu
trace</span></font>状态变量写更好。</p>
<p align="left"><br><br>
</p>
<h3 class="cjk" style="page-break-before: always"><a name="__RefHeading__13586_71337508"></a>
特殊<font face="DejaVu Serif, serif"><span lang="en-US">trace</span></font>状态变量
<font face="DejaVu Serif, serif"><span lang="en-US">$self_trace</span></font></h3>
<p align="left"><font face="DejaVu Serif, serif"><span lang="en-US">$self_trace</span></font>和前面介绍的特殊<font face="DejaVu Serif, serif"><span lang="en-US">trace</span></font>状态变量不同，它是用来控制<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>的行为的。</p>
<p align="left">默认情况下，<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>被触发后，如果<font face="DejaVu Serif, serif"><span lang="en-US">current_task</span></font>是<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>自己的进程（<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>，<font face="DejaVu Serif, serif"><span lang="en-US">netcat</span></font>，<font face="DejaVu Serif, serif"><span lang="en-US">getframe</span></font>或者其他访问<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>接口的进程）的时候，其将不执行任何<font face="DejaVu Serif, serif"><span lang="en-US">actions</span></font>。</p>
<p align="left">如果你想让<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint
actions</span></font>和任何<font face="DejaVu Serif, serif"><span lang="en-US">task</span></font>的时候都执行，请包含一个包含一个访问到<font face="DejaVu Serif, serif"><span lang="en-US">$self_trace</span></font>的命令到<font face="DejaVu Serif, serif"><span lang="en-US">actions</span></font>中，也就是说增加下面的命令到<font face="DejaVu Serif, serif"><span lang="en-US">actions</span></font>中：</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;teval
$self_trace=0</i></span></font></blockquote>
<p align="left"><br><br>
</p>
<h3 class="cjk" style="page-break-before: always"><a name="__RefHeading__13588_71337508"></a>
用<font face="DejaVu Serif, serif"><span lang="en-US">$kret
trace</span></font>函数的结尾</h3>
<p align="left">有时，因为内核是用优化编译的，所以在函数结尾设置<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>有时很困难。这时你可以用<font face="DejaVu Serif, serif"><span lang="en-US">$kret</span></font>帮助你。</p>
<p align="left"><font face="DejaVu Serif, serif"><span lang="en-US">$kret</span></font>是一个类似<font face="DejaVu Serif, serif"><span lang="en-US">$self_trace</span></font>的特殊<font face="DejaVu Serif, serif"><span lang="en-US">trace</span></font>状态变量。当你在<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint
action</span></font>里设置它的值的时候，这个<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>将用<font face="DejaVu Serif, serif"><span lang="en-US">kretprobe</span></font>而不是<font face="DejaVu Serif, serif"><span lang="en-US">kprobe</span></font>注册。于是其就可以<font face="DejaVu Serif, serif"><span lang="en-US">trace</span></font>一个函数的结尾。</p>
<p align="left">请 <b>注意</b> 这个<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint
</span></font>必须用<b> </b><font face="DejaVu Serif, serif"><span lang="en-US"><b>&quot;function_name&quot;
</b></span></font><b>的格式设置在函数的第一个地址上</b>。</p>
<p align="left"><br><br>
</p>
<p align="left">下面的部分是一个例子：</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#&quot;*(function_name)&quot;
format can make certain that GDB send the first address of function
to KGTP.</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
trace *vfs_read</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
actions</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;teval
$kret=0</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#Following
part you can set commands that you want.</i></span></font></blockquote>
<p align="left"><br><br>
</p>
<h3 class="cjk" style="page-break-before: always"><a name="__RefHeading__13590_71337508"></a>
用 <font face="DejaVu Serif, serif"><span lang="en-US">$ignore_error
</span></font>和 <font face="DejaVu Serif, serif"><span lang="en-US">$last_errno
</span></font>忽略<font face="DejaVu Serif, serif"><span lang="en-US">tstart</span></font>的错误</h3>
<p align="left">当<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>在<font face="DejaVu Serif, serif"><span lang="en-US">tstart</span></font>取得错误，这个命令将失败。</p>
<p align="left">但有时我们需要忽略这个错误信息并让<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>工作。例如：如果你在<font face="DejaVu Serif, serif"><span lang="en-US">inline</span></font>函数<font face="DejaVu Serif, serif"><span lang="en-US">spin_lock</span></font>设置<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>，这个<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>将被设置到很多地址上，有一些地址不能设置<font face="DejaVu Serif, serif"><span lang="en-US">kprobe</span></font>，于是它就会让<font face="DejaVu Serif, serif"><span lang="en-US">tstart</span></font>出错。这时你就可以用<font face="DejaVu Serif, serif"><span lang="en-US">&quot;$ignore_error&quot;</span></font>忽略这些错误。</p>
<p align="left">最后一个错误信息将存在<font face="DejaVu Serif, serif"><span lang="en-US">&quot;$last_errno&quot;</span></font>中。</p>
<p align="left"><br><br>
</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
tvariable $ignore_error=1</i></span></font></blockquote>
<p align="left">这个命令将打开忽略。</p>
<p align="left"><br><br>
</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
tvariable $ignore_error=0</i></span></font></blockquote>
<p align="left">这个命令将关闭忽略。</p>
<p align="left"><br><br>
</p>
<h3 class="cjk" style="page-break-before: always"><a name="__RefHeading__13592_71337508"></a>
使用 <font face="DejaVu Serif, serif"><span lang="en-US">$cooked_clock
</span></font>和 <font face="DejaVu Serif, serif"><span lang="en-US">$cooked_rdtsc
</span></font>取得不包含<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>运行时间的时间信息</h3>
<p align="left">访问这两个<font face="DejaVu Serif, serif"><span lang="en-US">trace</span></font>状态变量可以取得不包含<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>运行时间的时间信息，于是我们可以取得一段代码更真实的执行时间即使这个<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>的<font face="DejaVu Serif, serif"><span lang="en-US">action</span></font>比较复杂。</p>
<p align="left"><br><br>
</p>
<h3 class="cjk" style="page-break-before: always"><a name="__RefHeading__13594_71337508"></a>
使用 <font face="DejaVu Serif, serif"><span lang="en-US">$xtime_sec
</span></font>和 <font face="DejaVu Serif, serif"><span lang="en-US">$xtime_nsec
</span></font>取得 <font face="DejaVu Serif, serif"><span lang="en-US">timespec</span></font></h3>
<p align="left">访问<font face="DejaVu Serif, serif"><span lang="en-US">trace</span></font>状态变量将返回用<font face="DejaVu Serif, serif"><span lang="en-US">getnstimeofday</span></font>取得的<font face="DejaVu Serif, serif"><span lang="en-US">timespec</span></font>时间信息。</p>
<p align="left"><font face="DejaVu Serif, serif"><span lang="en-US">$xtime_sec
</span></font>将返回<font face="DejaVu Serif, serif"><span lang="en-US">timespec</span></font>秒的部分。</p>
<p align="left"><font face="DejaVu Serif, serif"><span lang="en-US">$xtime_nsec
</span></font>将返回<font face="DejaVu Serif, serif"><span lang="en-US">timespec</span></font>纳秒的部分。</p>
<p align="left"><br><br>
</p>
<h2 class="cjk" style="page-break-before: always"><a name="__RefHeading__13596_71337508"></a><a name="如何 backtrace (stack dump)|outline"></a>
如何 <font face="DejaVu Serif, serif"><span lang="en-US">backtrace
(stack dump)</span></font></h2>
<p align="left">每次你的程序做一个函数调用的时候，
这次调用的信息就会生成。这些信息包括调用函数的地址，调用参数，局部变量的值。这些信息被存储在我们称为栈帧的地方，栈帧是从调用栈中分配而来。</p>
<p align="left"><br><br>
</p>
<h3 class="cjk" style="page-break-before: always"><a name="__RefHeading__13598_71337508"></a>
通过<font face="DejaVu Serif, serif"><span lang="en-US">$bt</span></font>收集栈并用<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>命令<font face="DejaVu Serif, serif"><span lang="en-US">backtrace</span></font>进行分析</h3>
<p align="left">因为这个方法更快（因为在<font face="DejaVu Serif, serif"><span lang="en-US">trace</span></font>的时候只收集）而且可以分析出大部分的调用栈中的信息（前面介绍的栈信息都可以分析出来），所以时间你使用这个方法做栈分析。</p>
<p align="left">首先我们需要在<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint
action</span></font>中增加命令收集栈。</p>
<p align="left"><strike><font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>收集栈的通常命令是：
在<font face="DejaVu Serif, serif"><span lang="en-US">x86_32,
</span></font>下面的命令将收集<font face="DejaVu Serif, serif"><span lang="en-US">512</span></font>字节的栈内容。</strike></p>
<p align="left"><strike><font face="DejaVu Serif, serif"><span lang="en-US">&gt;collect
*(unsigned char *)$esp@512</span></font></strike></p>
<p align="left"><strike>在<font face="DejaVu Serif, serif"><span lang="en-US">x86_64,
</span></font>下面的命令将收集<font face="DejaVu Serif, serif"><span lang="en-US">512</span></font>字节的栈内容。</strike></p>
<p align="left"><strike><font face="DejaVu Serif, serif"><span lang="en-US">&gt;collect
*(unsigned char *)$rsp@512</span></font></strike></p>
<p align="left"><strike>在<font face="DejaVu Serif, serif"><span lang="en-US">MIPS</span></font>或者<font face="DejaVu Serif, serif"><span lang="en-US">ARM,
</span></font>下面的命令将收集<font face="DejaVu Serif, serif"><span lang="en-US">512</span></font>字节的栈内容。</strike></p>
<p align="left"><strike><font face="DejaVu Serif, serif"><span lang="en-US">&gt;collect
*(unsigned char *)$sp@512</span></font></strike></p>
<p align="left"><strike>这些命令很难记，而且不同的体系结构需要不同的命令。</strike></p>
<p align="left"><font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>有一个特殊<font face="DejaVu Serif, serif"><span lang="en-US">trace</span></font>状态变量<font face="DejaVu Serif, serif"><span lang="en-US">$bt</span></font>。如果<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint
action</span></font>访问到它，<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>将自动收集<font face="DejaVu Serif, serif"><span lang="en-US">$bt</span></font>长度（默认值是<font face="DejaVu Serif, serif"><span lang="en-US">512</span></font>）的栈。下面这个<font face="DejaVu Serif, serif"><span lang="en-US">action</span></font>将收集<font face="DejaVu Serif, serif"><span lang="en-US">512</span></font>字节的栈内存：</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;collect
$bt</i></span></font></blockquote>
<blockquote class="cjk" style="margin-left: 0cm"><br>
</blockquote>
<p align="left">如果你想改变<font face="DejaVu Serif, serif"><span lang="en-US">$bt</span></font>的值，你可以在<font face="DejaVu Serif, serif"><span lang="en-US">&quot;tstart&quot;</span></font>使用下面这个<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>命令：</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
tvariable $bt=1024</i></span></font></blockquote>
<p align="left"><br><br>
</p>
<p align="left">下面的部分是一个收集栈并用<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>进行分析的例子：</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
target remote /sys/kernel/debug/gtp</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
trace vfs_readdir</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Tracepoint
1 at 0xffffffff8118c300: file
/home/teawater/kernel2/linux/fs/readdir.c, line 24.</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
actions </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Enter
actions for tracepoint 1, one per line.</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>End
with a line saying just &quot;end&quot;.</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;collect
$bt</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;end</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
tstart </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
shell ls</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>1
     crypto    fs             include  kernel    mm              
Module.symvers  security  System.map  vmlinux</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>arch
  drivers   hotcode.html   init     lib       modules.builtin  net   
         sound     usr         vmlinux.o</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>block
 firmware  hotcode.html~  ipc      Makefile  modules.order    scripts
        source    virt</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
tstop </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
tfind </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Found
trace frame 0, tracepoint 1</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#0
 vfs_readdir (file=0xffff8800c5556d00, filler=0xffffffff8118c4b0
&lt;filldir&gt;, buf=0xffff880108709f40)</i></span></font></blockquote>
<blockquote class="cjk">    <font face="DejaVu Serif, serif"><span lang="en-US"><i>at
/home/teawater/kernel2/linux/fs/readdir.c:24</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>24
     {</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
bt</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#0
 vfs_readdir (file=0xffff8800c5556d00, filler=0xffffffff8118c4b0
&lt;filldir&gt;, buf=0xffff880108709f40)</i></span></font></blockquote>
<blockquote class="cjk">    <font face="DejaVu Serif, serif"><span lang="en-US"><i>at
/home/teawater/kernel2/linux/fs/readdir.c:24</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#1
 0xffffffff8118c689 in sys_getdents (fd=&lt;optimized out&gt;,
dirent=0x1398c58, count=32768) at
/home/teawater/kernel2/linux/fs/readdir.c:214</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#2
 &lt;signal handler called&gt;</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#3
 0x00007f00253848a5 in ?? ()</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#4
 0x00003efd32cddfc9 in ?? ()</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#5
 0x00002c15b7d04101 in ?? ()</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#6
 0x000019c0c5704bf1 in ?? ()</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#7
 0x0000000900000000 in ?? ()</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#8
 0x000009988cc8d269 in ?? ()</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#9
 0x000009988cc9b8d1 in ?? ()</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#10
0x0000000000000000 in ?? ()</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
up</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#1
 0xffffffff8118c689 in sys_getdents (fd=&lt;optimized out&gt;,
dirent=0x1398c58, count=32768) at
/home/teawater/kernel2/linux/fs/readdir.c:214</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>214
            error = vfs_readdir(file, filldir, &amp;buf);</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
p buf</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>$1
= {current_dir = 0x1398c58, previous = 0x0, count = 32768, error = 0}</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
p error</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>$3
= -9</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
frame 0</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#0
 vfs_readdir (file=0xffff8800c5556d00, filler=0xffffffff8118c4b0
&lt;filldir&gt;, buf=0xffff880108709f40)</i></span></font></blockquote>
<blockquote class="cjk">    <font face="DejaVu Serif, serif"><span lang="en-US"><i>at
/home/teawater/kernel2/linux/fs/readdir.c:24</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>24
     {</i></span></font></blockquote>
<blockquote class="cjk" style="margin-left: 0cm"><br>
</blockquote>
<p align="left">从这个例子，我们可以看到一些分析调用栈的<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>命令：</p>
<ul>
	<li><p align="left"><font face="DejaVu Serif, serif"><span lang="en-US"><b>bt
	</b></span></font>是<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>命令
	<font face="DejaVu Serif, serif"><span lang="en-US">backtrace
	</span></font>的别名，这个命令将打印<font face="DejaVu Serif, serif"><span lang="en-US">stack</span></font>中的信息：每一行是一个调用栈。</p>
	<li><p align="left"><font face="DejaVu Serif, serif"><span lang="en-US"><b>up
	n</b> </span></font>是向上移动<font face="DejaVu Serif, serif"><span lang="en-US">n</span></font>个帧。如果<font face="DejaVu Serif, serif"><span lang="en-US">n</span></font>是正数，则向外到更高的帧，一直到这个栈最大的一行。<font face="DejaVu Serif, serif"><span lang="en-US">n</span></font>的默认值是<font face="DejaVu Serif, serif"><span lang="en-US">1</span></font>。</p>
	<li><p align="left"><font face="DejaVu Serif, serif"><span lang="en-US"><b>down
	n</b> </span></font>是向下移动<font face="DejaVu Serif, serif"><span lang="en-US">n</span></font>个帧。如果<font face="DejaVu Serif, serif"><span lang="en-US">n</span></font>是正数，则向内到更低的帧，一直到最新创建的那个栈帧。<font face="DejaVu Serif, serif"><span lang="en-US">n</span></font>的默认值是<font face="DejaVu Serif, serif"><span lang="en-US">1</span></font>。</p>
	<p align="left"><font face="DejaVu Serif, serif"><span lang="en-US">is
	move n frames down the stack. For positive numbers n, this advances
	toward the innermost frame, to lower frame numbers, to frames that
	were created more recently. n defaults to one. </span></font>你可以把
	<font face="DejaVu Serif, serif"><span lang="en-US">down </span></font>缩写为
	<font face="DejaVu Serif, serif"><span lang="en-US">do</span></font>。</p>
	<li><p align="left"><font face="DejaVu Serif, serif"><span lang="en-US"><b>frame
	n</b> </span></font>是选择帧<font face="DejaVu Serif, serif"><span lang="en-US">n</span></font>。帧<font face="DejaVu Serif, serif"><span lang="en-US">0</span></font>是最近创建的帧，帧<font face="DejaVu Serif, serif"><span lang="en-US">1</span></font>调用这个帧的帧。所以最高的帧是<font face="DejaVu Serif, serif"><span lang="en-US">main</span></font>。</p>
</ul>
<p align="left">你还可以看到当你用<font face="DejaVu Serif, serif"><span lang="en-US">up</span></font>，<font face="DejaVu Serif, serif"><span lang="en-US">down</span></font>或者<font face="DejaVu Serif, serif"><span lang="en-US">frame</span></font>来选择调用栈帧的时候，你可以输出不同帧的参数和局部变量。</p>
<p align="left">要取得更多关于如何使用<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>分析调用栈的信息，请到<font face="DejaVu Serif, serif"><span lang="en-US"><a href="http://sourceware.org/gdb/current/onlinedocs/gdb/Stack.html">http://sourceware.org/gdb/current/onlinedocs/gdb/Stack.html</a></span></font>。</p>
<p align="left"><br><br>
</p>
<h3 class="cjk" style="page-break-before: always"><a name="__RefHeading__13600_71337508"></a>
用<font face="DejaVu Serif, serif"><span lang="en-US">$_ret</span></font>来取得当前函数的调用函数的栈</h3>
<p align="left">如果你只想取得当前函数的调用函数的栈，可以用<font face="DejaVu Serif, serif"><span lang="en-US">$_ret</span></font>。</p>
<p align="left">请 <b>注意</b> 使用<font face="DejaVu Serif, serif"><span lang="en-US">$_ret</span></font>的<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>不能设置在函数的第一个地址上。</p>
<p align="left">例如：</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
list vfs_read</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>360
    }</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>361
    </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>362
    EXPORT_SYMBOL(do_sync_read);</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>363
    </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>364
    ssize_t vfs_read(struct file *file, char __user *buf, size_t
count, loff_t *pos)</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>365
    {</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>366
            ssize_t ret;</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>367
    </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>368
            if (!(file-&gt;f_mode &amp; FMODE_READ))</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>369
                    return -EBADF;</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
trace 368</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Tracepoint
2 at 0xffffffff8117a244: file
/home/teawater/kernel2/linux/fs/read_write.c, line 368.</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
actions </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Enter
actions for tracepoint 2, one per line.</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>End
with a line saying just &quot;end&quot;.</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;collect
$_ret</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;end</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
tstart </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
tstop </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
tfind </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Found
trace frame 0, tracepoint 2</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#0
 vfs_read (file=0xffff880141c46000, buf=0x359bda0 &lt;Address
0x359bda0 out of bounds&gt;, count=8192, pos=0xffff88012fa49f48)</i></span></font></blockquote>
<blockquote class="cjk">    <font face="DejaVu Serif, serif"><span lang="en-US"><i>at
/home/teawater/kernel2/linux/fs/read_write.c:368</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>368
            if (!(file-&gt;f_mode &amp; FMODE_READ))</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
bt</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#0
 vfs_read (file=0xffff880141c46000, buf=0x359bda0 &lt;Address
0x359bda0 out of bounds&gt;, count=8192, pos=0xffff88012fa49f48)</i></span></font></blockquote>
<blockquote class="cjk">    <font face="DejaVu Serif, serif"><span lang="en-US"><i>at
/home/teawater/kernel2/linux/fs/read_write.c:368</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#1
 0xffffffff8117a3ea in sys_read (fd=&lt;optimized out&gt;,
buf=&lt;unavailable&gt;, count=&lt;unavailable&gt;)</i></span></font></blockquote>
<blockquote class="cjk">    <font face="DejaVu Serif, serif"><span lang="en-US"><i>at
/home/teawater/kernel2/linux/fs/read_write.c:469</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Backtrace
stopped: not enough registers or memory available to unwind further</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
up</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#1
 0xffffffff8117a3ea in sys_read (fd=&lt;optimized out&gt;,
buf=&lt;unavailable&gt;, count=&lt;unavailable&gt;)</i></span></font></blockquote>
<blockquote class="cjk">    <font face="DejaVu Serif, serif"><span lang="en-US"><i>at
/home/teawater/kernel2/linux/fs/read_write.c:469</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>469
                    ret = vfs_read(file, buf, count, &amp;pos);</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
p ret</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>$2
= -9</i></span></font></blockquote>
<p align="left">我们可以看到调用<font face="DejaVu Serif, serif"><span lang="en-US">vfs_read</span></font>的函数是<font face="DejaVu Serif, serif"><span lang="en-US">sys_read</span></font>，函数<font face="DejaVu Serif, serif"><span lang="en-US">sys_read</span></font>的局部变量<font face="DejaVu Serif, serif"><span lang="en-US">ret</span></font>的值是<font face="DejaVu Serif, serif"><span lang="en-US">-9</span></font>。</p>
<p align="left"><br><br>
</p>
<h3 class="cjk" style="page-break-before: always"><a name="__RefHeading__13602_71337508"></a>
用 <font face="DejaVu Serif, serif"><span lang="en-US">$dump_stack
</span></font>输出栈分析到<font face="DejaVu Serif, serif"><span lang="en-US">printk</span></font>里</h3>
<p align="left">因为这个方法需要在<font face="DejaVu Serif, serif"><span lang="en-US">trace</span></font>的时候分析栈并调用<font face="DejaVu Serif, serif"><span lang="en-US">printk</span></font>，所以它比较慢，不安全，不清晰也不能访问调用栈中的很多内容，所以我建议你上一部分介绍的方法</p>
<p align="left"><font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>有一个特殊的<font face="DejaVu Serif, serif"><span lang="en-US">trace</span></font>状态变量<font face="DejaVu Serif, serif"><span lang="en-US">$dump_stack</span></font>，收集这个变量可以令<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>调用栈分析并用<font face="DejaVu Serif, serif"><span lang="en-US">printk</span></font>输出。
下面是一个让内核输出<font face="DejaVu Serif, serif"><span lang="en-US">vfs_readdir</span></font>栈分析的例子：</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>target
remote /sys/kernel/debug/gtp</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>trace
vfs_readdir</i></span></font></blockquote>
<blockquote class="cjk">  <font face="DejaVu Serif, serif"><span lang="en-US"><i>commands</i></span></font></blockquote>
<blockquote class="cjk">    <font face="DejaVu Serif, serif"><span lang="en-US"><i>collect
$dump_stack</i></span></font></blockquote>
<blockquote class="cjk">  <font face="DejaVu Serif, serif"><span lang="en-US"><i>end</i></span></font></blockquote>
<blockquote class="cjk" style="margin-left: 0cm"><br>
</blockquote>
<p align="left">于是你的内核就会<font face="DejaVu Serif, serif"><span lang="en-US">printk</span></font>这样的信息：</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>[22779.208064]
gtp 1:Pid: 441, comm: python Not tainted 2.6.39-rc3+ #46</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>[22779.208068]
Call Trace:</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>[22779.208072]
 [&lt;fe653cca&gt;] gtp_get_var+0x4a/0xa0 [gtp]</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>[22779.208076]
 [&lt;fe653d79&gt;] gtp_collect_var+0x59/0xa0 [gtp]</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>[22779.208080]
 [&lt;fe655974&gt;] gtp_action_x+0x1bb4/0x1dc0 [gtp]</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>[22779.208084]
 [&lt;c05b6408&gt;] ? _raw_spin_unlock+0x18/0x40</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>[22779.208088]
 [&lt;c023f152&gt;] ? __find_get_block_slow+0xd2/0x160</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>[22779.208091]
 [&lt;c01a8c56&gt;] ? delayacct_end+0x96/0xb0</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>[22779.208100]
 [&lt;c023f404&gt;] ? __find_get_block+0x84/0x1d0</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>[22779.208103]
 [&lt;c05b6408&gt;] ? _raw_spin_unlock+0x18/0x40</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>[22779.208106]
 [&lt;c02e0838&gt;] ? find_revoke_record+0xa8/0xc0</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>[22779.208109]
 [&lt;c02e0c45&gt;] ? jbd2_journal_cancel_revoke+0xd5/0xe0</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>[22779.208112]
 [&lt;c02db51f&gt;] ? __jbd2_journal_temp_unlink_buffer+0x2f/0x110</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>[22779.208115]
 [&lt;fe655c4c&gt;] gtp_kp_pre_handler+0xcc/0x1c0 [gtp]</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>[22779.208118]
 [&lt;c05b8a88&gt;] kprobe_exceptions_notify+0x3d8/0x440</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>[22779.208121]
 [&lt;c05b7d54&gt;] ? hw_breakpoint_exceptions_notify+0x14/0x180</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>[22779.208124]
 [&lt;c05b95eb&gt;] ? sub_preempt_count+0x7b/0xb0</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>[22779.208126]
 [&lt;c0227ac5&gt;] ? vfs_readdir+0x15/0xb0</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>[22779.208128]
 [&lt;c0227ac4&gt;] ? vfs_readdir+0x14/0xb0</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>[22779.208131]
 [&lt;c05b9743&gt;] notifier_call_chain+0x43/0x60</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>[22779.208134]
 [&lt;c05b9798&gt;] __atomic_notifier_call_chain+0x38/0x50</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>[22779.208137]
 [&lt;c05b97cf&gt;] atomic_notifier_call_chain+0x1f/0x30</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>[22779.208140]
 [&lt;c05b980d&gt;] notify_die+0x2d/0x30</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>[22779.208142]
 [&lt;c05b71c5&gt;] do_int3+0x35/0xa0</i></span></font></blockquote>
<blockquote class="cjk" style="margin-left: 0cm"><br>
</blockquote>
<h2 class="cjk" style="page-break-before: always"><a name="__RefHeading__13604_71337508"></a><a name="如何让tracepoint直接输出信息|outline"></a><a name="如何让tracepoint直接输出信息|outline"></a>
如何让<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>直接输出信息</h2>
<p align="left">在前面的章节，你可以看到如果想取得<font face="DejaVu Serif, serif"><span lang="en-US">Linux</span></font>内核的信息，你需要用<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint
&quot;collect&quot; action</span></font>来保存信息到<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>帧中并用<font face="DejaVu Serif, serif"><span lang="en-US">GDB
tfind</span></font>命来来分析这些数据帧。</p>
<p align="left">但是有时我们希望直接取得这些数据，所以<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>提供了一种直接取得这些数据的方法。</p>
<h3 class="cjk"><a name="__RefHeading__9855_1050592842"></a>切换<font face="DejaVu Serif, serif"><span lang="en-US">collect</span></font>为直接输出数据</h3>
<p align="left"><font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>有特殊<font face="DejaVu Serif, serif"><span lang="en-US">trace</span></font>状态变量<font face="DejaVu Serif, serif"><span lang="en-US">$printk_level</span></font>，<font face="DejaVu Serif, serif"><span lang="en-US">$printk_format
</span></font>和 <font face="DejaVu Serif, serif"><span lang="en-US">$printk_tmp</span></font>支持这个功能。</p>
<p align="left"><font face="DejaVu Serif, serif"><span lang="en-US">$printk_level</span></font>，如果这个值是<font face="DejaVu Serif, serif"><span lang="en-US">8</span></font>（这是默认值），<font face="DejaVu Serif, serif"><span lang="en-US">&quot;collect&quot;
action</span></font>将是普通行为也就是保存数据到<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>帧中。</p>
<p align="left">如果值是<font face="DejaVu Serif, serif"><span lang="en-US">0-7</span></font>，<font face="DejaVu Serif, serif"><span lang="en-US">&quot;collect&quot;
</span></font>将以这个数字为<font face="DejaVu Serif, serif"><span lang="en-US">printk</span></font>级别输出信息，这些级别是：</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>0
      KERN_EMERG      system is unusable</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>1
      KERN_ALERT      action must be taken immediately</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>2
      KERN_CRIT       critical conditions</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>3
      KERN_ERR        error conditions</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>4
      KERN_WARNING    warning conditions</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>5
      KERN_NOTICE     normal but significant condition</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>6
      KERN_INFO       informational</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>7
      KERN_DEBUG      debug-level messages</i></span></font></blockquote>
<blockquote class="cjk" style="margin-left: 0cm"><br>
</blockquote>
<p align="left"><font face="DejaVu Serif, serif"><span lang="en-US">$printk_format</span></font>，<font face="DejaVu Serif, serif"><span lang="en-US">collect
printk</span></font>将按照这里设置的格式进行输出。
这些格式是：</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>0
      </i></span></font>这是默认值。</blockquote>
<blockquote class="cjk">        如果<font face="DejaVu Serif, serif"><span lang="en-US"><i>collect</i></span></font>的长度是<font face="DejaVu Serif, serif"><span lang="en-US"><i>1</i></span></font>，<font face="DejaVu Serif, serif"><span lang="en-US"><i>2</i></span></font>，<font face="DejaVu Serif, serif"><span lang="en-US"><i>4</i></span></font>，<font face="DejaVu Serif, serif"><span lang="en-US"><i>8</i></span></font>则其将输出一个无符号十进制数。</blockquote>
<blockquote class="cjk">        如果不是，则其将输出十六进制字串。</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>1
      </i></span></font>输出值是有符号十进制数。</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>2
      </i></span></font>输出值是无符号十进制数。</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>3
      </i></span></font>输出值是无符号十六进制数。</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>4
      </i></span></font>输出值是字符串。</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>5
      </i></span></font>输出值是十六进制字串。</blockquote>
<blockquote class="cjk" style="margin-left: 0cm"><br>
</blockquote>
<p align="left">如果要输出一个全局变量，需要将其先设置到<font face="DejaVu Serif, serif"><span lang="en-US">$printk_tmp</span></font>中。</p>
<p align="left"><br><br>
</p>
<p align="left">下面是一个显示调用<font face="DejaVu Serif, serif"><span lang="en-US">vfs_readdir</span></font>时的计数，<font face="DejaVu Serif, serif"><span lang="en-US">pid</span></font>，<font face="DejaVu Serif, serif"><span lang="en-US">jiffies_64</span></font>和文件名的例子：</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
target remote /sys/kernel/debug/gtp</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
tvariable $c</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
trace vfs_readdir</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
actions</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;teval
$printk_level=0</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;collect
$c=$c+1</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;collect
((struct task_struct *)$current_task)-&gt;pid</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;collect
$printk_tmp=jiffies_64</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;teval
$printk_format=4</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;collect
file-&gt;f_path.dentry-&gt;d_iname</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;end</i></span></font></blockquote>
<blockquote class="cjk" style="margin-left: 0cm"><br>
</blockquote>
<p align="left">于是内核将<font face="DejaVu Serif, serif"><span lang="en-US">printk</span></font>这些信息：</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>gtp
1:$c=$c+1=41</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>gtp
1:((struct task_struct *)$current_task)-&gt;pid=12085</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>gtp
1:$printk_tmp=jiffies_64=4322021438</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>gtp
1:file-&gt;f_path.dentry-&gt;d_iname=b26</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>gtp
1:$c=$c+1=42</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>gtp
1:((struct task_struct *)$current_task)-&gt;pid=12085</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>gtp
1:$printk_tmp=jiffies_64=4322021438</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>gtp
1:file-&gt;f_path.dentry-&gt;d_iname=b26</i></span></font></blockquote>
<p align="left"><font face="DejaVu Serif, serif"><span lang="en-US">&quot;gtp
1&quot; </span></font>的意思是数据是<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint
1</span></font>输出的。</p>
<p align="left"><br><br>
</p>
<h2 class="cjk" style="page-break-before: always"><a name="__RefHeading__9857_1050592842"></a><a name="如何用watch tracepoint控制硬件断点记录内存访问|outline"></a><a name="如何用watch tracepoint控制硬件断点记录内存访问|outline"></a>
如何用<font face="DejaVu Serif, serif"><span lang="en-US">watch
tracepoint</span></font>控制硬件断点记录内存访问</h2>
<p align="left"><font face="DejaVu Serif, serif"><span lang="en-US"><b>Watch
tracepoint </b></span></font>可以通过设置一些特殊的<font face="DejaVu Serif, serif"><span lang="en-US">trace</span></font>状态变量设置硬件断点来记录内存访问。</p>
<p align="left">请 <b>注意</b> <font face="DejaVu Serif, serif"><span lang="en-US">watch
tracepoint</span></font>现在只有<font face="DejaVu Serif, serif"><span lang="en-US">X86</span></font>和<font face="DejaVu Serif, serif"><span lang="en-US">X86_64</span></font>支持。而且因为<font face="DejaVu Serif, serif"><span lang="en-US">Linux
2.6.26</span></font>和更老版本有一些<font face="DejaVu Serif, serif"><span lang="en-US">IPI</span></font>的问题，只有<font face="DejaVu Serif, serif"><span lang="en-US">Linux
2.6.27</span></font>和更新版本上可以正常使用动态<font face="DejaVu Serif, serif"><span lang="en-US">watch
tracepoint</span></font>。</p>
<p align="left"><br><br>
</p>
<h3 class="cjk" style="page-break-before: always"><a name="__RefHeading__9859_1050592842"></a>
<font face="DejaVu Serif, serif"><span lang="en-US">watch
tracepoint</span></font>的<font face="DejaVu Serif, serif"><span lang="en-US">trace</span></font>状态变量</h3>
<table width="792" cellpadding="4" cellspacing="0">
	<col width="127">
	<col width="96">
	<col width="102">
	<col width="97">
	<col width="101">
	<col width="100">
	<col width="111">
	<tr valign="top">
		<td width="127" style="border-top: 1px solid #000000; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0.1cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt"><b>名称</b></font></p>
		</td>
		<td width="96" style="border-top: 1px solid #000000; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0.1cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt"><b>普通</b></font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US"><b>tracepoint</b></span></font></font><font size="3" style="font-size: 12pt"><b>写</b></font></p>
		</td>
		<td width="102" style="border-top: 1px solid #000000; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0.1cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt"><b>普通</b></font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US"><b>tracepoint</b></span></font></font><font size="3" style="font-size: 12pt"><b>读</b></font></p>
		</td>
		<td width="97" style="border-top: 1px solid #000000; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0.1cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt"><b>静态</b></font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US"><b>static
			tracepoint</b></span></font></font><font size="3" style="font-size: 12pt"><b>写</b></font></p>
		</td>
		<td width="101" style="border-top: 1px solid #000000; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0.1cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt"><b>静态</b></font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US"><b>static
			tracepoint</b></span></font></font><font size="3" style="font-size: 12pt"><b>读</b></font></p>
		</td>
		<td width="100" style="border-top: 1px solid #000000; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0.1cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt"><b>动态</b></font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US"><b>static
			tracepoint</b></span></font></font><font size="3" style="font-size: 12pt"><b>写</b></font></p>
		</td>
		<td width="111" style="border: 1px solid #000000; padding: 0.1cm">
			<p align="left"><font size="3" style="font-size: 12pt"><b>动态</b></font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US"><b>static
			tracepoint</b></span></font></font><font size="3" style="font-size: 12pt"><b>写</b></font></p>
		</td>
	</tr>
	<tr valign="top">
		<td width="127" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">$watch_static</span></font></font></p>
		</td>
		<td width="96" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt">不支持</font></p>
		</td>
		<td width="102" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt">不支持</font></p>
		</td>
		<td width="97" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt">如果</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">&quot;teval
			$watch_static=1&quot;</span></font></font><font size="3" style="font-size: 12pt">则这个</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tracepoint</span></font></font><font size="3" style="font-size: 12pt">是静态</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">watch
			tracepoint</span></font></font><font size="3" style="font-size: 12pt">。</font></p>
		</td>
		<td width="101" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt">不支持</font></p>
		</td>
		<td width="100" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt">如果</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">&quot;teval
			$watch_static=0&quot;</span></font></font><font size="3" style="font-size: 12pt">则这个</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tracepoint</span></font></font><font size="3" style="font-size: 12pt">是动态</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">watch
			tracepoint</span></font></font><font size="3" style="font-size: 12pt">。</font></p>
		</td>
		<td width="111" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: 1px solid #000000; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0.1cm">
			<p align="left"><font size="3" style="font-size: 12pt">不支持</font></p>
		</td>
	</tr>
	<tr valign="top">
		<td width="127" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">$watch_set_id</span></font></font></p>
		</td>
		<td width="96" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt">当这个</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tracepoint</span></font></font><font size="3" style="font-size: 12pt">要设置一个动态</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">watch
			tracepoint</span></font></font><font size="3" style="font-size: 12pt">的时候，设置动态</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">watch
			tracepoint</span></font></font><font size="3" style="font-size: 12pt">的</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ID</span></font></font><font size="3" style="font-size: 12pt">到</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">$watch_set_id</span></font></font><font size="3" style="font-size: 12pt">来标明你要设置哪个动态</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">watch
			tracepoint</span></font></font><font size="3" style="font-size: 12pt">。</font></p>
		</td>
		<td width="102" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt">不支持</font></p>
		</td>
		<td width="97" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt">不支持</font></p>
		</td>
		<td width="101" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt">不支持</font></p>
		</td>
		<td width="100" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt">不支持</font></p>
		</td>
		<td width="111" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: 1px solid #000000; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0.1cm">
			<p align="left"><font size="3" style="font-size: 12pt">不支持</font></p>
		</td>
	</tr>
	<tr valign="top">
		<td width="127" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">$watch_set_addr</span></font></font></p>
		</td>
		<td width="96" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt">当这个</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tracepoint</span></font></font><font size="3" style="font-size: 12pt">要设置一个动态</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">watch
			tracepoint</span></font></font><font size="3" style="font-size: 12pt">的时候，设置动态</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">watch
			tracepoint</span></font></font><font size="3" style="font-size: 12pt">的地址到</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">$watch_set_addr</span></font></font><font size="3" style="font-size: 12pt">来标明你要设置哪个动态</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">watch
			tracepoint</span></font></font><font size="3" style="font-size: 12pt">。</font></p>
		</td>
		<td width="102" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt">不支持</font></p>
		</td>
		<td width="97" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt">不支持</font></p>
		</td>
		<td width="101" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt">不支持</font></p>
		</td>
		<td width="100" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt">不支持</font></p>
		</td>
		<td width="111" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: 1px solid #000000; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0.1cm">
			<p align="left"><font size="3" style="font-size: 12pt">不支持</font></p>
		</td>
	</tr>
	<tr valign="top">
		<td width="127" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">$watch_type</span></font></font></p>
		</td>
		<td width="96" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt">当这个</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tracepoint</span></font></font><font size="3" style="font-size: 12pt">要设置一个动态</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">watch
			tracepoint</span></font></font><font size="3" style="font-size: 12pt">的时候，设置</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">watch</span></font></font><font size="3" style="font-size: 12pt">类型到</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">$watch_type</span></font></font><font size="3" style="font-size: 12pt">。</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US"><br>0</span></font></font><font size="3" style="font-size: 12pt">是执行。
			</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">1</span></font></font><font size="3" style="font-size: 12pt">是写。
			</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">2</span></font></font><font size="3" style="font-size: 12pt">是读或者写。</font></p>
		</td>
		<td width="102" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt">取得这个</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tracepoint</span></font></font><font size="3" style="font-size: 12pt">设置到</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">$watch_type</span></font></font><font size="3" style="font-size: 12pt">里的值。</font></p>
		</td>
		<td width="97" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt">设置</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">watch
			tracepoint</span></font></font><font size="3" style="font-size: 12pt">的类型。</font></p>
		</td>
		<td width="101" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt">取得这个</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">watch
			tracepoint</span></font></font><font size="3" style="font-size: 12pt">的类型。</font></p>
		</td>
		<td width="100" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt">设置</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">watch
			tracepoint</span></font></font><font size="3" style="font-size: 12pt">的默认类型。</font></p>
		</td>
		<td width="111" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: 1px solid #000000; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0.1cm">
			<p align="left"><font size="3" style="font-size: 12pt">取得这个</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">watch
			tracepoint</span></font></font><font size="3" style="font-size: 12pt">在实际执行中的类型。</font></p>
		</td>
	</tr>
	<tr valign="top">
		<td width="127" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">$watch_size</span></font></font></p>
		</td>
		<td width="96" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt">当这个</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tracepoint</span></font></font><font size="3" style="font-size: 12pt">要设置一个动态</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">watch
			tracepoint</span></font></font><font size="3" style="font-size: 12pt">的时候，设置</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">watch</span></font></font><font size="3" style="font-size: 12pt">长度到</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">$watch_size</span></font></font><font size="3" style="font-size: 12pt">。</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US"><br></span></font></font><font size="3" style="font-size: 12pt">长度是</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">1,
			2, 4, 8</span></font></font><font size="3" style="font-size: 12pt">。</font></p>
		</td>
		<td width="102" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt">取得这个</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tracepoint</span></font></font><font size="3" style="font-size: 12pt">设置到</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">$watch_size</span></font></font><font size="3" style="font-size: 12pt">里的值。</font></p>
		</td>
		<td width="97" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt">设置</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">watch
			tracepoint</span></font></font><font size="3" style="font-size: 12pt">的长度。</font></p>
		</td>
		<td width="101" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt">取得这个</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">watch
			tracepoint</span></font></font><font size="3" style="font-size: 12pt">的长度。</font></p>
		</td>
		<td width="100" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt">设置</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">watch
			tracepoint</span></font></font><font size="3" style="font-size: 12pt">的默认长度。</font></p>
		</td>
		<td width="111" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: 1px solid #000000; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0.1cm">
			<p align="left"><font size="3" style="font-size: 12pt">取得这个</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">watch
			tracepoint</span></font></font><font size="3" style="font-size: 12pt">在实际执行中的长度。</font></p>
		</td>
	</tr>
	<tr valign="top">
		<td width="127" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">$watch_start</span></font></font></p>
		</td>
		<td width="96" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt">设置地址到动态</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">watch
			tracepoint($watch_set_addr</span></font></font><font size="3" style="font-size: 12pt">或者</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">$watch_set_id</span></font></font><font size="3" style="font-size: 12pt">设置</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">)</span></font></font><font size="3" style="font-size: 12pt">中并让其开始工作。</font></p>
		</td>
		<td width="102" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt">取得这次开始的返回值。</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US"><br></span></font></font><font size="3" style="font-size: 12pt">（其可能会失败因为</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">X86</span></font></font><font size="3" style="font-size: 12pt">只有</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">4</span></font></font><font size="3" style="font-size: 12pt">个硬件断点）</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US"><br></span></font></font><font size="3" style="font-size: 12pt">取得</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">0</span></font></font><font size="3" style="font-size: 12pt">则成功，小于</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">0</span></font></font><font 
size="3" style="font-size: 12pt">则是错误</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ID</span></font></font><font size="3" style="font-size: 12pt">。</font></p>
		</td>
		<td width="97" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt">不支持</font></p>
		</td>
		<td width="101" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt">不支持</font></p>
		</td>
		<td width="100" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt">不支持</font></p>
		</td>
		<td width="111" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: 1px solid #000000; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0.1cm">
			<p align="left"><font size="3" style="font-size: 12pt">不支持</font></p>
		</td>
	</tr>
	<tr valign="top">
		<td width="127" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">$watch_stop</span></font></font></p>
		</td>
		<td width="96" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt">设置地址到</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">$watch_stop</span></font></font><font size="3" style="font-size: 12pt">将让一个</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">watch</span></font></font><font size="3" style="font-size: 12pt">这个地址的动态</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">watch
			tracepoint</span></font></font><font size="3" style="font-size: 12pt">停止。</font></p>
		</td>
		<td width="102" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt">取得这次停止的返回值。</font></p>
		</td>
		<td width="97" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt">不支持</font></p>
		</td>
		<td width="101" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt">不支持</font></p>
		</td>
		<td width="100" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt">不支持</font></p>
		</td>
		<td width="111" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: 1px solid #000000; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0.1cm">
			<p align="left"><font size="3" style="font-size: 12pt">不支持</font></p>
		</td>
	</tr>
	<tr valign="top">
		<td width="127" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">$watch_trace_num</span></font></font></p>
		</td>
		<td width="96" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt">不支持</font></p>
		</td>
		<td width="102" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt">不支持</font></p>
		</td>
		<td width="97" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt">不支持</font></p>
		</td>
		<td width="101" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt">不支持</font></p>
		</td>
		<td width="100" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt">不支持</font></p>
		</td>
		<td width="111" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: 1px solid #000000; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0.1cm">
			<p align="left"><font size="3" style="font-size: 12pt">设置这个动态</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">watch
			tracepoint</span></font></font><font size="3" style="font-size: 12pt">的</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tracepoint</span></font></font><font size="3" style="font-size: 12pt">的号码。</font></p>
		</td>
	</tr>
	<tr valign="top">
		<td width="127" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">$watch_trace_addr</span></font></font></p>
		</td>
		<td width="96" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt">不支持</font></p>
		</td>
		<td width="102" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt">不支持</font></p>
		</td>
		<td width="97" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt">不支持</font></p>
		</td>
		<td width="101" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt">不支持</font></p>
		</td>
		<td width="100" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt">不支持</font></p>
		</td>
		<td width="111" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: 1px solid #000000; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0.1cm">
			<p align="left"><font size="3" style="font-size: 12pt">设置这个动态</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">watch
			tracepoint</span></font></font><font size="3" style="font-size: 12pt">的</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tracepoint</span></font></font><font size="3" style="font-size: 12pt">的地址。</font></p>
		</td>
	</tr>
	<tr valign="top">
		<td width="127" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">$watch_addr</span></font></font></p>
		</td>
		<td width="96" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt">不支持</font></p>
		</td>
		<td width="102" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt">不支持</font></p>
		</td>
		<td width="97" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt">不支持</font></p>
		</td>
		<td width="101" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt">这个</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">watch
			tracepoint</span></font></font><font size="3" style="font-size: 12pt">监视的地址。</font></p>
		</td>
		<td width="100" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt">不支持</font></p>
		</td>
		<td width="111" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: 1px solid #000000; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0.1cm">
			<p align="left"><font size="3" style="font-size: 12pt">这个</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">watch
			tracepoint</span></font></font><font size="3" style="font-size: 12pt">监视的地址。</font></p>
		</td>
	</tr>
	<tr valign="top">
		<td width="127" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">$watch_val</span></font></font></p>
		</td>
		<td width="96" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt">不支持</font></p>
		</td>
		<td width="102" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt">不支持</font></p>
		</td>
		<td width="97" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt">不支持</font></p>
		</td>
		<td width="101" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt">这个</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">watch
			tracepoint</span></font></font><font size="3" style="font-size: 12pt">监视的内存的当前值。</font></p>
		</td>
		<td width="100" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt">不支持</font></p>
		</td>
		<td width="111" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: 1px solid #000000; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0.1cm">
			<p align="left"><font size="3" style="font-size: 12pt">这个</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">watch
			tracepoint</span></font></font><font size="3" style="font-size: 12pt">监视的内存的当前值。</font></p>
		</td>
	</tr>
	<tr valign="top">
		<td width="127" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">$watch_prev_val</span></font></font></p>
		</td>
		<td width="96" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt">不支持</font></p>
		</td>
		<td width="102" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt">不支持</font></p>
		</td>
		<td width="97" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt">不支持</font></p>
		</td>
		<td width="101" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt">这个</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">watch
			tracepoint</span></font></font><font size="3" style="font-size: 12pt">监视的内存的修改前值。</font></p>
		</td>
		<td width="100" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt">不支持</font></p>
		</td>
		<td width="111" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: 1px solid #000000; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0.1cm">
			<p align="left"><font size="3" style="font-size: 12pt">这个</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">watch
			tracepoint</span></font></font><font size="3" style="font-size: 12pt">监视的内存的修改前值。</font></p>
		</td>
	</tr>
	<tr valign="top">
		<td width="127" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">$watch_count</span></font></font></p>
		</td>
		<td width="96" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt">不支持</font></p>
		</td>
		<td width="102" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt">不支持</font></p>
		</td>
		<td width="97" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt">不支持</font></p>
		</td>
		<td width="101" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt">不支持</font></p>
		</td>
		<td width="100" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0cm">
			<p align="left"><font size="3" style="font-size: 12pt">不支持</font></p>
		</td>
		<td width="111" style="border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: 1px solid #000000; padding-top: 0cm; padding-bottom: 0.1cm; padding-left: 0.1cm; padding-right: 0.1cm">
			<p align="left"><font size="3" style="font-size: 12pt">这个</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">watch
			tracepoint</span></font></font><font size="3" style="font-size: 12pt">会话的一个特殊计数</font><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ID</span></font></font><font size="3" style="font-size: 12pt">。</font></p>
		</td>
	</tr>
</table>
<p align="left"><br><br>
</p>
<p align="left"><br><br>
</p>
<h3 class="cjk" style="page-break-before: always"><a name="__RefHeading__9861_1050592842"></a>
静态<font face="DejaVu Serif, serif"><span lang="en-US">watch
tracepoint</span></font></h3>
<p align="left">当你要监视全局变量或者可以取得地址的变量的值的时候，你可以使用静态<font face="DejaVu Serif, serif"><span lang="en-US">watch
tracepoint</span></font>。下面是一个监视<font face="DejaVu Serif, serif"><span lang="en-US">jiffies_64</span></font>写的例子<font face="DejaVu Serif, serif"><span lang="en-US">:</span></font></p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#</i></span></font>静态<font face="DejaVu Serif, serif"><span lang="en-US"><i>watch
tracepoint</i></span></font>从<font face="DejaVu Serif, serif"><span lang="en-US"><i>tracepoint</i></span></font>的地址中取得要监视的地址</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>trace
*&amp;jiffies_64</i></span></font></blockquote>
<blockquote class="cjk">  <font face="DejaVu Serif, serif"><span lang="en-US"><i>actions</i></span></font></blockquote>
<blockquote class="cjk">    <font face="DejaVu Serif, serif"><span lang="en-US"><i>#Set
this watch tracepoint to static</i></span></font></blockquote>
<blockquote class="cjk">    <font face="DejaVu Serif, serif"><span lang="en-US"><i>teval
$watch_static=1</i></span></font></blockquote>
<blockquote class="cjk">    <font face="DejaVu Serif, serif"><span lang="en-US"><i>#Watch
memory write</i></span></font></blockquote>
<blockquote class="cjk">    <font face="DejaVu Serif, serif"><span lang="en-US"><i>teval
$watch_type=1</i></span></font></blockquote>
<blockquote class="cjk">    <font face="DejaVu Serif, serif"><span lang="en-US"><i>teval
$watch_size=8</i></span></font></blockquote>
<blockquote class="cjk">    <font face="DejaVu Serif, serif"><span lang="en-US"><i>collect
$watch_val</i></span></font></blockquote>
<blockquote class="cjk">    <font face="DejaVu Serif, serif"><span lang="en-US"><i>collect
$watch_prev_val</i></span></font></blockquote>
<blockquote class="cjk">    <font face="DejaVu Serif, serif"><span lang="en-US"><i>collect
$bt</i></span></font></blockquote>
<blockquote class="cjk">  <font face="DejaVu Serif, serif"><span lang="en-US"><i>end</i></span></font></blockquote>
<blockquote class="cjk" style="margin-left: 0cm"><br>
</blockquote>
<h3 class="cjk" style="page-break-before: always"><a name="__RefHeading__11527_1050592842"></a>
动态<font face="DejaVu Serif, serif"><span lang="en-US">watch
tracepoint</span></font></h3>
<p align="left">当你要监视局部变量或者只能在函数中取得地址的变量的值的时候，你可以使用动态<font face="DejaVu Serif, serif"><span lang="en-US">watch
tracepoint</span></font>。下面是一个监视函数<font face="DejaVu Serif, serif"><span lang="en-US">function
get_empty_filp</span></font>中<font face="DejaVu Serif, serif"><span lang="en-US">f-&gt;f_posf-&gt;f_op</span></font>写的例子<font face="DejaVu Serif, serif"><span lang="en-US">:</span></font></p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>trace
*1</i></span></font></blockquote>
<blockquote class="cjk">  <font face="DejaVu Serif, serif"><span lang="en-US"><i>commands</i></span></font></blockquote>
<blockquote class="cjk">    <font face="DejaVu Serif, serif"><span lang="en-US"><i>teval
$watch_static=0</i></span></font></blockquote>
<blockquote class="cjk">    <font face="DejaVu Serif, serif"><span lang="en-US"><i>teval
$watch_type=1</i></span></font></blockquote>
<blockquote class="cjk">    <font face="DejaVu Serif, serif"><span lang="en-US"><i>teval
$watch_size=8</i></span></font></blockquote>
<blockquote class="cjk">    <font face="DejaVu Serif, serif"><span lang="en-US"><i>collect
$bt</i></span></font></blockquote>
<blockquote class="cjk">    <font face="DejaVu Serif, serif"><span lang="en-US"><i>collect
$watch_addr</i></span></font></blockquote>
<blockquote class="cjk">    <font face="DejaVu Serif, serif"><span lang="en-US"><i>collect
$watch_val</i></span></font></blockquote>
<blockquote class="cjk">    <font face="DejaVu Serif, serif"><span lang="en-US"><i>collect
$watch_prev_val</i></span></font></blockquote>
<blockquote class="cjk">  <font face="DejaVu Serif, serif"><span lang="en-US"><i>end</i></span></font></blockquote>
<p align="left">定义了一个动态<font face="DejaVu Serif, serif"><span lang="en-US">watch
tracepoint</span></font>。地址<font face="DejaVu Serif, serif"><span lang="en-US">&quot;1&quot;</span></font>并不是其要监视的地址。其将帮助<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>来找到这个动态<font face="DejaVu Serif, serif"><span lang="en-US">watch
tracepoint</span></font>。</p>
<p align="left"><br><br>
</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>list
get_empty_filp</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>trace
133</i></span></font></blockquote>
<blockquote class="cjk">  <font face="DejaVu Serif, serif"><span lang="en-US"><i>commands</i></span></font></blockquote>
<blockquote class="cjk">    <font face="DejaVu Serif, serif"><span lang="en-US"><i>teval
$watch_set_addr=1</i></span></font></blockquote>
<blockquote class="cjk">    <font face="DejaVu Serif, serif"><span lang="en-US"><i>teval
$watch_size=4</i></span></font></blockquote>
<blockquote class="cjk">    <font face="DejaVu Serif, serif"><span lang="en-US"><i>teval
$watch_start=&amp;(f-&gt;f_pos)</i></span></font></blockquote>
<blockquote class="cjk">    <font face="DejaVu Serif, serif"><span lang="en-US"><i>teval
$watch_size=8</i></span></font></blockquote>
<blockquote class="cjk">    <font face="DejaVu Serif, serif"><span lang="en-US"><i>teval
$watch_start=&amp;(f-&gt;f_op)</i></span></font></blockquote>
<blockquote class="cjk">  <font face="DejaVu Serif, serif"><span lang="en-US"><i>end</i></span></font></blockquote>
<p align="left">在函数<font face="DejaVu Serif, serif"><span lang="en-US">get_empty_filp</span></font>中定义一个普通<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>，其将开始监视<font face="DejaVu Serif, serif"><span lang="en-US">f-&gt;f_pos</span></font>和<font face="DejaVu Serif, serif"><span lang="en-US">f-&gt;f_op</span></font>。</p>
<p align="left"><br><br>
</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>trace
file_sb_list_del</i></span></font></blockquote>
<blockquote class="cjk">  <font face="DejaVu Serif, serif"><span lang="en-US"><i>commands</i></span></font></blockquote>
<blockquote class="cjk">    <font face="DejaVu Serif, serif"><span lang="en-US"><i>teval
$watch_stop=&amp;(file-&gt;f_pos)</i></span></font></blockquote>
<blockquote class="cjk">    <font face="DejaVu Serif, serif"><span lang="en-US"><i>teval
$watch_stop=&amp;(file-&gt;f_op)</i></span></font></blockquote>
<blockquote class="cjk">  <font face="DejaVu Serif, serif"><span lang="en-US"><i>end</i></span></font></blockquote>
<p align="left">在函数<font face="DejaVu Serif, serif"><span lang="en-US">file_sb_list_del</span></font>中定义一个普通<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>，其将停止监视<font face="DejaVu Serif, serif"><span lang="en-US">file-&gt;f_pos</span></font>和<font face="DejaVu Serif, serif"><span lang="en-US">file-&gt;f_op</span></font>。</p>
<p align="left"><br><br>
</p>
<h2 class="cjk" style="page-break-before: always"><a name="__RefHeading__11529_1050592842"></a><a name="使用while-stepping让Linux内核做单步|outline"></a><a name="使用while-stepping让Linux内核做单步|outline"></a>
使用<font face="DejaVu Serif, serif"><span lang="en-US">while-stepping</span></font>让<font face="DejaVu Serif, serif"><span lang="en-US">Linux</span></font>内核做单步</h2>
<p align="left">请 注意 <font face="DejaVu Serif, serif"><span lang="en-US">while-stepping</span></font>现在只有<font face="DejaVu Serif, serif"><span lang="en-US">X86</span></font>和<font face="DejaVu Serif, serif"><span lang="en-US">X86_64</span></font>支持。</p>
<p align="left">介绍使用<font face="DejaVu Serif, serif"><span lang="en-US">while-stepping</span></font>的视频
<font face="DejaVu Serif, serif"><span lang="en-US"><a href="http://www.codepark.us/a/12">http://www.codepark.us/a/12</a></span></font>。</p>
<h3 class="cjk"><a name="__RefHeading__11531_1050592842"></a>如何使用
<font face="DejaVu Serif, serif"><span lang="en-US">while-stepping</span></font></h3>
<p align="left"><font face="DejaVu Serif, serif"><span lang="en-US">while-stepping
</span></font>是一种可以包含<font face="DejaVu Serif, serif"><span lang="en-US">actions</span></font>的特殊<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint
action</span></font>。</p>
<p align="left">当一个<font face="DejaVu Serif, serif"><span lang="en-US">actions</span></font>中包含了“<font face="DejaVu Serif, serif"><span lang="en-US">while-stepping
n”</span></font>的<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>执行的时候，其将做<font face="DejaVu Serif, serif"><span lang="en-US">n</span></font>次单步并执行<font face="DejaVu Serif, serif"><span lang="en-US">while-stepping</span></font>的<font face="DejaVu Serif, serif"><span lang="en-US">actions</span></font>。例如：</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>trace
vfs_read</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#</i></span></font>因为单步会影响系统速度，所以最好用<font face="DejaVu Serif, serif"><span lang="en-US"><i>passcount</i></span></font>或者<font face="DejaVu Serif, serif"><span lang="en-US"><i>condition</i></span></font>限制<font face="DejaVu Serif, serif"><span lang="en-US"><i>tracepoint</i></span></font>的执行次数。</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>passcount
1</i></span></font></blockquote>
<blockquote class="cjk">  <font face="DejaVu Serif, serif"><span lang="en-US"><i>commands</i></span></font></blockquote>
<blockquote class="cjk">    <font face="DejaVu Serif, serif"><span lang="en-US"><i>collect
$bt</i></span></font></blockquote>
<blockquote class="cjk">    <font face="DejaVu Serif, serif"><span lang="en-US"><i>collect
$step_count</i></span></font></blockquote>
<blockquote class="cjk">    <font face="DejaVu Serif, serif"><span lang="en-US"><i>#</i></span></font>做<font face="DejaVu Serif, serif"><span lang="en-US"><i>2000</i></span></font>次单步。</blockquote>
<blockquote class="cjk">    <font face="DejaVu Serif, serif"><span lang="en-US"><i>while-stepping
2000</i></span></font></blockquote>
<blockquote class="cjk">      <font face="DejaVu Serif, serif"><span lang="en-US"><i>#</i></span></font>下面这部分是<font face="DejaVu Serif, serif"><span lang="en-US"><i>&quot;while-stepping
2000&quot;</i></span></font>的<font face="DejaVu Serif, serif"><span lang="en-US"><i>actions</i></span></font>。</blockquote>
<blockquote class="cjk">      <font face="DejaVu Serif, serif"><span lang="en-US"><i>#</i></span></font>因为单步可能会执行到其他函数，所以最好不要访问局部变量。</blockquote>
<blockquote class="cjk">      <font face="DejaVu Serif, serif"><span lang="en-US"><i>collect
$bt</i></span></font></blockquote>
<blockquote class="cjk">      <font face="DejaVu Serif, serif"><span lang="en-US"><i>collect
$step_count</i></span></font></blockquote>
<blockquote class="cjk">    <font face="DejaVu Serif, serif"><span lang="en-US"><i>end</i></span></font></blockquote>
<blockquote class="cjk">  <font face="DejaVu Serif, serif"><span lang="en-US"><i>end</i></span></font></blockquote>
<p align="left">请 <b>注意</b> <font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>在执行单步的时候会关闭当前<font face="DejaVu Serif, serif"><span lang="en-US">CPU</span></font>的中断。
在<font face="DejaVu Serif, serif"><span lang="en-US">actions</span></font>中访问
<font face="DejaVu Serif, serif"><span lang="en-US"><b>$step_count</b>
</span></font>将得到从<font face="DejaVu Serif, serif"><span lang="en-US">1</span></font>开始的这步的计数。</p>
<p align="left"><br><br>
</p>
<h3 class="cjk" style="page-break-before: always"><a name="__RefHeading__11533_1050592842"></a>
读<font face="DejaVu Serif, serif"><span lang="en-US">while-stepping</span></font>的<font face="DejaVu Serif, serif"><span lang="en-US">traceframe</span></font></h3>
<p align="left">不同<font face="DejaVu Serif, serif"><span lang="en-US">step</span></font>的数据将会被记录到不同的<font face="DejaVu Serif, serif"><span lang="en-US">traceframe</span></font>中，你可以用<font face="DejaVu Serif, serif"><span lang="en-US">tfind
(</span></font><a href="#用tfind选择trace帧缓存里面的条目|outline">用<font face="DejaVu Serif, serif"><span lang="en-US">tfind</a></span></font><a href="#用tfind选择trace帧缓存里面的条目|outline">选择<font face="DejaVu Serif, serif"><span lang="en-US">trace</a></span></font><a href="#用tfind选择trace帧缓存里面的条目|outline">帧缓存里面的条目</a><font face="DejaVu Serif, serif"><span lang="en-US">)
</span></font>选择他们。</p>
<p align="left">或者你可以将<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>切换到回放模式，这样<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>可以用执行和反向执行命令选择一个<font face="DejaVu Serif, serif"><span lang="en-US">while-stepping
tracepoint</span></font>的<font face="DejaVu Serif, serif"><span lang="en-US">traceframe</span></font>。例如：</p>
<p align="left"><br><br>
</p>
<p align="left">用<font face="DejaVu Serif, serif"><span lang="en-US">tfind</span></font>选择一个<font face="DejaVu Serif, serif"><span lang="en-US">while-stepping</span></font>的<font face="DejaVu Serif, serif"><span lang="en-US">traceframe</span></font>。</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
tfind </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Found
trace frame 0, tracepoint 1</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#0
 vfs_read (file=0xffff8801f7bd4c00, buf=0x7fff74e4edb0 &lt;Address
0x7fff74e4edb0 out of bounds&gt;, count=16, </i></span></font>
</blockquote>
<blockquote class="cjk">    <font face="DejaVu Serif, serif"><span lang="en-US"><i>pos=0xffff8801f4b45f48)
at /build/buildd/linux-3.2.0/fs/read_write.c:365</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>365
    {</i></span></font></blockquote>
<p align="left"><br><br>
</p>
<p align="left">下面的命令将切换<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>到回放模式。</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
monitor replay</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
tfind -1</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>No
longer looking at any trace frame</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#0
 vfs_read (file=0xffff8801f7bd4c00, buf=0x7fff74e4edb0 &lt;Address
0x7fff74e4edb0 out of bounds&gt;, count=16, </i></span></font>
</blockquote>
<blockquote class="cjk">    <font face="DejaVu Serif, serif"><span lang="en-US"><i>pos=0xffff8801f4b45f48)
at /build/buildd/linux-3.2.0/fs/read_write.c:365</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>365
    {</i></span></font></blockquote>
<p align="left"><br><br>
</p>
<p align="left">于是可以使用执行命令。</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
n</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>368
            if (!(file-&gt;f_mode &amp; FMODE_READ))</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
p file-&gt;f_mode</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>$5
= 3</i></span></font></blockquote>
<p align="left"><br><br>
</p>
<p align="left">设置断点 <font face="DejaVu Serif, serif"><span lang="en-US">(</span></font>只在回放模式下有效，不会影响到<font face="DejaVu Serif, serif"><span lang="en-US">Linux</span></font>内核执行<font face="DejaVu Serif, serif"><span lang="en-US">)</span></font>。</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
b 375</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Breakpoint
2 at 0xffffffff81179b75: file
/build/buildd/linux-3.2.0/fs/read_write.c, line 375.</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
c</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Continuing.</i></span></font></blockquote>
<blockquote class="cjk"><br>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Breakpoint
2, vfs_read (file=0xffff8801f7bd4c00, buf=0x7fff74e4edb0 &lt;Address
0x7fff74e4edb0 out of bounds&gt;, count=16, </i></span></font>
</blockquote>
<blockquote class="cjk">    <font face="DejaVu Serif, serif"><span lang="en-US"><i>pos=0xffff8801f4b45f48)
at /build/buildd/linux-3.2.0/fs/read_write.c:375</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>375
            ret = rw_verify_area(READ, file, pos, count);</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
s</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>rw_verify_area
(read_write=0, file=0xffff8801f7bd4c00, ppos=0xffff8801f4b45f48,
count=16)</i></span></font></blockquote>
<blockquote class="cjk">    <font face="DejaVu Serif, serif"><span lang="en-US"><i>at
/build/buildd/linux-3.2.0/fs/read_write.c:300</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>300
            inode = file-&gt;f_path.dentry-&gt;d_inode;</i></span></font></blockquote>
<blockquote class="cjk" style="margin-left: 0cm"><br>
</blockquote>
<p align="left">使用反向执行命令。</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
rs</i></span></font></blockquote>
<blockquote class="cjk"><br>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Breakpoint
2, vfs_read (file=0xffff8801f7bd4c00, buf=0x7fff74e4edb0 &lt;Address
0x7fff74e4edb0 out of bounds&gt;, count=16, </i></span></font>
</blockquote>
<blockquote class="cjk">    <font face="DejaVu Serif, serif"><span lang="en-US"><i>pos=0xffff8801f4b45f48)
at /build/buildd/linux-3.2.0/fs/read_write.c:375</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>375
            ret = rw_verify_area(READ, file, pos, count);</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
rn</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>372
            if (unlikely(!access_ok(VERIFY_WRITE, buf, count)))</i></span></font></blockquote>
<blockquote class="cjk" style="margin-left: 0cm"><br>
</blockquote>
<p align="left"><font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>命令<font face="DejaVu Serif, serif"><span lang="en-US">tstart</span></font>，<font face="DejaVu Serif, serif"><span lang="en-US">tstop</span></font>，<font face="DejaVu Serif, serif"><span lang="en-US">tfind</span></font>或者<font face="DejaVu Serif, serif"><span lang="en-US">quit</span></font>可以自动关闭回放模式。</p>
<p align="left"><br><br>
</p>
<h2 class="cjk" style="page-break-before: always"><a name="__RefHeading__11535_1050592842"></a>
如何显示被优化掉的变量值</h2>
<p align="left">有时<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>会这样输出信息：</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>inode
has been optimized out of existence.</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>res
has been optimized out of existence.</i></span></font></blockquote>
<p align="left">这是因为<font face="DejaVu Serif, serif"><span lang="en-US">inode</span></font>和<font face="DejaVu Serif, serif"><span lang="en-US">res</span></font>的值被优化掉了。内核用<font face="DejaVu Serif, serif"><span lang="en-US">-O2</span></font>编译的所以你有时会碰到这个问题。</p>
<p align="left">有两个方法处理这个问题：</p>
<h3 class="cjk"><a name="__RefHeading__11537_1050592842"></a>升级你的<font face="DejaVu Serif, serif"><span lang="en-US">GCC</span></font></h3>
<p align="left"><font face="DejaVu Serif, serif"><span lang="en-US">VTA
branch <a href="http://gcc.gnu.org/wiki/Var_Tracking_Assignments">http://gcc.gnu.org/wiki/Var_Tracking_Assignments</a>
</span></font>已经整合进<font face="DejaVu Serif, serif"><span lang="en-US">GCC
4.5</span></font>，其可以帮助生成之前被标记为<font face="DejaVu Serif, serif"><span lang="en-US">&quot;optimized
out&quot;</span></font>的值的调试信息。</p>
<p align="left"><br><br>
</p>
<h3 class="cjk" style="page-break-before: always"><a name="__RefHeading__11539_1050592842"></a>
通过分析汇编代码取得访问被优化掉变量的方法</h3>
<p align="left">即使升级了<font face="DejaVu Serif, serif"><span lang="en-US">GCC</span></font>，你可能还会遇到问题。主要原因是数据在寄存器中但是<font face="DejaVu Serif, serif"><span lang="en-US">GCC</span></font>没有把信息放到调试信息中。所以<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>只能显示这个变量被又优化掉了。</p>
<p align="left">但你可以通过分析汇编代码取得这个变量在哪并在<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint
actions</span></font>中访问其。</p>
<p align="left">下面是一个在函数<font face="DejaVu Serif, serif"><span lang="en-US">get_empty_filp</span></font>中寻找变量<font face="DejaVu Serif, serif"><span lang="en-US">&quot;f&quot;</span></font>并在<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint
actions</span></font>中使用其的例子：</p>
<p align="left">我们想<font face="DejaVu Serif, serif"><span lang="en-US">collect</span></font>变量<font face="DejaVu Serif, serif"><span lang="en-US">f</span></font>的值，但是其已经被优化掉了。</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
list get_empty_filp</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>...</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>...</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>...</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>137
            INIT_LIST_HEAD(&amp;f-&gt;f_u.fu_list);</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>138
            atomic_long_set(&amp;f-&gt;f_count, 1);</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>139
            rwlock_init(&amp;f-&gt;f_owner.lock);</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>140
            spin_lock_init(&amp;f-&gt;f_lock);</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>141
            eventpoll_init_file(f);</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
</i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>142
            /* f-&gt;f_version: 0 */</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>143
            return f;</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
trace 143</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Tracepoint
1 at 0xffffffff8119b30e: file fs/file_table.c, line 143.</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
actions </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Enter
actions for tracepoint 1, one per line.</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>End
with a line saying just &quot;end&quot;.</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;collect
f</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>`f'
is optimized away and cannot be collected.</i></span></font></blockquote>
<blockquote class="cjk" style="margin-left: 0cm"><br>
</blockquote>
<p align="left">现在用<font face="DejaVu Serif, serif"><span lang="en-US">&quot;disassemble
/m&quot;</span></font>命令取得和<font face="DejaVu Serif, serif"><span lang="en-US">&quot;f&quot;</span></font>有关的汇编代码和源码并分析他们。</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
disassemble /m get_empty_filp</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>...</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>...</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>...</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>125
            f = kmem_cache_zalloc(filp_cachep, GFP_KERNEL);</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>126
            if (unlikely(!f))</i></span></font></blockquote>
<blockquote class="cjk">   <font face="DejaVu Serif, serif"><span lang="en-US"><i>0xffffffff8119b28c
&lt;+92&gt;:    test   %rax,%rax</i></span></font></blockquote>
<blockquote class="cjk">   <font face="DejaVu Serif, serif"><span lang="en-US"><i>0xffffffff8119b292
&lt;+98&gt;:    je     0xffffffff8119b362 &lt;get_empty_filp+306&gt;</i></span></font></blockquote>
<blockquote class="cjk"><br>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>127
                    return ERR_PTR(-ENOMEM);</i></span></font></blockquote>
<blockquote class="cjk">   <font face="DejaVu Serif, serif"><span lang="en-US"><i>0xffffffff8119b362
&lt;+306&gt;:   mov    $0xfffffffffffffff4,%rax</i></span></font></blockquote>
<blockquote class="cjk">   <font face="DejaVu Serif, serif"><span lang="en-US"><i>0xffffffff8119b369
&lt;+313&gt;:   jmp    0xffffffff8119b311 &lt;get_empty_filp+225&gt;</i></span></font></blockquote>
<blockquote class="cjk" style="margin-left: 0cm"><br>
</blockquote>
<p align="left">因为<font face="DejaVu Serif, serif"><span lang="en-US">&quot;+98&quot;</span></font>到<font face="DejaVu Serif, serif"><span lang="en-US">&quot;+132&quot;</span></font>的代码因为属于<font face="DejaVu Serif, serif"><span lang="en-US">inline</span></font>函数所以没有在这里显示，但是你可以用<font face="DejaVu Serif, serif"><span lang="en-US">&quot;disassemble
get_empty_filp&quot;</span></font>取得他们。</p>
<blockquote class="cjk">   <font face="DejaVu Serif, serif"><span lang="en-US"><i>0xffffffff8119b287
&lt;+87&gt;:    callq  0xffffffff81181cb0 &lt;kmem_cache_alloc&gt;</i></span></font></blockquote>
<blockquote class="cjk">   <font face="DejaVu Serif, serif"><span lang="en-US"><i>0xffffffff8119b28c
&lt;+92&gt;:    test   %rax,%rax</i></span></font></blockquote>
<blockquote class="cjk">   <font face="DejaVu Serif, serif"><span lang="en-US"><i>0xffffffff8119b28f
&lt;+95&gt;:    mov    %rax,%rbx</i></span></font></blockquote>
<blockquote class="cjk">   <font face="DejaVu Serif, serif"><span lang="en-US"><i>0xffffffff8119b292
&lt;+98&gt;:    je     0xffffffff8119b362 &lt;get_empty_filp+306&gt;</i></span></font></blockquote>
<blockquote class="cjk">   <font face="DejaVu Serif, serif"><span lang="en-US"><i>0xffffffff8119b298
&lt;+104&gt;:   mov    0xb4d406(%rip),%edx        #
0xffffffff81ce86a4 &lt;percpu_counter_batch&gt;</i></span></font></blockquote>
<blockquote class="cjk">   <font face="DejaVu Serif, serif"><span lang="en-US"><i>0xffffffff8119b29e
&lt;+110&gt;:   mov    $0x1,%esi</i></span></font></blockquote>
<blockquote class="cjk">   <font face="DejaVu Serif, serif"><span lang="en-US"><i>0xffffffff8119b2a3
&lt;+115&gt;:   mov    $0xffffffff81c05340,%rdi</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>---Type
&lt;return&gt; to continue, or q &lt;return&gt; to quit---</i></span></font></blockquote>
<blockquote class="cjk">   <font face="DejaVu Serif, serif"><span lang="en-US"><i>0xffffffff8119b2aa
&lt;+122&gt;:   callq  0xffffffff8130dd20 &lt;__percpu_counter_add&gt;</i></span></font></blockquote>
<p align="left">根据汇编代码你可以看到<font face="DejaVu Serif, serif"><span lang="en-US">kmem_cache_alloc</span></font>的返回值在<font face="DejaVu Serif, serif"><span lang="en-US">$rax</span></font>中，其的值被设置到了<font face="DejaVu Serif, serif"><span lang="en-US">$rbx</span></font>中。</p>
<p align="left">看起来<font face="DejaVu Serif, serif"><span lang="en-US">$rbx</span></font>有<font face="DejaVu Serif, serif"><span lang="en-US">&quot;f&quot;</span></font>的值，让我们看其他的汇编代码。</p>
<p align="left"><br><br>
</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>128
    </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>129
            percpu_counter_inc(&amp;nr_files);</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>130
            f-&gt;f_cred = get_cred(cred);</i></span></font></blockquote>
<blockquote class="cjk">   <font face="DejaVu Serif, serif"><span lang="en-US"><i>0xffffffff8119b2b4
&lt;+132&gt;:   mov    %r12,0x70(%rbx)</i></span></font></blockquote>
<p align="left">设置一个值到<font face="DejaVu Serif, serif"><span lang="en-US">f</span></font>的元素中。汇编代码是设置<font face="DejaVu Serif, serif"><span lang="en-US">$r12</span></font>的值到以<font face="DejaVu Serif, serif"><span lang="en-US">$rbx</span></font>为基础地址的内存中。其让<font face="DejaVu Serif, serif"><span lang="en-US">$rbx</span></font>看起来是<font face="DejaVu Serif, serif"><span lang="en-US">&quot;f&quot;</span></font>。</p>
<p align="left"><br><br>
</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>131
            error = security_file_alloc(f);</i></span></font></blockquote>
<blockquote class="cjk">   <font face="DejaVu Serif, serif"><span lang="en-US"><i>0xffffffff8119b2b8
&lt;+136&gt;:   mov    %rbx,%rdi</i></span></font></blockquote>
<blockquote class="cjk">   <font face="DejaVu Serif, serif"><span lang="en-US"><i>0xffffffff8119b2bb
&lt;+139&gt;:   callq  0xffffffff8128ee30 &lt;security_file_alloc&gt;</i></span></font></blockquote>
<blockquote class="cjk"><br>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>132
            if (unlikely(error)) {</i></span></font></blockquote>
<blockquote class="cjk">   <font face="DejaVu Serif, serif"><span lang="en-US"><i>0xffffffff8119b2c0
&lt;+144&gt;:   test   %eax,%eax</i></span></font></blockquote>
<blockquote class="cjk">   <font face="DejaVu Serif, serif"><span lang="en-US"><i>0xffffffff8119b2c2
&lt;+146&gt;:   jne    0xffffffff8119b36b &lt;get_empty_filp+315&gt;</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>---Type
&lt;return&gt; to continue, or q &lt;return&gt; to quit---</i></span></font></blockquote>
<blockquote class="cjk"><br>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>133
                    file_free(f);</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>134
                    return ERR_PTR(error);</i></span></font></blockquote>
<blockquote class="cjk">   <font face="DejaVu Serif, serif"><span lang="en-US"><i>0xffffffff8119b393
&lt;+355&gt;:   movslq -0x14(%rbp),%rax</i></span></font></blockquote>
<blockquote class="cjk">   <font face="DejaVu Serif, serif"><span lang="en-US"><i>0xffffffff8119b397
&lt;+359&gt;:   jmpq   0xffffffff8119b311 &lt;get_empty_filp+225&gt;</i></span></font></blockquote>
<blockquote class="cjk"><br>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>135
            }</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>136
    </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>137
            INIT_LIST_HEAD(&amp;f-&gt;f_u.fu_list);</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>138
            atomic_long_set(&amp;f-&gt;f_count, 1);</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>139
            rwlock_init(&amp;f-&gt;f_owner.lock);</i></span></font></blockquote>
<blockquote class="cjk">   <font face="DejaVu Serif, serif"><span lang="en-US"><i>0xffffffff8119b2e4
&lt;+180&gt;:   movl   $0x100000,0x50(%rbx)</i></span></font></blockquote>
<blockquote class="cjk"><br>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>140
            spin_lock_init(&amp;f-&gt;f_lock);</i></span></font></blockquote>
<blockquote class="cjk">   <font face="DejaVu Serif, serif"><span lang="en-US"><i>0xffffffff8119b2c8
&lt;+152&gt;:   xor    %eax,%eax</i></span></font></blockquote>
<blockquote class="cjk">   <font face="DejaVu Serif, serif"><span lang="en-US"><i>0xffffffff8119b2d1
&lt;+161&gt;:   mov    %ax,0x30(%rbx)</i></span></font></blockquote>
<blockquote class="cjk"><br>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>141
            eventpoll_init_file(f);</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>142
            /* f-&gt;f_version: 0 */</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>143
            return f;</i></span></font></blockquote>
<blockquote class="cjk">   <font face="DejaVu Serif, serif"><span lang="en-US"><i>0xffffffff8119b30e
&lt;+222&gt;:   mov    %rbx,%rax</i></span></font></blockquote>
<p align="left">在检查了其他汇编代码后，你可以确定<font face="DejaVu Serif, serif"><span lang="en-US">$rbx</span></font>就是<font face="DejaVu Serif, serif"><span lang="en-US">&quot;f&quot;</span></font>。</p>
<p align="left"><br><br>
</p>
<p align="left">于是你可以在<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint
actions</span></font>中通过访问<font face="DejaVu Serif, serif"><span lang="en-US">$rbx</span></font>而访问<font face="DejaVu Serif, serif"><span lang="en-US">&quot;f&quot;</span></font>，例如：</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
trace 143</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Tracepoint
1 at 0xffffffff8119b30e: file fs/file_table.c, line 143.</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
actions </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Enter
actions for tracepoint 1, one per line.</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>End
with a line saying just &quot;end&quot;.</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#collect
f</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;collect
$rbx</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#collect
*f</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;collect
*((struct file *)$rbx)</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#collect
f-&gt;f_op</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;collect
((struct file *)$rbx)-&gt;f_op</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;end</i></span></font></blockquote>
<blockquote class="cjk" style="margin-left: 0cm"><br>
</blockquote>
<h2 class="cjk" style="page-break-before: always"><a name="__RefHeading__11541_1050592842"></a>
如何取得函数指针指向的函数</h2>
<h3 class="cjk"><a name="__RefHeading__11543_1050592842"></a>如果函数指针没有被优化掉</h3>
<p align="left">你可以直接<font face="DejaVu Serif, serif"><span lang="en-US">collect</span></font>这个指针，例如：</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>377
                    count = ret;</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>378
                    if (file-&gt;f_op-&gt;read)</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>379
                            ret = file-&gt;f_op-&gt;read(file, buf,
count, pos);</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
</i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
trace 379</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Tracepoint
1 at 0xffffffff81173ba5: file
/home/teawater/kernel/linux/fs/read_write.c, line 379.</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
actions </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Enter
actions for tracepoint 1, one per line.</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>End
with a line saying just &quot;end&quot;.</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;collect
file-&gt;f_op-&gt;read</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;end</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
tstart</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
tstop</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
tfind</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
p file-&gt;f_op-&gt;read</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>$5
= (ssize_t (*)(struct file *, char *, size_t, loff_t *))
0xffffffff81173190 &lt;do_sync_read&gt;</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#</i></span></font>于是就知道<font face="DejaVu Serif, serif"><span lang="en-US"><i>file-&gt;f_op-&gt;read</i></span></font>指向<font face="DejaVu Serif, serif"><span lang="en-US"><i>do_sync_read</i></span></font>。</blockquote>
<blockquote class="cjk" style="margin-left: 0cm"><br>
</blockquote>
<h3 class="cjk" style="page-break-before: always"><a name="__RefHeading__11545_1050592842"></a>
如果函数指针被优化掉了</h3>
<p align="left">可以用<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint
step</span></font>处理这个问题，例如：</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#</i></span></font>找到调用指针的指令</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
disassemble /rm vfs_read</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>379
                            ret = file-&gt;f_op-&gt;read(file, buf,
count, pos);</i></span></font></blockquote>
<blockquote class="cjk">   <font face="DejaVu Serif, serif"><span lang="en-US"><i>0xffffffff81173ba5
&lt;+181&gt;:   48 89 da        mov    %rbx,%rdx</i></span></font></blockquote>
<blockquote class="cjk">   <font face="DejaVu Serif, serif"><span lang="en-US"><i>0xffffffff81173ba8
&lt;+184&gt;:   4c 89 e9        mov    %r13,%rcx</i></span></font></blockquote>
<blockquote class="cjk">   <font face="DejaVu Serif, serif"><span lang="en-US"><i>0xffffffff81173bab
&lt;+187&gt;:   4c 89 e6        mov    %r12,%rsi</i></span></font></blockquote>
<blockquote class="cjk">   <font face="DejaVu Serif, serif"><span lang="en-US"><i>0xffffffff81173bae
&lt;+190&gt;:   4c 89 f7        mov    %r14,%rdi</i></span></font></blockquote>
<blockquote class="cjk">   <font face="DejaVu Serif, serif"><span lang="en-US"><i>0xffffffff81173bb1
&lt;+193&gt;:   ff d0   callq  *%rax</i></span></font></blockquote>
<blockquote class="cjk">   <font face="DejaVu Serif, serif"><span lang="en-US"><i>0xffffffff81173bb3
&lt;+195&gt;:   48 89 c3        mov    %rax,%rbx</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
trace *0xffffffff81173bb1</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Tracepoint
1 at 0xffffffff81173bb1: file
/home/teawater/kernel/linux/fs/read_write.c, line 379.</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
actions </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Enter
actions for tracepoint 1, one per line.</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>End
with a line saying just &quot;end&quot;.</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;while-stepping
1</i></span></font></blockquote>
<blockquote class="cjk"> <font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;collect
$reg</i></span></font></blockquote>
<blockquote class="cjk"> <font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;end</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;end</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
tstart </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
tstop </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
tfind </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#0
 tty_read (file=0xffff88006ca74900, buf=0xb6b7dc &lt;Address 0xb6b7dc
out of bounds&gt;, count=8176, </i></span></font>
</blockquote>
<blockquote class="cjk">    <font face="DejaVu Serif, serif"><span lang="en-US"><i>ppos=0xffff88006e197f48)
at /home/teawater/kernel/linux/drivers/tty/tty_io.c:960</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>960
    {</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#</i></span></font>于是就知道<font face="DejaVu Serif, serif"><span lang="en-US"><i>file-&gt;f_op-&gt;read</i></span></font>指向<font face="DejaVu Serif, serif"><span lang="en-US"><i>tty_read</i></span></font>。</blockquote>
<p align="left">请 <b>注意</b> <font face="DejaVu Serif, serif"><span lang="en-US">while-stepping
</span></font>将让<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>不能使用<font face="DejaVu Serif, serif"><span lang="en-US">kprobes-optimization</span></font>。</p>
<p align="left"><br><br>
</p>
<h2 class="cjk" style="page-break-before: always"><a name="__RefHeading__11547_1050592842"></a><a name="/sys/kernel/debug/gtpframe和离线调试|outline"></a>
<font face="DejaVu Serif, serif"><span lang="en-US">/sys/kernel/debug/gtpframe</span></font>和离线调试</h2>
<p align="left"><font face="DejaVu Serif, serif"><span lang="en-US">/sys/kernel/debug/gtpframe</span></font>是一个当<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>停止时的<font face="DejaVu Serif, serif"><span lang="en-US">tfine</span></font>格式（<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>可以读取它）的接口。</p>
<p align="left"><br><br>
</p>
<p align="left">在运行<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>的主机上：</p>
<p align="left">改变 <font face="DejaVu Serif, serif"><span lang="en-US">&quot;target
remote XXXX&quot; </span></font>为：</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
target remote | perl ./getgtprsp.pl</i></span></font></blockquote>
<p align="left"><br><br>
</p>
<p align="left">之后像平时一样设置<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>：</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
trace vfs_readdir</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Tracepoint
1 at 0xffffffff8114f3c0: file
/home/teawater/kernel/linux-2.6/fs/readdir.c, line 24.</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
actions </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Enter
actions for tracepoint 1, one per line.</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>End
with a line saying just &quot;end&quot;.</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#If
your GDB support tracepoint &quot;printf&quot; (see &quot;Howto use
tracepoint printf&quot;), use it to show the value directly is
better.</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;collect
$reg</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;end</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
tstart </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
stop </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
quit</i></span></font></blockquote>
<blockquote class="cjk" style="margin-left: 0cm"><br>
</blockquote>
<p align="left">于是你可以在当前目录找到文件<font face="DejaVu Serif, serif"><span lang="en-US">gtpstart</span></font>和<font face="DejaVu Serif, serif"><span lang="en-US">gtpstop</span></font>，把他们拷贝到你想调试的主机上。</p>
<p align="left"><br><br>
</p>
<p align="left">在被调试主机上，先拷贝<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>目录中的程序<font face="DejaVu Serif, serif"><span lang="en-US">&quot;putgtprsp&quot;</span></font>和<font face="DejaVu Serif, serif"><span lang="en-US">&quot;gtp.ko&quot;</span></font>到这台机器上。<font face="DejaVu Serif, serif"><span lang="en-US">insmod
gtp.ko</span></font>之后：</p>
<p align="left">启动<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>：</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>./putgtprsp
./gtpstart</i></span></font></blockquote>
<p align="left">停止<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>：</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>./putgtprsp
./gtpstop</i></span></font></blockquote>
<p align="left"><br><br>
</p>
<p align="left">可以按照<a href="#如何让tracepoint直接输出信息|outline">如何让<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</a></span></font><a href="#如何让tracepoint直接输出信息|outline">直接输出信息</a>直接在板子上显示信息。</p>
<p align="left"><br><br>
</p>
<p align="left">如果要保存<font face="DejaVu Serif, serif"><span lang="en-US">trace</span></font>帧之后再分析，你可以拷贝文件<font face="DejaVu Serif, serif"><span lang="en-US">&quot;/sys/kernel/debug/gtpframe&quot;</span></font>到有<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>的主机上。</p>
<p align="left">请 <b>注意</b> 有些<font face="DejaVu Serif, serif"><span lang="en-US">&quot;cp&quot;</span></font>不能很好的处理这个问题，可以用<font face="DejaVu Serif, serif"><span lang="en-US">&quot;cat
/sys/kernel/debug/gtpframe &gt; ./gtpframe&quot;</span></font>拷贝它。</p>
<p align="left">在运行<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>的主机上：</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
target tfile ./gtpframe</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Tracepoint
1 at 0xffffffff8114f3dc: file
/home/teawater/kernel/linux-2.6/fs/readdir.c, line 24.</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Created
tracepoint 1 for target's tracepoint 1 at 0xffffffff8114f3c0.</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
tfind </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Found
trace frame 0, tracepoint 1</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#0
 vfs_readdir (file=0xffff880036e8f300, filler=0xffffffff8114f240
&lt;filldir&gt;, buf=0xffff880001e5bf38)</i></span></font></blockquote>
<blockquote class="cjk">    <font face="DejaVu Serif, serif"><span lang="en-US"><i>at
/home/teawater/kernel/linux-2.6/fs/readdir.c:24</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>24
     {</i></span></font></blockquote>
<blockquote class="cjk" style="margin-left: 0cm"><br>
</blockquote>
<p align="left">请 <b>注意</b>
如果你想在使用离线调试后从远程主机上的<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>连接<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>，你需要在调用<font face="DejaVu Serif, serif"><span lang="en-US">&quot;nc&quot;</span></font>之前<font face="DejaVu Serif, serif"><span lang="en-US">&quot;rmmod
gtp&quot;</span></font>和<font face="DejaVu Serif, serif"><span lang="en-US">&quot;insmod
gtp.ko&quot;</span></font>。</p>
<p align="left"><br><br>
</p>
<h2 class="cjk" style="page-break-before: always"><a name="__RefHeading__11549_1050592842"></a>
如何使用 <font face="DejaVu Serif, serif"><span lang="en-US">/sys/kernel/debug/gtpframe_pipe</span></font></h2>
<p align="left">这个接口提供和<font face="DejaVu Serif, serif"><span lang="en-US">&quot;gtpframe&quot;</span></font>同样的数据，但是可以在<font face="DejaVu Serif, serif"><span lang="en-US">KGTP
tracepoint</span></font>运行的时候也可以使用。在数据读出之后，其将自动从<font face="DejaVu Serif, serif"><span lang="en-US">trace</span></font>帧里删除类似<font face="DejaVu Serif, serif"><span lang="en-US">ftrace
&quot;trace_pipe&quot;</span></font>。</p>
<h3 class="cjk"><a name="__RefHeading__11551_1050592842"></a>用<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>读帧信息</h3>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#</i></span></font>连接到接口上</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
target tfile /sys/kernel/debug/gtpframe_pipe</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#</i></span></font>取得一个<font face="DejaVu Serif, serif"><span lang="en-US"><i>trace</i></span></font>帧条目</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
tfind 0</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Found
trace frame 0, tracepoint 1</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#</i></span></font>取得下一个</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
tfind </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Target
failed to find requested trace frame.</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
tfind 0</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Found
trace frame 0, tracepoint 1</i></span></font></blockquote>
<p align="left">这个方法和<font face="DejaVu Serif, serif"><span lang="en-US">python</span></font>一起分析内核比较好，<font face="DejaVu Serif, serif"><span lang="en-US">add-ons/hotcode.py</span></font>就是这样的例子。</p>
<p align="left"><br><br>
</p>
<h3 class="cjk" style="page-break-before: always"><a name="__RefHeading__11553_1050592842"></a>
用<font face="DejaVu Serif, serif"><span lang="en-US">cat</span></font>读帧信息</h3>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>sudo
cat /sys/kernel/debug/gtpframe_pipe &gt; g</i></span></font></blockquote>
<p align="left">于是所有帧信息都被存入了文件<font face="DejaVu Serif, serif"><span lang="en-US">&quot;g&quot;</span></font>。</p>
<p align="left"><br><br>
</p>
<h3 class="cjk" style="page-break-before: always"><a name="__RefHeading__11555_1050592842"></a>
用<font face="DejaVu Serif, serif"><span lang="en-US">getframe</span></font>读帧信息</h3>
<p align="left"><font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>包含一个<font face="DejaVu Serif, serif"><span lang="en-US">&quot;getframe&quot;</span></font>可以用来帮助取得<font face="DejaVu Serif, serif"><span lang="en-US">trace</span></font>帧。</p>
<p align="left">下面这里是它的帮助：</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>getframe
-h</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Get
the trace frame of KGTP and save them in current </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>directory
with tfile format.</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Usage:
./getframe [option]</i></span></font></blockquote>
<blockquote class="cjk"><br>
</blockquote>
<blockquote class="cjk">  <font face="DejaVu Serif, serif"><span lang="en-US"><i>-g
n    Set the minimum free size limit to n G.</i></span></font></blockquote>
<blockquote class="cjk">          <font face="DejaVu Serif, serif"><span lang="en-US"><i>When
free size of current disk is smaller than n G,</i></span></font></blockquote>
<blockquote class="cjk">          <font face="DejaVu Serif, serif"><span lang="en-US"><i>./getframe
will exit (-q) or wait some seconds (-w).</i></span></font></blockquote>
<blockquote class="cjk">          <font face="DejaVu Serif, serif"><span lang="en-US"><i>The
default value of it is 2 G.</i></span></font></blockquote>
<blockquote class="cjk"><br>
</blockquote>
<blockquote class="cjk">  <font face="DejaVu Serif, serif"><span lang="en-US"><i>-q
     Quit when current disk is smaller than</i></span></font></blockquote>
<blockquote class="cjk">          <font face="DejaVu Serif, serif"><span lang="en-US"><i>minimum
free size limit (-g).</i></span></font></blockquote>
<blockquote class="cjk"><br>
</blockquote>
<blockquote class="cjk">  <font face="DejaVu Serif, serif"><span lang="en-US"><i>-w
n    Wait n seconds when current disk is smaller</i></span></font></blockquote>
<blockquote class="cjk">          <font face="DejaVu Serif, serif"><span lang="en-US"><i>than
minimum free size limit (-g).</i></span></font></blockquote>
<blockquote class="cjk"><br>
</blockquote>
<blockquote class="cjk">  <font face="DejaVu Serif, serif"><span lang="en-US"><i>-e
n    Set the entry number of each tfile to n.</i></span></font></blockquote>
<blockquote class="cjk">          <font face="DejaVu Serif, serif"><span lang="en-US"><i>The
default value of it is 1000.</i></span></font></blockquote>
<blockquote class="cjk"><br>
</blockquote>
<blockquote class="cjk">  <font face="DejaVu Serif, serif"><span lang="en-US"><i>-h
     Display this information.</i></span></font></blockquote>
<blockquote class="cjk" style="margin-left: 0cm"><br>
</blockquote>
<h3 class="cjk" style="page-break-before: always"><a name="__RefHeading__11557_1050592842"></a>
使用 <font face="DejaVu Serif, serif"><span lang="en-US">$pipe_trace</span></font></h3>
<p align="left">为了锁安全，<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>默认将自动忽略读<font face="DejaVu Serif, serif"><span lang="en-US">/sys/kernel/debug/gtpframe_pipe</span></font>的任务。</p>
<p align="left">如果你真希望<font face="DejaVu Serif, serif"><span lang="en-US">trace</span></font>这个任务而且确定这是安全的，你可以使用<font face="DejaVu Serif, serif"><span lang="en-US">&quot;tstart&quot;</span></font>之前使用下面的命令：</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
tvariable $pipe_trace=1</i></span></font></blockquote>
<p align="left">于是<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>将不再忽略读<font face="DejaVu Serif, serif"><span lang="en-US">/sys/kernel/debug/gtpframe_pipe</span></font>的任务。</p>
<p align="left"><br><br>
</p>
<h2 class="cjk" style="page-break-before: always"><a name="__RefHeading__11559_1050592842"></a>
和用户程序一起使用<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font></h2>
<p><font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>可以在不停止用户程序的情况下，访问内存和<font face="DejaVu Serif, serif"><span lang="en-US">trace</span></font>这个应用层程序。</p>
<h3 class="cjk"><a name="__RefHeading__5425_673718429"></a>让<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>为访问用户程序而连接<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font></h3>
<p><font face="DejaVu Serif, serif"><span lang="en-US"><b>1)</b> </span></font>在
不装载 任何应用程序的情况下打开<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>。
</p>
<p><font face="DejaVu Serif, serif"><span lang="en-US"><b>2)</b>
</span></font>如果用户程序在本机运行，则使用<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>命令
<font face="DejaVu Serif, serif"><span lang="en-US">&quot;target
extended-remote /sys/kernel/debug/gtp&quot; </span></font>连接<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>。
如果用户程序运行在远程主机上，则使用类似
<a href="#6.0.0.3.如果GDB在远程主机上|outline">如果<font face="DejaVu Serif, serif"><span lang="en-US">GDB</a></span></font><a href="#6.0.0.3.如果GDB在远程主机上|outline">在远程主机上</a>
的方法但是需要将 <font face="DejaVu Serif, serif"><span lang="en-US">&quot;target
remote&quot; </span></font>替换为 <font face="DejaVu Serif, serif"><span lang="en-US">&quot;target
extended-remote&quot;</span></font>。 
</p>
<p><font face="DejaVu Serif, serif"><span lang="en-US"><b>3)</b>
</span></font>用<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>命令
<font face="DejaVu Serif, serif"><span lang="en-US">&quot;file&quot;
</span></font>装载用户程序 <font face="DejaVu Serif, serif"><span lang="en-US">(</span></font>其必须在编译时候增加<font face="DejaVu Serif, serif"><span lang="en-US">GCC</span></font>参数<font face="DejaVu Serif, serif"><span lang="en-US">&quot;-g&quot;</span></font>保证其有调试信息<font face="DejaVu Serif, serif"><span lang="en-US">)</span></font>。
</p>
<p><font face="DejaVu Serif, serif"><span lang="en-US"><b>4)</b>
</span></font>用<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>命令
<font face="DejaVu Serif, serif"><span lang="en-US">&quot;attach pid&quot;
</span></font>来<font face="DejaVu Serif, serif"><span lang="en-US">attach</span></font>上<font face="DejaVu Serif, serif"><span lang="en-US">task</span></font>的<font face="DejaVu Serif, serif"><span lang="en-US">pid</span></font>。</p>
<p><br><br>
</p>
<p>因此让<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>为访问用户程序而连接<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>的步骤将是：
</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>sudo
gdb-release </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
target extended-remote /sys/kernel/debug/gtp </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Remote
debugging using /sys/kernel/debug/gtp </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>0x00000000
in ?? () </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
file a.out </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>A
program is being debugged already. </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Are
you sure you want to change the file? (y or n) y </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Reading
symbols from /home/teawater/kernel/kgtp/a.out...done. </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
attach 15412 </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>A
program is being debugged already.  Kill it? (y or n) y </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Attaching
to program: /home/teawater/kernel/kgtp/a.out, Remote target </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#
</i></span></font>一些版本的<font face="DejaVu Serif, serif"><span lang="en-US"><i>GDB</i></span></font>可能会出现<font face="DejaVu Serif, serif"><span lang="en-US"><i>internal-error</i></span></font>，请回答
<font face="DejaVu Serif, serif"><span lang="en-US"><i>&quot;n&quot;
</i></span></font>来忽略他们。</blockquote>
<blockquote class="cjk" style="margin-left: 0cm"><br>
</blockquote>
<h3 class="cjk" style="page-break-before: always"><a name="__RefHeading__5691_673718429"></a>
直接读用户程序的内存 
</h3>
<p align="left">在<font face="DejaVu Serif, serif"><span lang="en-US">GDB
attach</span></font>用户程序成功后，你可以用<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>命令<font face="DejaVu Serif, serif"><span lang="en-US">&quot;p&quot;</span></font>和<font face="DejaVu Serif, serif"><span lang="en-US">&quot;x&quot;</span></font>访问到这个<font face="DejaVu Serif, serif"><span lang="en-US">task</span></font>的内存。你可以用<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>命令<font face="DejaVu Serif, serif"><span lang="en-US">&quot;help
p&quot;</span></font>和<font face="DejaVu Serif, serif"><span lang="en-US">&quot;help
x&quot;</span></font>取得这两个命令的帮助。例如： 
</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
p c </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>$19
= 4460 </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
p &amp;c </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>$21
= (int *) 0x601048 &lt;c&gt; </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
x 0x601048 </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>0x601048
&lt;c&gt;:   0x00001181</i></span></font>。</blockquote>
<blockquote class="cjk" style="margin-left: 0cm"><br>
</blockquote>
<h3 class="cjk" style="page-break-before: always"><a name="__RefHeading__5693_673718429"></a>
<font face="DejaVu Serif, serif"><span lang="en-US">Trace</span></font>用户程序
</h3>
<p align="left"><font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>用<font face="DejaVu Serif, serif"><span lang="en-US">Linux</span></font>内核功能
<font face="DejaVu Serif, serif"><span lang="en-US"><b>uprobes</b>
</span></font>来<font face="DejaVu Serif, serif"><span lang="en-US">trace</span></font>用户程序，只有<font face="DejaVu Serif, serif"><span lang="en-US">Linux</span></font>内核<font face="DejaVu Serif, serif"><span lang="en-US">3.9</span></font>或者更新版本支持这个功能。
</p>
<p align="left">大部分<font face="DejaVu Serif, serif"><span lang="en-US">Linux</span></font>发行版所使用的内核<font face="DejaVu Serif, serif"><span lang="en-US">(3.9</span></font>或者更新版本<font face="DejaVu Serif, serif"><span lang="en-US">)</span></font>的编译选项都打开了
<font face="DejaVu Serif, serif"><span lang="en-US"><b>uprobes</b> </span></font>。
</p>
<p align="left">如果是自己编译的内核： 
</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Kernel
hacking  ---&gt; </i></span></font>
</blockquote>
<blockquote class="cjk">        <font face="DejaVu Serif, serif"><span lang="en-US"><i>[*]
Tracers  ---&gt; </i></span></font>
</blockquote>
<blockquote class="cjk">                <font face="DejaVu Serif, serif"><span lang="en-US"><i>[*]
  Enable uprobes-based dynamic events </i></span></font>
</blockquote>
<blockquote class="cjk" style="margin-left: 0cm"><br>
</blockquote>
<p align="left">如果当前<font face="DejaVu Serif, serif"><span lang="en-US">Linux</span></font>内核的
<font face="DejaVu Serif, serif"><span lang="en-US"><b>uprobes</b>
</span></font>是打开的，可以在<font face="DejaVu Serif, serif"><span lang="en-US">attach</span></font>上用户程序后根据
<font face="DejaVu Serif, serif"><span lang="en-US"><a href="#GDB tracepoint|outline">GDB
tracepoint</a> </span></font>设置<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>。例如：
</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
trace 14 </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Tracepoint
1 at 0x400662: file /home/teawater/kernel/kgtp-misc/test.c, line 14. </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
actions </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Enter
actions for tracepoint 1, one per line. </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>End
with a line saying just &quot;end&quot;. </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;collect
$bt </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;collect
c </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;end
</i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
tstart </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
tstatus </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Trace
is running on the target. </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Collected
5 trace frames. </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Trace
buffer has 20824428 bytes of 20828160 bytes free (0% full). </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Trace
will stop if GDB disconnects. </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Not
looking at any trace frame. </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
tstop </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
tfind </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Found
trace frame 0, tracepoint 1 </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#0
 main (argc=1, argv=0x7fff5e878368, envp=0x7fff5e878378) at
/home/teawater/kernel/kgtp-misc/test.c:14 </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>14
                     c += 1; </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
bt </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#0
 main (argc=1, argv=0x7fff5e878368, envp=0x7fff5e878378) at
/home/teawater/kernel/kgtp-misc/test.c:14 </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
p c </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>$7
= 36 </i></span></font>
</blockquote>
<blockquote class="cjk" style="margin-left: 0cm"><br>
</blockquote>
<p align="left">请<b>注意</b>即使你只<font face="DejaVu Serif, serif"><span lang="en-US">attach</span></font>了一个<font face="DejaVu Serif, serif"><span lang="en-US">task</span></font>，用户层<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>会在这个用户程序的所有<font face="DejaVu Serif, serif"><span lang="en-US">task</span></font>上上触发。<font face="DejaVu Serif, serif"><span lang="en-US">(</span></font>我认为这是
<font face="DejaVu Serif, serif"><span lang="en-US"><b>uprobes</b>
</span></font>的一个很有趣的特色，所以我没在<font face="DejaVu Serif, serif"><span lang="en-US">KGTP
tracepoint</span></font>中对其进行限制。<font face="DejaVu Serif, serif"><span lang="en-US">)
</span></font>
</p>
<p align="left"><br><br>
</p>
<p align="left">你可以在<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint
conditions</span></font>中增加对<font face="DejaVu Serif, serif"><span lang="en-US">$current_task_pid</span></font>的检查来让<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>只在某<font face="DejaVu Serif, serif"><span lang="en-US">task</span></font>上被触发。下面的例子就是一个设置只在<font face="DejaVu Serif, serif"><span lang="en-US">task
985</span></font>上触发<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>上的例子：
</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
trace 14 </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Tracepoint
1 at 0x400662: file /home/teawater/kernel/kgtp-misc/test.c, line 14. </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
condition $bpnum ($current_task_pid == 985) </i></span></font>
</blockquote>
<p align="left"><br><br>
</p>
<p align="left">同时你还可以在<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint
actions</span></font>中增加<font face="DejaVu Serif, serif"><span lang="en-US">&quot;collect
$current_task_pid&quot;</span></font>来确定哪个<font face="DejaVu Serif, serif"><span lang="en-US">task</span></font>触发了这个<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>。例如：
</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
trace 14 </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Tracepoint
2 at 0x400662: file /home/teawater/kernel/kgtp-misc/test.c, line 14. </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
actions </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Enter
actions for tracepoint 2, one per line. </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>End
with a line saying just &quot;end&quot;. </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;collect
$current_task_pid </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;collect
c </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;end
</i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
tstart </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
tstatus </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Trace
is running on the target. </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Collected
6 trace frames. </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Trace
buffer has 20827776 bytes of 20828160 bytes free (0% full). </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Trace
will stop if GDB disconnects. </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Not
looking at any trace frame. </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
tstop </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
tfind </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Found
trace frame 0, tracepoint 2 </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#0
 main (argc=&lt;unavailable&gt;, argv=&lt;unavailable&gt;,
envp=&lt;unavailable&gt;) at
/home/teawater/kernel/kgtp-misc/test.c:14 </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>14
                     c += 1; </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
p $current_task_pid </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>$2
= 9983 </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
tfind </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Found
trace frame 1, tracepoint 2 </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>14
                     c += 1; </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
p $current_task_pid </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>$3
= 9982 </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
</i></span></font>
</blockquote>
<h3 class="cjk" style="page-break-before: always"><a name="__RefHeading__11563_1050592842"></a>
在<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>收集系统调用的从内核到用户层的的栈信息<font face="DejaVu Serif, serif"><span lang="en-US">(</span></font>可用来做<font face="DejaVu Serif, serif"><span lang="en-US">backtrace)</span></font></h3>
<p align="left"><font face="DejaVu Serif, serif"><span lang="en-US"><b>$current</b>
</span></font>是一个特殊<font face="DejaVu Serif, serif"><span lang="en-US">trace</span></font>状态变量。当一个<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>的<font face="DejaVu Serif, serif"><span lang="en-US">action
</span></font>访问其的时候，<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>将收集当前<font face="DejaVu Serif, serif"><span lang="en-US">task</span></font>的寄存器和内存值而不是内核中的值。</p>
<p align="left">一般来说，<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>通过
<font face="DejaVu Serif, serif"><span lang="en-US"><b>task_pt_regs</b>
</span></font>取得寄存器的值。于是在<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint
actions</span></font>中<font face="DejaVu Serif, serif"><span lang="en-US">collect
<b>$current</b> </span></font>将让<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>访问当前<font face="DejaVu Serif, serif"><span lang="en-US">task</span></font>。例如：</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
actions </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Enter
actions for tracepoint 1, one per line.</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>End
with a line saying just &quot;end&quot;.</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;collect
$current</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;collect
$bt</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;end</i></span></font></blockquote>
<blockquote class="cjk" style="margin-left: 0cm"><br>
</blockquote>
<p align="left">此外，针对一些参数中包含指向当前<font face="DejaVu Serif, serif"><span lang="en-US">TASK</span></font>寄存器指针的特殊函数<font face="DejaVu Serif, serif"><span lang="en-US">(</span></font>例如：<font face="DejaVu Serif, serif"><span lang="en-US">X86</span></font>的<font face="DejaVu Serif, serif"><span lang="en-US">do_IRQ</span></font>函数<font face="DejaVu Serif, serif"><span lang="en-US">)</span></font>，<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>需要从函数的参数中取得寄存器信息。则设置指针到
<font face="DejaVu Serif, serif"><span lang="en-US">$current
</span></font>将让<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>得到其。例如：</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
actions </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Enter
actions for tracepoint 1, one per line.</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>End
with a line saying just &quot;end&quot;.</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;teval
$current=(uint64_t)regs</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;collect
$bt</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;end</i></span></font></blockquote>
<blockquote class="cjk" style="margin-left: 0cm"><br>
</blockquote>
<p align="left"><font face="DejaVu Serif, serif"><span lang="en-US"><b>$current_task_user</b>
</span></font>是一个特殊<font face="DejaVu Serif, serif"><span lang="en-US">trace</span></font>状态变量。当<font face="DejaVu Serif, serif"><span lang="en-US">current
task </span></font>在<font face="DejaVu Serif, serif"><span lang="en-US">user</span></font>模式的时候，其的值为真。</p>
<p align="left">用这两个<font face="DejaVu Serif, serif"><span lang="en-US">trace</span></font>状态变量，就可以用<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>收集用户程序的栈信息<font face="DejaVu Serif, serif"><span lang="en-US">(</span></font>可用来做<font face="DejaVu Serif, serif"><span lang="en-US">backtrace)</span></font>。</p>
<p align="left">下面这个例子显示如何从用户层到<font face="DejaVu Serif, serif"><span lang="en-US">Linux</span></font>内核层做<font face="DejaVu Serif, serif"><span lang="en-US">backtrace(stack
dump)</span></font>：</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#</i></span></font>连接<font face="DejaVu Serif, serif"><span lang="en-US"><i>KGTP(</i></span></font>和上一节介绍的方法相同<font face="DejaVu Serif, serif"><span lang="en-US"><i>)</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
target extended-remote /sys/kernel/debug/gtp</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#</i></span></font>设置一个收集进程<font face="DejaVu Serif, serif"><span lang="en-US"><i>18776</i></span></font>的用户栈的<font face="DejaVu Serif, serif"><span lang="en-US"><i>tracepoint</i></span></font>。</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
trace vfs_read</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Tracepoint
1 at 0xffffffff8117a3d0: file
/home/teawater/kernel/linux/fs/read_write.c, line 365.</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
condition 1 ($current_task_user &amp;&amp; $current_task_pid ==
18776)</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
actions </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Enter
actions for tracepoint 1, one per line.</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>End
with a line saying just &quot;end&quot;.</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;collect
$current</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;collect
$bt</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;end</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#Setup
a tracepoint that collect kernel space stack of task 18776.</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#</i></span></font>设置一个收集进程<font face="DejaVu Serif, serif"><span lang="en-US"><i>18776</i></span></font>的内核栈的<font face="DejaVu Serif, serif"><span lang="en-US"><i>tracepoint</i></span></font>。</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
trace vfs_read</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Note:
breakpoint 1 also set at pc 0xffffffff8117a3d0.</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Tracepoint
2 at 0xffffffff8117a3d0: file
/home/teawater/kernel/linux/fs/read_write.c, line 365.</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
condition 2 ($current_task_user &amp;&amp; $current_task_pid ==
18776)</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
actions </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Enter
actions for tracepoint 2, one per line.</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>End
with a line saying just &quot;end&quot;.</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;collect
$bt</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;end</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
tstart</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
tstop</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#</i></span></font>下面这部分和上一节相同，增加一个新的<font face="DejaVu Serif, serif"><span lang="en-US"><i>inferior</i></span></font>用来分析应用程序的信息。</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
add-inferior </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Added
inferior 2</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
inferior 2</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>[Switching
to inferior 2 [&lt;null&gt;] (&lt;noexec&gt;)]</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
file gdb</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Reading
symbols from /usr/local/bin/gdb...done.</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
attach 18776</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#tracepoint
1 </i></span></font>收集了用户层的栈信息。</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
tfind</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Found
trace frame 0, tracepoint 1</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#0
 0x00007f77331d7d0f in __read_nocancel () from
/lib/x86_64-linux-gnu/libpthread.so.0</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#</i></span></font>这是程序<font face="DejaVu Serif, serif"><span lang="en-US"><i>18776</i></span></font>用户层的<font face="DejaVu Serif, serif"><span lang="en-US"><i>backtrace</i></span></font>。</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
bt</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#0
 0x00007f77331d7d0f in __read_nocancel () from
/lib/x86_64-linux-gnu/libpthread.so.0</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#1
 0x000000000078e145 in rl_callback_read_char () at
../../src/readline/callback.c:201</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#2
 0x000000000069de79 in rl_callback_read_char_wrapper
(client_data=&lt;optimized out&gt;) at ../../src/gdb/event-top.c:169</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#3
 0x000000000069ccf8 in process_event () at
../../src/gdb/event-loop.c:401</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#4
 process_event () at ../../src/gdb/event-loop.c:351</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#5
 0x000000000069d448 in gdb_do_one_event () at
../../src/gdb/event-loop.c:465</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#6
 0x000000000069d5d5 in start_event_loop () at
../../src/gdb/event-loop.c:490</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#7
 0x0000000000697083 in captured_command_loop (data=&lt;optimized
out&gt;) at ../../src/gdb/main.c:226</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#8
 0x0000000000695d8b in catch_errors (func=0x697070
&lt;captured_command_loop&gt;, func_args=0x0, errstring=0x14df99e &quot;&quot;,
</i></span></font>
</blockquote>
<blockquote class="cjk">    <font face="DejaVu Serif, serif"><span lang="en-US"><i>mask=6)
at ../../src/gdb/exceptions.c:546</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#9
 0x00000000006979e6 in captured_main (data=&lt;optimized out&gt;) at
../../src/gdb/main.c:1001</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#10
0x0000000000695d8b in catch_errors (func=0x697360 &lt;captured_main&gt;,
</i></span></font>
</blockquote>
<blockquote class="cjk">    <font face="DejaVu Serif, serif"><span lang="en-US"><i>func@entry=&lt;error
reading variable: PC not available&gt;, func_args=0x7fff08afd5b0, </i></span></font>
</blockquote>
<blockquote class="cjk">    <font face="DejaVu Serif, serif"><span lang="en-US"><i>func_args@entry=&lt;error
reading variable: PC not available&gt;, errstring=&lt;unavailable&gt;,
</i></span></font>
</blockquote>
<blockquote class="cjk">    <font face="DejaVu Serif, serif"><span lang="en-US"><i>errstring@entry=&lt;error
reading variable: PC not available&gt;, mask=&lt;unavailable&gt;, </i></span></font>
</blockquote>
<blockquote class="cjk">    <font face="DejaVu Serif, serif"><span lang="en-US"><i>mask@entry=&lt;error
reading variable: PC not available&gt;) at
../../src/gdb/exceptions.c:546</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#11
&lt;unavailable&gt; in ?? ()</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Backtrace
stopped: not enough registers or memory available to unwind further</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#tracepoint
2</i></span></font>收集了内核空间的栈，所以要切换回<font face="DejaVu Serif, serif"><span lang="en-US"><i>inferior
1</i></span></font>装载内核调试信息。</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
tfind</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Found
trace frame 1, tracepoint 2</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#0
 0xffffffff8117a3d0 in ?? ()</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
inferior 1</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>[Switching
to inferior 1 [Remote target] (/home/teawater/kernel/b/vmlinux)]</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>[Switching
to thread 1 (Remote target)] </i></span></font>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#0
 vfs_read (file=0xffff88021a559500, buf=0x7fff08afd31f &lt;Address
0x7fff08afd31f out of bounds&gt;, count=1, </i></span></font>
</blockquote>
<blockquote class="cjk">    <font face="DejaVu Serif, serif"><span lang="en-US"><i>pos=0xffff8800c47e1f48)
at /home/teawater/kernel/linux/fs/read_write.c:365</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>365
    {</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#</i></span></font>这是内核栈的<font face="DejaVu Serif, serif"><span lang="en-US"><i>backtrace</i></span></font>。</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
bt</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#0
 vfs_read (file=0xffff88021a559500, buf=0x7fff08afd31f &lt;Address
0x7fff08afd31f out of bounds&gt;, count=1, </i></span></font>
</blockquote>
<blockquote class="cjk">    <font face="DejaVu Serif, serif"><span lang="en-US"><i>pos=0xffff8800c47e1f48)
at /home/teawater/kernel/linux/fs/read_write.c:365</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#1
 0xffffffff8117a59a in sys_read (fd=&lt;optimized out&gt;,
buf=0x7fff08afd31f &lt;Address 0x7fff08afd31f out of bounds&gt;, </i></span></font>
</blockquote>
<blockquote class="cjk">    <font face="DejaVu Serif, serif"><span lang="en-US"><i>count=1)
at /home/teawater/kernel/linux/fs/read_write.c:469</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#2
 &lt;signal handler called&gt;</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#3
 0x00007f77331d7d10 in ?? ()</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#4
 0x0000000000000000 in ?? ()</i></span></font></blockquote>
<blockquote class="cjk" style="margin-left: 0cm"><br>
</blockquote>
<h3 class="cjk" style="page-break-before: always"><a name="__RefHeading__11565_1050592842"></a>
如何使用 <font face="DejaVu Serif, serif"><span lang="en-US">add-ons/hotcode.py</span></font></h3>
<p align="left">这个脚本可以通过记录并分析中断处理时候的取得的<font face="DejaVu Serif, serif"><span lang="en-US">PC</span></font>值从而得到<font face="DejaVu Serif, serif"><span lang="en-US">Linux
kernel</span></font>或者用户层程序的热点代码。</p>
<p align="left">请到 <font face="DejaVu Serif, serif"><span lang="en-US"><a href="http://code.google.com/p/kgtp/wiki/hotcode">http://code.google.com/p/kgtp/wiki/hotcode</a>
</span></font>去看如何使用它。</p>
<p align="left"><br><br>
</p>
<h2 class="cjk" style="page-break-before: always"><a name="__RefHeading__11567_1050592842"></a><a name="如何增加用C写的插件|outline"></a>
如何增加用<font face="DejaVu Serif, serif"><span lang="en-US">C</span></font>写的插件</h2>
<p align="left"><font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>支持用<font face="DejaVu Serif, serif"><span lang="en-US">C</span></font>写的插件，插件将被编译成<font face="DejaVu Serif, serif"><span lang="en-US">LKM</span></font>。
<font face="DejaVu Serif, serif"><span lang="en-US">KGTP support
plugin that write in C. The plugin will be built as LKM</span></font></p>
<p align="left"><br><br>
</p>
<h3 class="cjk" style="page-break-before: always"><a name="__RefHeading__11569_1050592842"></a>
<font face="DejaVu Serif, serif"><span lang="en-US">API</span></font></h3>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#include
&quot;gtp.h&quot;</i></span></font></blockquote>
<p align="left">这是插件需要的包含<font face="DejaVu Serif, serif"><span lang="en-US">API</span></font>的头文件。
</p>
<p align="left"><br><br>
</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>extern
int gtp_plugin_mod_register(struct module *mod);</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>extern
int gtp_plugin_mod_unregister(struct module *mod);</i></span></font></blockquote>
<p align="left">这两个函数注册和注销插件模块。这样<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>就可以在访问插件模块资源的时候增加其的引用计数了。
</p>
<p align="left"><br><br>
</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>extern
struct gtp_var *gtp_plugin_var_add(char *name, int64_t val,</i></span></font></blockquote>
<blockquote class="cjk">                                         
<font face="DejaVu Serif, serif"><span lang="en-US"><i>struct
gtp_var_hooks *hooks);</i></span></font></blockquote>
<p align="left">这个函数会增加特殊<font face="DejaVu Serif, serif"><span lang="en-US">trace</span></font>状态变量到<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>。</p>
<ul>
	<li><p align="left"><font face="DejaVu Serif, serif"><span lang="en-US"><b>name</b>
	</span></font>特殊<font face="DejaVu Serif, serif"><span lang="en-US">trace</span></font>状态变量的名字<font face="DejaVu Serif, serif"><span lang="en-US">.</span></font></p>
	<li><p align="left"><font face="DejaVu Serif, serif"><span lang="en-US"><b>val</b>
	</span></font>特殊<font face="DejaVu Serif, serif"><span lang="en-US">trace</span></font>状态变量的初始值<font face="DejaVu Serif, serif"><span lang="en-US">.</span></font></p>
	<li><p align="left"><font face="DejaVu Serif, serif"><span lang="en-US"><b>hooks</b>
	</span></font>函数指针。如果这个功能不支持，函数指针就设置为<font face="DejaVu Serif, serif"><span lang="en-US">NULL</span></font>。</p>
	<li><p align="left"><b>返回值</b>
	成功返回<font face="DejaVu Serif, serif"><span lang="en-US">gtp_var</span></font>指针。失败则返回用<font face="DejaVu Serif, serif"><span lang="en-US">IS_ERR</span></font>和<font face="DejaVu Serif, serif"><span lang="en-US">PTR_ERR</span></font>可以处理的错误码。</p>
</ul>
<p align="left"><br><br>
</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>struct
gtp_var_hooks {</i></span></font></blockquote>
<blockquote class="cjk">        <font face="DejaVu Serif, serif"><span lang="en-US"><i>int
    (*gdb_set_val)(struct gtp_trace_s *unused, struct gtp_var *var,</i></span></font></blockquote>
<blockquote class="cjk">                               <font face="DejaVu Serif, serif"><span lang="en-US"><i>int64_t
val);</i></span></font></blockquote>
<blockquote class="cjk">        <font face="DejaVu Serif, serif"><span lang="en-US"><i>int
    (*gdb_get_val)(struct gtp_trace_s *unused, struct gtp_var *var,</i></span></font></blockquote>
<blockquote class="cjk">                               <font face="DejaVu Serif, serif"><span lang="en-US"><i>int64_t
*val);</i></span></font></blockquote>
<blockquote class="cjk">        <font face="DejaVu Serif, serif"><span lang="en-US"><i>int
    (*agent_set_val)(struct gtp_trace_s *gts, struct gtp_var *var,</i></span></font></blockquote>
<blockquote class="cjk">                                 <font face="DejaVu Serif, serif"><span lang="en-US"><i>int64_t
val);</i></span></font></blockquote>
<blockquote class="cjk">        <font face="DejaVu Serif, serif"><span lang="en-US"><i>int
    (*agent_get_val)(struct gtp_trace_s *gts, struct gtp_var *var,</i></span></font></blockquote>
<blockquote class="cjk">                                 <font face="DejaVu Serif, serif"><span lang="en-US"><i>int64_t
*val);</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>};</i></span></font></blockquote>
<ul>
	<li><p align="left"><font face="DejaVu Serif, serif"><span lang="en-US"><b>gdb_set_val</b>
	</span></font>在<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>设置<font face="DejaVu Serif, serif"><span lang="en-US">TSV</span></font>值的时候调用，请
	<b>注意</b> <font face="DejaVu Serif, serif"><span lang="en-US">TSV</span></font>只能被<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>命令<font face="DejaVu Serif, serif"><span lang="en-US">&quot;tvariable
	$xxx=1&quot;</span></font>设置而且只有在<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>命令<font face="DejaVu Serif, serif"><span lang="en-US">&quot;tstart&quot;</span></font>的时候才会被发到<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>。</p>
	<ul>
		<li><p align="left"><font face="DejaVu Serif, serif"><span lang="en-US"><b>unused</b>
		</span></font>是无用的，只用来让这个指针可以和<font face="DejaVu Serif, serif"><span lang="en-US">agent_set_val</span></font>共享函数。</p>
		<li><p align="left"><font face="DejaVu Serif, serif"><span lang="en-US"><b>var</b>
		</span></font>是指向<font face="DejaVu Serif, serif"><span lang="en-US">gtp_var</span></font>的指针，于是当多个<font face="DejaVu Serif, serif"><span lang="en-US">TSV</span></font>共享一个函数的时候，这个值可以用来判定哪个<font face="DejaVu Serif, serif"><span lang="en-US">TSV</span></font>被访问了。</p>
		<li><p align="left"><font face="DejaVu Serif, serif"><span lang="en-US"><b>val</b>
		</span></font>是<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>设置来的值。</p>
		<li><p align="left"><b>返回值</b> 错误返回<font face="DejaVu Serif, serif"><span lang="en-US">-1</span></font>，正确返回<font face="DejaVu Serif, serif"><span lang="en-US">0</span></font>。</p>
	</ul>
	<li><p align="left"><font face="DejaVu Serif, serif"><span lang="en-US"><b>gdb_get_val</b>
	</span></font>在<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>取<font face="DejaVu Serif, serif"><span lang="en-US">TSV</span></font>值的时候被调用。请
	<b>注意</b>
	取<font face="DejaVu Serif, serif"><span lang="en-US">TSV</span></font>值和设置<font face="DejaVu Serif, serif"><span lang="en-US">TSV</span></font>不同，设置任何时候都会直接从<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>里取，并且取值的<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>命令和访问一个普通的<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>内部变量一样。例如：<font face="DejaVu Serif, serif"><span lang="en-US">&quot;p
	$xxx&quot;</span></font>。</p>
	<ul>
		<li><p align="left"><font face="DejaVu Serif, serif"><span lang="en-US"><b>unused</b>
		</span></font>和<font face="DejaVu Serif, serif"><span lang="en-US">gdb_set_val</span></font>作用相同。</p>
		<li><p align="left"><font face="DejaVu Serif, serif"><span lang="en-US"><b>var</b>
		</span></font>和<font face="DejaVu Serif, serif"><span lang="en-US">gdb_set_val</span></font>作用相同。</p>
		<li><p align="left"><font face="DejaVu Serif, serif"><span lang="en-US"><b>val</b>
		</span></font>用来返回值的指针。</p>
		<li><p align="left"><b>返回值</b> 和<font face="DejaVu Serif, serif"><span lang="en-US">gdb_set_val</span></font>作用相同。</p>
	</ul>
	<li><p align="left"><font face="DejaVu Serif, serif"><span lang="en-US"><b>agent_set_val</b>
	</span></font>在<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint
	action(<a href="#teval_expr1,_expr2,_...|outline">teval_expr1,_expr2,_...</a>)</span></font>设置<font face="DejaVu Serif, serif"><span lang="en-US">TSV</span></font>的时候调用。</p>
	<ul>
		<li><p align="left"><font face="DejaVu Serif, serif"><span lang="en-US"><b>gts</b>
		</span></font>是指向<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>会话结构的指针。</p>
		<li><p align="left"><font face="DejaVu Serif, serif"><span lang="en-US"><b>var</b>
		</span></font>和<font face="DejaVu Serif, serif"><span lang="en-US">gdb_set_val</span></font>作用相同。</p>
		<li><p align="left"><font face="DejaVu Serif, serif"><span lang="en-US"><b>val</b>
		action</span></font>设置的值。</p>
		<li><p align="left"><b>返回值 </b>和<font face="DejaVu Serif, serif"><span lang="en-US">gdb_set_val</span></font>作用相同。</p>
	</ul>
	<li><p align="left"><font face="DejaVu Serif, serif"><span lang="en-US"><b>agent_get_val</b>
	will be called when tracepoint action(<a href="#collect expr1, expr2, ...|outline">collect
	expr1, expr2, ...</a></span></font>或者 <font face="DejaVu Serif, serif"><span lang="en-US"><a href="#teval expr1, expr2, ...|outline">teval
	expr1, expr2, ...</a>) get the TSV.</span></font></p>
	<ul>
		<li><p align="left"><font face="DejaVu Serif, serif"><span lang="en-US"><b>gts</b>
		</span></font>和<font face="DejaVu Serif, serif"><span lang="en-US">agent_set_val</span></font>作用相同。</p>
		<li><p align="left"><font face="DejaVu Serif, serif"><span lang="en-US"><b>var</b>
		</span></font>和<font face="DejaVu Serif, serif"><span lang="en-US">gdb_set_val</span></font>作用相同。</p>
		<li><p align="left"><font face="DejaVu Serif, serif"><span lang="en-US"><b>val</b>
		</span></font>和<font face="DejaVu Serif, serif"><span lang="en-US">gdb_get_val</span></font>作用相同。</p>
		<li><p align="left"><b>返回值</b> 和<font face="DejaVu Serif, serif"><span lang="en-US">gdb_set_val</span></font>作用相同。</p>
	</ul>
</ul>
<p align="left"><br><br>
</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>extern
int gtp_plugin_var_del(struct gtp_var *var);</i></span></font></blockquote>
<p align="left">当<font face="DejaVu Serif, serif"><span lang="en-US">rmmod</span></font>插件模块的时候，用这个函数删除<font face="DejaVu Serif, serif"><span lang="en-US">gtp_plugin_var_add</span></font>增加的<font face="DejaVu Serif, serif"><span lang="en-US">TSV</span></font>。
</p>
<p align="left"><br><br>
</p>
<h3 class="cjk" style="page-break-before: always"><a name="__RefHeading__11571_1050592842"></a>
例子</h3>
<p align="left"><font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>目录里的<font face="DejaVu Serif, serif"><span lang="en-US">plugin_example.c</span></font>是<font face="DejaVu Serif, serif"><span lang="en-US">KGTP
plugin</span></font>的例子，可以用<font face="DejaVu Serif, serif"><span lang="en-US">&quot;make
P=1&quot;</span></font>直接编译其。其将增加四个<font face="DejaVu Serif, serif"><span lang="en-US">TSV</span></font>到<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>中。</p>
<p align="left"><br><br>
</p>
<ul>
	<li><p align="left"><font face="DejaVu Serif, serif"><span lang="en-US"><b>$test1</b>
	</span></font>什么也不支持。</p>
	<li><p align="left"><font face="DejaVu Serif, serif"><span lang="en-US"><b>$test2</b>
	</span></font>支持被<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>或者<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint
	action</span></font>读写。</p>
	<li><p align="left"><font face="DejaVu Serif, serif"><span lang="en-US"><b>$test3</b>
	</span></font>只支持<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint
	action</span></font>写，当设置一个值到里面的时候，其将找到这个值对应的符号并打印出来。例如
	<font face="DejaVu Serif, serif"><span lang="en-US">&quot;teval
	$test3=(int64_t)$rip&quot;</span></font>。</p>
	<li><p align="left"><font face="DejaVu Serif, serif"><span lang="en-US"><b>$test4</b>
	</span></font>只支持<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint
	action</span></font>写，当设置值的时候其将打印当前<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>的地址的符号。</p>
</ul>
<p align="left"><br><br>
</p>
<h3 class="cjk" style="page-break-before: always"><a name="__RefHeading__11573_1050592842"></a>
如何使用</h3>
<ul>
	<li><p align="left">安装<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>模块
	<a href="#如何让GDB连接KGTP|outline">如何让<font face="DejaVu Serif, serif"><span lang="en-US">GDB</a></span></font><a href="#如何让GDB连接KGTP|outline">连接<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</a></span></font></p>
	<li><p align="left"><font face="DejaVu Serif, serif"><span lang="en-US">insmod
	plugin_example.ko</span></font></p>
	<li><p align="left">让<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>连上<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>并使用其。</p>
	<li><p align="left">断开<font face="DejaVu Serif, serif"><span lang="en-US">GDB.
	</span></font>如果 <font face="DejaVu Serif, serif"><span lang="en-US"><a href="#GDB断开的时候不要停止tracepoint|outline">GDB</a></span></font><a href="#GDB断开的时候不要停止tracepoint|outline">断开的时候不要停止<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</a>
	</span></font>中的选项设置为打开，则设置其为关闭。</p>
	<li><p align="left"><font face="DejaVu Serif, serif"><span lang="en-US">rmmod
	plugin_example.ko</span></font></p>
</ul>
<p align="left">请 <b>注意</b> <font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>支持加入多个插件。</p>
<p align="left"><br><br>
</p>
<h2 class="cjk" style="page-break-before: always"><a name="__RefHeading__11575_1050592842"></a>
如何使用性能计数器</h2>
<p align="left">性能计数器是大部分现代<font face="DejaVu Serif, serif"><span lang="en-US">CPU</span></font>都有的特殊硬件寄存器。这些寄存器对一些硬件事件进行计数：例如指令执行数量，<font face="DejaVu Serif, serif"><span lang="en-US">cachemisses</span></font>数量，分支预测失败数，而且这些计数不会让应用程序或者内核变慢。其还可以设置到达一定的值的时候发生中断，这些就可以用来分析在某<font face="DejaVu Serif, serif"><span lang="en-US">CPU</span></font>上执行程序的性能。</p>
<p align="left"><font face="DejaVu Serif, serif"><span lang="en-US">Linux</span></font>性能计数器子系统<font face="DejaVu Serif, serif"><span lang="en-US">perf
event</span></font>可以用来取得性能计数器的值。你可以用<font face="DejaVu Serif, serif"><span lang="en-US">KGTP
perf event trace</span></font>状态变量访问这些值。</p>
<p align="left">请读内核目录里的<font face="DejaVu Serif, serif"><span lang="en-US">tools/perf/design.txt</span></font>文件取得<font face="DejaVu Serif, serif"><span lang="en-US">perf
event</span></font>的更多信息。</p>
<p align="left"><br><br>
</p>
<h3 class="cjk" style="page-break-before: always"><a name="__RefHeading__11577_1050592842"></a>
定义一个<font face="DejaVu Serif, serif"><span lang="en-US">perf
event trace</span></font>状态变量</h3>
<p align="left">访问一个性能计数器需要定义下面的<font face="DejaVu Serif, serif"><span lang="en-US">trace</span></font>状态变量：</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&quot;pe_cpu_&quot;+tv_name
      </i></span></font>定义性能计数器的<font face="DejaVu Serif, serif"><span lang="en-US"><i>CPU
ID</i></span></font>。</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&quot;pe_type_&quot;+tv_name
     </i></span></font>定义性能计数器的类型。</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&quot;pe_config_&quot;+tv_name
   </i></span></font>定义性能计数器的配置。</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&quot;pe_en_&quot;+tv_name
       </i></span></font>定义性能计数器的启动开关。</blockquote>
<blockquote class="cjk">                        默认情况下性能计数器是关闭的。</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&quot;pe_val_&quot;+tv_name
      </i></span></font>访问这个变量能取得性能计数器的值。</blockquote>
<blockquote class="cjk" style="margin-left: 0cm"><br>
</blockquote>
<h3 class="cjk" style="page-break-before: always"><a name="__RefHeading__11579_1050592842"></a>
定义一个<font face="DejaVu Serif, serif"><span lang="en-US">per_cpu
perf event trace</span></font>状态变量</h3>
<p align="left">定义一个<font face="DejaVu Serif, serif"><span lang="en-US">per_cpu
perf event trace</span></font>状态变量和<font face="DejaVu Serif, serif"><span lang="en-US"><a href="#Per_cpu trace状态变量|outline">Per_cpu
trace</a></span></font><a href="#Per_cpu trace状态变量|outline">状态变量</a>一样。</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&quot;p_pe_&quot;+perf_event
type+string+CPU_id</i></span></font></blockquote>
<p align="left">请 <b>注意</b> 如果定义一个<font face="DejaVu Serif, serif"><span lang="en-US">per_cpu
perf event trace</span></font>状态变量，就不需要在定义<font face="DejaVu Serif, serif"><span lang="en-US">cpu
id(&quot;pe_cpu&quot;)</span></font>因为<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>已经取得了<font face="DejaVu Serif, serif"><span lang="en-US">CPU</span></font>的<font face="DejaVu Serif, serif"><span lang="en-US">ID</span></font>。</p>
<p align="left"><br><br>
</p>
<h3 class="cjk" style="page-break-before: always"><a name="__RefHeading__11581_1050592842"></a>
<font face="DejaVu Serif, serif"><span lang="en-US">perf event</span></font>的类型和配置</h3>
<p align="left">类型可以是：</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>0
      PERF_TYPE_HARDWARE</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>1
      PERF_TYPE_SOFTWARE</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>2
      PERF_TYPE_TRACEPOINT</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>3
      PERF_TYPE_HW_CACHE</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>4
      PERF_TYPE_RAW</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>5
      PERF_TYPE_BREAKPOINT</i></span></font></blockquote>
<blockquote class="cjk" style="margin-left: 0cm"><br>
</blockquote>
<p align="left">如果类型是<font face="DejaVu Serif, serif"><span lang="en-US">0(PERF_TYPE_HARDWARE)</span></font>，配置可以是：</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>0
      PERF_COUNT_HW_CPU_CYCLES</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>1
      PERF_COUNT_HW_INSTRUCTIONS</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>2
      PERF_COUNT_HW_CACHE_REFERENCES</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>3
      PERF_COUNT_HW_CACHE_MISSES</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>4
      PERF_COUNT_HW_BRANCH_INSTRUCTIONS</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>5
      PERF_COUNT_HW_BRANCH_MISSES</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>6
      PERF_COUNT_HW_BUS_CYCLES</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>7
      PERF_COUNT_HW_STALLED_CYCLES_FRONTEND</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>8
      PERF_COUNT_HW_STALLED_CYCLES_BACKEND</i></span></font></blockquote>
<p align="left"><br><br>
</p>
<p align="left">如果类型是<font face="DejaVu Serif, serif"><span lang="en-US">3(PERF_TYPE_HW_CACHE)</span></font>，配置要分为<font face="DejaVu Serif, serif"><span lang="en-US">3</span></font>部分：
第一部分是<font face="DejaVu Serif, serif"><span lang="en-US">cache
id</span></font>，其在设置进配置的时候需要 <font face="DejaVu Serif, serif"><span lang="en-US">&lt;&lt;
0</span></font>：</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>0
      PERF_COUNT_HW_CACHE_L1D</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>1
      PERF_COUNT_HW_CACHE_L1I</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>2
      PERF_COUNT_HW_CACHE_LL</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>3
      PERF_COUNT_HW_CACHE_DTLB</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>4
      PERF_COUNT_HW_CACHE_ITLB</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>5
      PERF_COUNT_HW_CACHE_BPU</i></span></font></blockquote>
<blockquote class="cjk" style="margin-left: 0cm"><br>
</blockquote>
<p align="left">第二部分是<font face="DejaVu Serif, serif"><span lang="en-US">cache
op id</span></font>，其在设置进配置的时候需要 <font face="DejaVu Serif, serif"><span lang="en-US">&lt;&lt;
8</span></font>：</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>0
      PERF_COUNT_HW_CACHE_OP_READ</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>1
      PERF_COUNT_HW_CACHE_OP_WRITE</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>2
      PERF_COUNT_HW_CACHE_OP_PREFETCH</i></span></font></blockquote>
<p align="left"><br><br>
</p>
<p align="left">第三部分是<font face="DejaVu Serif, serif"><span lang="en-US">cache
op result id</span></font>，其在设置进配置的时候需要 <font face="DejaVu Serif, serif"><span lang="en-US">&lt;&lt;
16</span></font>：</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>0
      PERF_COUNT_HW_CACHE_RESULT_ACCESS</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>1
      PERF_COUNT_HW_CACHE_RESULT_MISS</i></span></font></blockquote>
<p align="left"><br><br>
</p>
<p align="left">如果你想取得<font face="DejaVu Serif, serif"><span lang="en-US">PERF_COUNT_HW_CACHE_L1I(1),
PERF_COUNT_HW_CACHE_OP_WRITE(1) and
PERF_COUNT_HW_CACHE_RESULT_MISS(1)</span></font>你需要使用：</p>
<p align="left"><br><br>
</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
tvariable $pe_config_cache=1 | (1 &lt;&lt; 8) | (1 &lt;&lt; 16)</i></span></font></blockquote>
<blockquote class="cjk" style="margin-left: 0cm"><br>
</blockquote>
<p align="left">内核目录中的<font face="DejaVu Serif, serif"><span lang="en-US">tools/perf/design.txt</span></font>是关于<font face="DejaVu Serif, serif"><span lang="en-US">perf
event</span></font>的类型和配置。</p>
<p align="left"><br><br>
</p>
<h3 class="cjk" style="page-break-before: always"><a name="__RefHeading__11583_1050592842"></a>
用<font face="DejaVu Serif, serif"><span lang="en-US">$p_pe_en</span></font>打开和关闭一个<font face="DejaVu Serif, serif"><span lang="en-US">CPU</span></font>上所有的<font face="DejaVu Serif, serif"><span lang="en-US">perf
event</span></font></h3>
<p align="left">我认为取得一段代码的性能计数器信息比较好的办法是在函数开头打开计数器在函数结束的时候关闭计数器。你可以用<font face="DejaVu Serif, serif"><span lang="en-US">&quot;pe_en&quot;</span></font>设置他们，但是如果你有多个<font face="DejaVu Serif, serif"><span lang="en-US">perf
event trace</span></font>状态变量的时候，这样会让<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint
action</span></font>很大。<font face="DejaVu Serif, serif"><span lang="en-US">$p_pe_en</span></font>就是处理这种问题的。
你可以打开所有<font face="DejaVu Serif, serif"><span lang="en-US">perf
event trace</span></font>状态变量在当前<font face="DejaVu Serif, serif"><span lang="en-US">CPU</span></font>上用下面的<font face="DejaVu Serif, serif"><span lang="en-US">action</span></font>：</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;teval
$p_pe_en=1</i></span></font></blockquote>
<p align="left"><br><br>
</p>
<p align="left">设置<font face="DejaVu Serif, serif"><span lang="en-US">$p_pe_en</span></font>为<font face="DejaVu Serif, serif"><span lang="en-US">0</span></font>来关闭他们。</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;teval
$p_pe_en=0</i></span></font></blockquote>
<p align="left"><br><br>
</p>
<h3 class="cjk" style="page-break-before: always"><a name="__RefHeading__11585_1050592842"></a>
用来帮助设置和取得<font face="DejaVu Serif, serif"><span lang="en-US">perf
event trace</span></font>状态变量的<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>脚本</h3>
<p align="left">下面这个<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>脚本定义了<font face="DejaVu Serif, serif"><span lang="en-US">2</span></font>个命令<font face="DejaVu Serif, serif"><span lang="en-US">dpe</span></font>和<font face="DejaVu Serif, serif"><span lang="en-US">spe</span></font>来帮助定义和显示<font face="DejaVu Serif, serif"><span lang="en-US">perf
event trace</span></font>状态变量。</p>
<p align="left">你可以把他们存在<font face="DejaVu Serif, serif"><span lang="en-US">~/.gdbinit</span></font>或者你自己的<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>脚本中。于是你就可以在<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>中直接使用这<font face="DejaVu Serif, serif"><span lang="en-US">2</span></font>个命令。</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>define
dpe</i></span></font></blockquote>
<blockquote class="cjk">  <font face="DejaVu Serif, serif"><span lang="en-US"><i>if
($argc &lt; 2)</i></span></font></blockquote>
<blockquote class="cjk">    <font face="DejaVu Serif, serif"><span lang="en-US"><i>printf
&quot;Usage: dpe pe_type pe_config [enable]\n&quot;</i></span></font></blockquote>
<blockquote class="cjk">  <font face="DejaVu Serif, serif"><span lang="en-US"><i>end</i></span></font></blockquote>
<blockquote class="cjk">  <font face="DejaVu Serif, serif"><span lang="en-US"><i>if
($argc &gt;= 2)</i></span></font></blockquote>
<blockquote class="cjk">    <font face="DejaVu Serif, serif"><span lang="en-US"><i>eval
&quot;tvariable $p_pe_val_%d%d_c&quot;,$arg0, $arg1</i></span></font></blockquote>
<blockquote class="cjk">    <font face="DejaVu Serif, serif"><span lang="en-US"><i>eval
&quot;tvariable $p_pe_en_%d%d_c&quot;,$arg0, $arg1</i></span></font></blockquote>
<blockquote class="cjk">    <font face="DejaVu Serif, serif"><span lang="en-US"><i>set
$tmp=0</i></span></font></blockquote>
<blockquote class="cjk">    <font face="DejaVu Serif, serif"><span lang="en-US"><i>while
$tmp&lt;$cpu_number</i></span></font></blockquote>
<blockquote class="cjk">      <font face="DejaVu Serif, serif"><span lang="en-US"><i>eval
&quot;tvariable $p_pe_type_%d%d_c%d=%d&quot;,$arg0, $arg1, $tmp,
$arg0</i></span></font></blockquote>
<blockquote class="cjk">      <font face="DejaVu Serif, serif"><span lang="en-US"><i>eval
&quot;tvariable $p_pe_config_%d%d_c%d=%d&quot;,$arg0, $arg1, $tmp,
$arg1</i></span></font></blockquote>
<blockquote class="cjk">      <font face="DejaVu Serif, serif"><span lang="en-US"><i>eval
&quot;tvariable $p_pe_val_%d%d_c%d=0&quot;,$arg0, $arg1, $tmp</i></span></font></blockquote>
<blockquote class="cjk">      <font face="DejaVu Serif, serif"><span lang="en-US"><i>if
($argc &gt;= 3)</i></span></font></blockquote>
<blockquote class="cjk">        <font face="DejaVu Serif, serif"><span lang="en-US"><i>eval
&quot;tvariable $p_pe_en_%d%d_c%d=%d&quot;,$arg0, $arg1, $tmp, $arg2</i></span></font></blockquote>
<blockquote class="cjk">      <font face="DejaVu Serif, serif"><span lang="en-US"><i>end</i></span></font></blockquote>
<blockquote class="cjk">      <font face="DejaVu Serif, serif"><span lang="en-US"><i>set
$tmp=$tmp+1</i></span></font></blockquote>
<blockquote class="cjk">    <font face="DejaVu Serif, serif"><span lang="en-US"><i>end</i></span></font></blockquote>
<blockquote class="cjk">  <font face="DejaVu Serif, serif"><span lang="en-US"><i>end</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>end</i></span></font></blockquote>
<blockquote class="cjk"><br>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>document
dpe</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Usage:
dpe pe_type pe_config [enable]</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>end</i></span></font></blockquote>
<blockquote class="cjk"><br>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>define
spe</i></span></font></blockquote>
<blockquote class="cjk">  <font face="DejaVu Serif, serif"><span lang="en-US"><i>if
($argc != 2 &amp;&amp; $argc != 3)</i></span></font></blockquote>
<blockquote class="cjk">    <font face="DejaVu Serif, serif"><span lang="en-US"><i>printf
&quot;Usage: spe pe_type pe_config [cpu_id]\n&quot;</i></span></font></blockquote>
<blockquote class="cjk">  <font face="DejaVu Serif, serif"><span lang="en-US"><i>end</i></span></font></blockquote>
<blockquote class="cjk">  <font face="DejaVu Serif, serif"><span lang="en-US"><i>if
($argc == 2)</i></span></font></blockquote>
<blockquote class="cjk">    <font face="DejaVu Serif, serif"><span lang="en-US"><i>set
$tmp=0</i></span></font></blockquote>
<blockquote class="cjk">    <font face="DejaVu Serif, serif"><span lang="en-US"><i>while
$tmp&lt;$cpu_number</i></span></font></blockquote>
<blockquote class="cjk">      <font face="DejaVu Serif, serif"><span lang="en-US"><i>eval
&quot;printf \&quot;$p_pe_val_%%d%%d_c%%d=%%ld\\n\&quot;,$arg0,
$arg1, $tmp, $p_pe_val_%d%d_c%d&quot;, $arg0, $arg1, $tmp</i></span></font></blockquote>
<blockquote class="cjk">      <font face="DejaVu Serif, serif"><span lang="en-US"><i>set
$tmp=$tmp+1</i></span></font></blockquote>
<blockquote class="cjk">    <font face="DejaVu Serif, serif"><span lang="en-US"><i>end</i></span></font></blockquote>
<blockquote class="cjk">  <font face="DejaVu Serif, serif"><span lang="en-US"><i>end</i></span></font></blockquote>
<blockquote class="cjk">  <font face="DejaVu Serif, serif"><span lang="en-US"><i>if
($argc == 3)</i></span></font></blockquote>
<blockquote class="cjk">    <font face="DejaVu Serif, serif"><span lang="en-US"><i>eval
&quot;printf \&quot;$p_pe_val_%%d%%d_c%%d=%%ld\\n\&quot;,$arg0,
$arg1, $tmp, $p_pe_val_%d%d_c%d&quot;, $arg0, $arg1, $arg2</i></span></font></blockquote>
<blockquote class="cjk">  <font face="DejaVu Serif, serif"><span lang="en-US"><i>end</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>end</i></span></font></blockquote>
<blockquote class="cjk"><br>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>document
spe</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Usage:
spe pe_type pe_config [cpu_id]</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>end</i></span></font></blockquote>
<blockquote class="cjk" style="margin-left: 0cm"><br>
</blockquote>
<p align="left">下面是一个取得函数<font face="DejaVu Serif, serif"><span lang="en-US">tcp_v4_rcv</span></font>性能计数器的例子：</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#</i></span></font>连接<font face="DejaVu Serif, serif"><span lang="en-US"><i>KGTP</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
target remote /sys/kernel/debug/gtp</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#</i></span></font>定义<font face="DejaVu Serif, serif"><span lang="en-US"><i>3</i></span></font>个<font face="DejaVu Serif, serif"><span lang="en-US"><i>perf
event
trace</i></span></font>状态变量<font face="DejaVu Serif, serif"><span lang="en-US"><i>PERF_COUNT_HW_CPU_CYCLES</i></span></font>，<font face="DejaVu Serif, serif"><span lang="en-US"><i>PERF_COUNT_HW_CACHE_MISSES</i></span></font>和<font face="DejaVu Serif, serif"><span lang="en-US"><i>PERF_COUNT_HW_BRANCH_MISSES</i></span></font>。</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
dpe 0 0</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
dpe 0 3</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
dpe 0 5</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#</i></span></font>在函数开头打开这个<font face="DejaVu Serif, serif"><span lang="en-US"><i>CPU</i></span></font>的性能寄存器</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
trace tcp_v4_rcv</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
action</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;teval
$p_pe_en=1</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;end</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#$kret
</i></span></font>让我们可以处理到函数<font face="DejaVu Serif, serif"><span lang="en-US"><i>tcp_v4_rcv</i></span></font>的结尾：</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
trace *(tcp_v4_rcv)</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
action</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;teval
$kret=0</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#</i></span></font>关闭这个<font face="DejaVu Serif, serif"><span lang="en-US"><i>CPU</i></span></font>上的所有性能计数器</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;teval
$p_pe_en=0</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#</i></span></font>访问这些<font face="DejaVu Serif, serif"><span lang="en-US"><i>perf
event trace</i></span></font>状态变量将取得他们的值</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;collect
$p_pe_val_00_0</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;collect
$p_pe_val_03_0</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;collect
$p_pe_val_05_0</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#</i></span></font>设置这些<font face="DejaVu Serif, serif"><span lang="en-US"><i>perf
event trace</i></span></font>状态变量为<font face="DejaVu Serif, serif"><span lang="en-US"><i>0</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;teval
$p_pe_val_00_0=0</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;teval
$p_pe_val_03_0=0</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;teval
$p_pe_val_05_0=0</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>&gt;end</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>tstart</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#</i></span></font>等一会让每个<font face="DejaVu Serif, serif"><span lang="en-US"><i>CPU</i></span></font>收一些<font face="DejaVu Serif, serif"><span lang="en-US"><i>TCP</i></span></font>包</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
tstop</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
tfind</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
spe 0 0 $cpu_id</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>$p_pe_val_00_2=12676</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
spe 0 3 $cpu_id</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>$p_pe_val_03_2=7</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
spe 0 5 $cpu_id</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>$p_pe_val_05_2=97</i></span></font></blockquote>
<blockquote class="cjk" style="margin-left: 0cm"><br>
</blockquote>
<h1 class="cjk" style="page-break-before: always"><a name="__RefHeading__11597_1305468286"></a><a name="7.附录A 使用KGTP前的准备工作|outline"></a>
附录<font face="DejaVu Sans, sans-serif"><span lang="en-US">A
</span></font>使用<font face="DejaVu Sans, sans-serif"><span lang="en-US">KGTP</span></font>前的准备工作</h1>
<h2 class="cjk"><a name="__RefHeading__10124_71337508"></a><font face="DejaVu Serif, serif"><span lang="en-US">Linux</span></font>内核</h2>
<h3 class="cjk"><a name="__RefHeading__10126_71337508"></a><a name="如果你的系统内核是自己编译的|outline"></a><a name="如果你的系统内核是自己编译的|outline"></a>
如果你的系统内核是自己编译的</h3>
<p align="left">要使用<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>，你需要打开下面这些内核选项：</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>General
setup  ---&gt;</i></span></font></blockquote>
<blockquote class="cjk">        <font face="DejaVu Serif, serif"><span lang="en-US"><i>[*]
Kprobes</i></span></font></blockquote>
<blockquote class="cjk"><br>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>[*]
Enable loadable module support  ---&gt;</i></span></font></blockquote>
<blockquote class="cjk"><br>
</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Kernel
hacking  ---&gt;</i></span></font></blockquote>
<blockquote class="cjk">        <font face="DejaVu Serif, serif"><span lang="en-US"><i>[*]
Debug Filesystem</i></span></font></blockquote>
<blockquote class="cjk">        <font face="DejaVu Serif, serif"><span lang="en-US"><i>[*]
Compile the kernel with debug info</i></span></font></blockquote>
<p align="left">如果你改了<font face="DejaVu Serif, serif"><span lang="en-US">Linux</span></font>内核<font face="DejaVu Serif, serif"><span lang="en-US">config</span></font>的任何项目，请重新编译你的内核。</p>
<p align="left"><br><br>
</p>
<h3 class="cjk" style="page-break-before: always"><a name="__RefHeading__10128_71337508"></a>
如果是<font face="DejaVu Serif, serif"><span lang="en-US">Android</span></font>内核</h3>
<p align="left">默认的<font face="DejaVu Serif, serif"><span lang="en-US">Android
Linux</span></font>内核<font face="DejaVu Serif, serif"><span lang="en-US">config</span></font>应该不支持<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>。要使用<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>，你需要打开下面这些内核选项：</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>[*]
Enable loadable module support  ---&gt;</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>General
setup  ---&gt; </i></span></font>
</blockquote>
<blockquote class="cjk">        <font face="DejaVu Serif, serif"><span lang="en-US"><i>[*]
Prompt for development and/or incomplete code/drivers</i></span></font></blockquote>
<blockquote class="cjk">        <font face="DejaVu Serif, serif"><span lang="en-US"><i>[*]
Kprobes</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Kernel
hacking  ---&gt;</i></span></font></blockquote>
<blockquote class="cjk">        <font face="DejaVu Serif, serif"><span lang="en-US"><i>[*]
Debug Filesystem</i></span></font></blockquote>
<blockquote class="cjk">        <font face="DejaVu Serif, serif"><span lang="en-US"><i>[*]
Compile the kernel with debug info</i></span></font></blockquote>
<p align="left">如果你改了<font face="DejaVu Serif, serif"><span lang="en-US">Linux</span></font>内核<font face="DejaVu Serif, serif"><span lang="en-US">config</span></font>的任何项目，请重新编译你的内核。</p>
<p align="left"><br><br>
</p>
<h3 class="cjk" style="page-break-before: always"><a name="__RefHeading__10130_71337508"></a>
如果你的系统内核是发行版自带的</h3>
<p align="left">你需要安装一些<font face="DejaVu Serif, serif"><span lang="en-US">Linux</span></font>内核软件包。</p>
<h4 class="cjk"><a name="__RefHeading__10132_71337508"></a><font face="DejaVu Sans, sans-serif"><span lang="en-US">Ubuntu</span></font></h4>
<h5 class="cjk"><a name="__RefHeading__10134_71337508"></a>安装<font face="DejaVu Sans, sans-serif"><span lang="en-US">Linux</span></font>内核调试镜像的标准方法</h5>
<p align="left"><font face="DejaVu Serif, serif"><span lang="en-US"><b>1)</b>
</span></font>增加调试源到<font face="DejaVu Serif, serif"><span lang="en-US">Ubuntu</span></font>源列表。</p>
<ul>
	<li><p align="left">在命令行按照下面的命令创建文件
	<font face="DejaVu Serif, serif"><span lang="en-US">/etc/apt/sources.list.d/ddebs.list</span></font>：</p>
</ul>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>echo
&quot;deb http://ddebs.ubuntu.com $(lsb_release -cs) main restricted
universe multiverse&quot; | \</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>sudo
tee -a /etc/apt/sources.list.d/ddebs.list</i></span></font></blockquote>
<ul>
	<li><p align="left">稳定版本（不能是<font face="DejaVu Serif, serif"><span lang="en-US">alpha</span></font>或者<font face="DejaVu Serif, serif"><span lang="en-US">betas</span></font>）需要用命令行增加下面几行：</p>
</ul>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>echo
&quot;deb http://ddebs.ubuntu.com $(lsb_release -cs)-updates main
restricted universe multiverse</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>deb
http://ddebs.ubuntu.com $(lsb_release -cs)-security main restricted
universe multiverse</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>deb
http://ddebs.ubuntu.com $(lsb_release -cs)-proposed main restricted
universe multiverse&quot; | \</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>sudo
tee -a /etc/apt/sources.list.d/ddebs.list</i></span></font></blockquote>
<ul>
	<li><p align="left">导入调试符号签名<font face="DejaVu Serif, serif"><span lang="en-US">key</span></font>：</p>
</ul>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>sudo
apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 428D7C01</i></span></font></blockquote>
<blockquote class="cjk">运行：</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>sudo
apt-get update</i></span></font></blockquote>
<p align="left"><br><br>
</p>
<p align="left"><font face="DejaVu Serif, serif"><span lang="en-US"><b>2)</b>
</span></font>安装<font face="DejaVu Serif, serif"><span lang="en-US">Linux</span></font>内核调试镜像</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>sudo
apt-get install linux-image-$(uname -r)-dbgsym</i></span></font></blockquote>
<p align="left">于是你可以在<font face="DejaVu Serif, serif"><span lang="en-US">&quot;/usr/lib/debug/boot/vmlinux-$(uname
-r)&quot;</span></font>找到内核调试镜像。</p>
<p align="left">请 注意 当内核更新的时候这一步
<b>安装</b><font face="DejaVu Serif, serif"><span lang="en-US"><b>Linux</b></span></font><b>内核调试镜像</b>
需要再做一次。</p>
<h5 class="cjk"><a name="__RefHeading__10136_71337508"></a>安装<font face="DejaVu Sans, sans-serif"><span lang="en-US">Linux</span></font>内核调试镜像的第二方法</h5>
<p align="left">如果用标准方法出现问题，请用下面这些命令安装<font face="DejaVu Serif, serif"><span lang="en-US">Linux</span></font>内核调试镜像。</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>wget
http://ddebs.ubuntu.com/pool/main/l/linux/linux-image-$(uname
-r)-dbgsym_$(dpkg -s linux-image-$(uname -r) | grep ^Version: | sed
's/Version: //')_$(uname -i | sed 's/x86_64/amd64/').ddeb</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>sudo
dpkg -i linux-image-$(uname -r)-dbgsym_$(dpkg -s linux-image-$(uname
-r) | grep ^Version: | sed 's/Version: //')_$(uname -i | sed
's/x86_64/amd64/').ddeb</i></span></font></blockquote>
<p align="left">请 <b>注意</b> 当内核更新的时候这个方法需要重新做一次。</p>
<p align="left"><br><br>
</p>
<h5 class="cjk"><a name="__RefHeading__10138_71337508"></a>安装内核头文件包</h5>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>sudo
apt-get install linux-headers-generic</i></span></font></blockquote>
<h5 class="cjk"><a name="__RefHeading__10140_71337508"></a>安装内核源码</h5>
<h6 class="cjk"><a name="__RefHeading__10657_680043226"></a>新方法</h6>
<p>安装需要的软件包：</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>sudo
apt-get install dpkg-dev</i></span></font></blockquote>
<p><br><br>
</p>
<p>取得源码<font face="DejaVu Serif, serif"><span lang="en-US">:</span></font></p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>apt-get
source linux-image-$(uname -r)</i></span></font></blockquote>
<p>则在当前目录找到内核源码目录。 
</p>
<p>移动这个目录到<font face="DejaVu Serif, serif"><span lang="en-US">&quot;/build/buildd/&quot;</span></font>中。</p>
<h6 class="cjk"><a name="__RefHeading__10659_680043226"></a>老方法</h6>
<ul>
	<li><p align="left">安装源码包：</p>
</ul>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>sudo
apt-get install linux-source</i></span></font></blockquote>
<ul>
	<li><p align="left">解压缩源码：</p>
</ul>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>sudo
mkdir -p /build/buildd/</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>sudo
tar vxjf /usr/src/linux-source-$(uname -r | sed 's/-.*//').tar.bz2 -C
/build/buildd/</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>sudo
rm -rf /build/buildd/linux-$(uname -r | sed 's/-.*//')</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>sudo
mv /build/buildd/linux-source-$(uname -r | sed 's/-.*//')
/build/buildd/linux-$(uname -r | sed 's/-.*//')</i></span></font></blockquote>
<p align="left">请 <b>注意</b> 当内核更新的时候这一步
<b>安装内核源码 </b>需要再做一次。</p>
<p align="left"><br><br>
</p>
<h4 class="cjk" style="page-break-before: always"><a name="__RefHeading__10142_71337508"></a>
<font face="DejaVu Sans, sans-serif"><span lang="en-US">Fedora</span></font></h4>
<h5 class="cjk"><a name="__RefHeading__10144_71337508"></a>安装<font face="DejaVu Sans, sans-serif"><span lang="en-US">Linux</span></font>内核调试镜像</h5>
<p align="left">使用下面的命令：</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>sudo
debuginfo-install kernel</i></span></font></blockquote>
<p align="left"><br><br>
</p>
<p align="left">或者：</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>sudo
yum --enablerepo=fedora-debuginfo install kernel-debuginfo</i></span></font></blockquote>
<blockquote class="cjk" style="margin-left: 0cm"><br>
</blockquote>
<p align="left">于是你可以在<font face="DejaVu Serif, serif"><span lang="en-US">&quot;/usr/lib/debug/lib/modules/$(uname
-r)/vmlinux&quot;</span></font>找到内核调试镜像。</p>
<h5 class="cjk"><a name="__RefHeading__10146_71337508"></a>安装<font face="DejaVu Sans, sans-serif"><span lang="en-US">Linux</span></font>内核开发包</h5>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>sudo
yum install kernel-devel-$(uname -r)</i></span></font></blockquote>
<p align="left">请 注意 在升级过内核包之后，你可能需要重新调用这个命令。</p>
<p align="left"><br><br>
</p>
<h4 class="cjk" style="page-break-before: always"><a name="__RefHeading__10148_71337508"></a>
其他系统</h4>
<p align="left">需要安装<font face="DejaVu Serif, serif"><span lang="en-US">Linux</span></font>内核调试镜像和<font face="DejaVu Serif, serif"><span lang="en-US">Linux</span></font>内核源码包。</p>
<p align="left"><br><br>
</p>
<h3 class="cjk" style="page-break-before: always"><a name="__RefHeading__10150_71337508"></a><a name="确定Linux内核调试镜像是正确的|outline"></a><a name="确定Linux内核调试镜像是正确的|outline"></a>
确定<font face="DejaVu Serif, serif"><span lang="en-US">Linux</span></font>内核调试镜像是正确的</h3>
<p align="left">因为<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>从<font face="DejaVu Serif, serif"><span lang="en-US">Linux</span></font>内核调试镜像里取得地址信息和调试信息，所以使用正确的<font face="DejaVu Serif, serif"><span lang="en-US">Linux</span></font>内核调试镜像是非常重要的。所以在使用<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>前，请先做检查。</p>
<p align="left">有<font face="DejaVu Serif, serif"><span lang="en-US">2</span></font>个方法进行检查，我建议<font face="DejaVu Serif, serif"><span lang="en-US">2</span></font>个方法都做一次来确保<font face="DejaVu Serif, serif"><span lang="en-US">Linux</span></font>内核调试镜像是正确的。
</p>
<p align="left"><br><br>
</p>
<p align="left">请 <b>注意</b>
如果你确定使用了正确的<font face="DejaVu Serif, serif"><span lang="en-US">Linux</span></font>内核调试镜像但是不能通过这个两个方法。请看
<a href="#处理Linux内核调试镜像地址信息和Linux内核执行时不同的问题|outline">处理<font face="DejaVu Serif, serif"><span lang="en-US">Linux</a></span></font><a href="#处理Linux内核调试镜像地址信息和Linux内核执行时不同的问题|outline">内核调试镜像地址信息和<font face="DejaVu Serif, serif"><span lang="en-US">Linux</a></span></font><a href="#处理Linux内核调试镜像地址信息和Linux内核执行时不同的问题|outline">内核执行时不同的问题</a>
。</p>
<p align="left"><br><br>
</p>
<h4 class="cjk" style="page-break-before: always"><a name="__RefHeading__10152_71337508"></a><a name="5.0.0.4.当前Linux内核调试镜像在哪|outline"></a>
当前<font face="DejaVu Sans, sans-serif"><span lang="en-US">Linux</span></font>内核调试镜像在哪</h4>
<p align="left">在<font face="DejaVu Serif, serif"><span lang="en-US">UBUNTU</span></font>中，你可以在<font face="DejaVu Serif, serif"><span lang="en-US">&quot;/usr/lib/debug/boot/vmlinux-$(uname
-r)&quot;</span></font>找到它。</p>
<p align="left">在<font face="DejaVu Serif, serif"><span lang="en-US">Fedora</span></font>中，你可以在<font face="DejaVu Serif, serif"><span lang="en-US">&quot;/usr/lib/debug/lib/modules/$(uname
-r)/vmlinux&quot;</span></font>找到它。</p>
<p align="left">如果你自己编译的内核，内核编译目录中的文件“<font face="DejaVu Serif, serif"><span lang="en-US">vmlinux”</span></font>是调试镜像。</p>
<p align="left"><br><br>
</p>
<h4 class="cjk" style="page-break-before: always"><a name="__RefHeading__10154_71337508"></a>
使用<font face="DejaVu Sans, sans-serif"><span lang="en-US">/proc/kallsyms</span></font></h4>
<p align="left">在运行着要<font face="DejaVu Serif, serif"><span lang="en-US">trace</span></font>的内核的系统上，用下面的命令取得<font face="DejaVu Serif, serif"><span lang="en-US">sys_read</span></font>和<font face="DejaVu Serif, serif"><span lang="en-US">sys_write</span></font>的地址：</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>sudo
cat /proc/kallsyms | grep sys_read</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>ffffffff8117a520
T sys_read</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>sudo
cat /proc/kallsyms | grep sys_write</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>ffffffff8117a5b0
T sys_write</i></span></font></blockquote>
<p align="left">于是我们就可以得到<font face="DejaVu Serif, serif"><span lang="en-US">sys_read</span></font>的地址是<font face="DejaVu Serif, serif"><span lang="en-US">0xffffffff8117a520</span></font>，<font face="DejaVu Serif, serif"><span lang="en-US">sys_write</span></font>的地址是<font face="DejaVu Serif, serif"><span lang="en-US">0xffffffff8117a5b0</span></font>。</p>
<p align="left"><br><br>
</p>
<p align="left">之后我们用<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>从<font face="DejaVu Serif, serif"><span lang="en-US">Linux</span></font>内核调试镜像中取得<font face="DejaVu Serif, serif"><span lang="en-US">sys_read</span></font>和<font face="DejaVu Serif, serif"><span lang="en-US">sys_write</span></font>的地址：</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>gdb
./vmlinux</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
p sys_read</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>$1
= {long int (unsigned int, char *, size_t)} 0xffffffff8117a520
&lt;sys_read&gt;</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
p sys_write</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>$2
= {long int (unsigned int, const char *, size_t)} 0xffffffff8117a5b0
&lt;sys_write&gt;</i></span></font></blockquote>
<p align="left"><font face="DejaVu Serif, serif"><span lang="en-US">sys_read</span></font>和<font face="DejaVu Serif, serif"><span lang="en-US">sys_write</span></font>的地址一样，所以<font face="DejaVu Serif, serif"><span lang="en-US">Linux</span></font>内核调试镜像是正确的。</p>
<p align="left"><br><br>
</p>
<h4 class="cjk" style="page-break-before: always"><a name="__RefHeading__10156_71337508"></a>
使用<font face="DejaVu Sans, sans-serif"><span lang="en-US">linux_banner</span></font></h4>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>sudo
gdb ./vmlinux</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
p linux_banner</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>$1
= &quot;Linux version 3.4.0-rc4+ (teawater@teawater-Precision-M4600)
(gcc version 4.6.3 (GCC) ) #3 SMP Tue Apr 24 13:29:05 CST 2012\n&quot;</i></span></font></blockquote>
<p align="left"><font face="DejaVu Serif, serif"><span lang="en-US">linux_banner</span></font>是<font face="DejaVu Serif, serif"><span lang="en-US">Linux</span></font>内核调试镜像里的内核信息。</p>
<p align="left"><br><br>
</p>
<p align="left">之后，根据 <a href="#让GDB连接到KGTP|outline">让<font face="DejaVu Serif, serif"><span lang="en-US">GDB</a></span></font><a href="#让GDB连接到KGTP|outline">连接到<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</a>
</span></font>里的方法连接到<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>上并再次打印<font face="DejaVu Serif, serif"><span lang="en-US">linux_banner</span></font>。</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
target remote /sys/kernel/debug/gtp</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Remote
debugging using /sys/kernel/debug/gtp</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>0x0000000000000000
in irq_stack_union ()</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
p linux_banner</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>$2
= &quot;Linux version 3.4.0-rc4+ (teawater@teawater-Precision-M4600)
(gcc version 4.6.3 (GCC) ) #3 SMP Tue Apr 24 13:29:05 CST 2012\n&quot;</i></span></font></blockquote>
<p align="left">这个<font face="DejaVu Serif, serif"><span lang="en-US">linux_banner</span></font>是<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>正在<font face="DejaVu Serif, serif"><span lang="en-US">trace</span></font>的内核的内核信息，如果相同，则<font face="DejaVu Serif, serif"><span lang="en-US">Linux</span></font>内核调试镜像是正确的。</p>
<p align="left"><br><br>
</p>
<h3 class="cjk" style="page-break-before: always"><a name="__RefHeading__10754_71337508"></a><a name="处理Linux内核调试镜像地址信息和Linux内核执行时不同的问题|outline"></a>
处理<font face="DejaVu Serif, serif"><span lang="en-US">Linux</span></font>内核调试镜像地址信息和<font face="DejaVu Serif, serif"><span lang="en-US">Linux</span></font>内核执行时不同的问题</h3>
<p align="left">在<font face="DejaVu Serif, serif"><span lang="en-US">X86_32</span></font>上，用
<a href="#确定Linux内核调试镜像是正确的|outline">确定<font face="DejaVu Serif, serif"><span lang="en-US">Linux</a></span></font><a href="#确定Linux内核调试镜像是正确的|outline">内核调试镜像是正确的</a>
介绍的方法发现<font face="DejaVu Serif, serif"><span lang="en-US">Linux</span></font>内核调试镜像地址信息和<font face="DejaVu Serif, serif"><span lang="en-US">Linux</span></font>内核执行时不同，而且确定使用的<font face="DejaVu Serif, serif"><span lang="en-US">Linux</span></font>内核调试镜像是正确的。</p>
<p align="left">这个问题是因为：</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Processor
type and features  ---&gt;</i></span></font></blockquote>
<blockquote class="cjk">        <font face="DejaVu Serif, serif"><span lang="en-US"><i>(0x1000000)
Physical address where the kernel is loaded</i></span></font></blockquote>
<blockquote class="cjk">        <font face="DejaVu Serif, serif"><span lang="en-US"><i>(0x100000)
Alignment value to which kernel should be aligned</i></span></font></blockquote>
<blockquote class="cjk" style="margin-left: 0cm"><br>
</blockquote>
<p align="left">这个两个参数的值不同。请 <b>注意</b>
<font face="DejaVu Serif, serif"><span lang="en-US">&quot;Physical
address where the kernel is loaded&quot; </span></font>有时不会在配置的时候显示，你可以通过搜索
<font face="DejaVu Serif, serif"><span lang="en-US">&quot;PHYSICAL_START&quot;
</span></font>取得它的值。</p>
<p align="left"><br><br>
</p>
<p align="left">你可以通过修改 <font face="DejaVu Serif, serif"><span lang="en-US">&quot;Alignment
value to which kernel should be aligned&quot; </span></font>的值和
<font face="DejaVu Serif, serif"><span lang="en-US">&quot;Physical
address where the kernel is loaded&quot; </span></font>来处理这个问题。</p>
<p align="left">这个问题不影响<font face="DejaVu Serif, serif"><span lang="en-US">X86_64</span></font>。</p>
<p align="left"><br><br>
</p>
<h2 class="cjk" style="page-break-before: always"><a name="__RefHeading__10756_71337508"></a>
取得<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font></h2>
<h3 class="cjk"><a name="__RefHeading__10758_71337508"></a>通过<font face="DejaVu Serif, serif"><span lang="en-US">http</span></font>下载<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font></h3>
<p align="left">请到
<font face="DejaVu Serif, serif"><span lang="en-US"><a href="https://github.com/teawater/kgtp/archive/master.zip">https://github.com/teawater/kgtp/archive/master.zip</a>
</span></font>取得<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>的最新版本。</p>
<p align="left">请到
<font face="DejaVu Serif, serif"><span lang="en-US"><a href="https://github.com/teawater/kgtp/archive/release.zip">https://github.com/teawater/kgtp/archive/release.zip</a>
</span></font>取得<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>最新发布版本。</p>
<p align="left"><br><br>
</p>
<h3 class="cjk" style="page-break-before: always"><a name="__RefHeading__10760_71337508"></a>
通过<font face="DejaVu Serif, serif"><span lang="en-US">git</span></font>下载<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font></h3>
<p align="left">下面的命令将让你取得<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>的最新版本：</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>git
clone https://github.com/teawater/kgtp.git</i></span></font></blockquote>
<p align="left"><br><br>
</p>
<p align="left">下面的命令将让你取得<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>最后的发布版本：</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>git
clone https://github.com/teawater/kgtp.git -b release</i></span></font></blockquote>
<blockquote class="cjk" style="margin-left: 0cm"><br>
</blockquote>
<h3 class="cjk" style="page-break-before: always"><a name="__RefHeading__10791_1267614711"></a>
镜像</h3>
<p><font face="DejaVu Serif, serif"><span lang="en-US"><a href="https://code.csdn.net/teawater/kgtp">https://code.csdn.net/teawater/kgtp</a></span></font></p>
<p><font face="DejaVu Serif, serif"><span lang="en-US"><a href="https://www.gitshell.com/teawater/kgtp/">https://www.gitshell.com/teawater/kgtp/</a></span></font></p>
<p><font face="DejaVu Serif, serif"><span lang="en-US"><a href="https://git.oschina.net/teawater/kgtp">https://git.oschina.net/teawater/kgtp</a></span></font></p>
<h2 class="cjk" style="page-break-before: always"><a name="__RefHeading__10762_71337508"></a>
配置<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font></h2>
<p align="left">下面这部分是在<font face="DejaVu Serif, serif"><span lang="en-US">KGTP
Makefile</span></font>里的配置。用这个配置，<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>将自动和当前系统的内核一起编译。</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>KERNELDIR
:= /lib/modules/`uname -r`/build</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>CROSS_COMPILE
:=</i></span></font></blockquote>
<p align="left"><font face="DejaVu Serif, serif"><span lang="en-US">KERELDIR
</span></font>设置了你要一起编译的内核，默认情况下，<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>会和当前的内核一起编译。</p>
<p align="left">请 <b>注意</b>
这个目录应该是内核编译目录或者<font face="DejaVu Serif, serif"><span lang="en-US">linux-headers</span></font>目录，而不是内核源码目录。内核编译目录只有在编译成功后才能使用。</p>
<p align="left"><font face="DejaVu Serif, serif"><span lang="en-US">CROSS_COMPILE
</span></font>设置编译<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>的编译器前缀名。留空则使用默认编译器。</p>
<p align="left"><font face="DejaVu Serif, serif"><span lang="en-US">ARCH
</span></font>是体系结构。</p>
<p align="left"><br><br>
</p>
<p align="left">或者你可以通过修改<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>目录里的<font face="DejaVu Serif, serif"><span lang="en-US">Makefile</span></font>选择你要和哪个内核一起编译以及你用什么编译器编译<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>。</p>
<p align="left">例如：</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>KERNELDIR
:= /home/teawater/kernel/bamd64</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>CROSS_COMPILE
:=x86_64-glibc_std-</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>ARCH
:= x86_64</i></span></font></blockquote>
<p align="left"><font face="DejaVu Serif, serif"><span lang="en-US">KERNELDIR
</span></font>设置为 <font face="DejaVu Serif, serif"><span lang="en-US">/home/teawater/kernel/bamd64</span></font>。
<font face="DejaVu Serif, serif"><span lang="en-US">Compiler </span></font>设置为
<font face="DejaVu Serif, serif"><span lang="en-US">x86_64-glibc_std-gcc</span></font>。</p>
<p align="left"><br><br>
</p>
<h2 class="cjk" style="page-break-before: always"><a name="__RefHeading__10764_71337508"></a>
编译<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font></h2>
<h3 class="cjk"><a name="__RefHeading__10766_71337508"></a>普通编译</h3>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>cd
kgtp/</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>make</i></span></font></blockquote>
<p align="left">在一些编译环境中<font face="DejaVu Serif, serif"><span lang="en-US">(</span></font>例如<font face="DejaVu Serif, serif"><span lang="en-US">Android)</span></font>将出现一些编译应用程序<font face="DejaVu Serif, serif"><span lang="en-US">getmod</span></font>或者<font face="DejaVu Serif, serif"><span lang="en-US">getframe</span></font>的错误。请忽略这些错误并使用目录中的<font face="DejaVu Serif, serif"><span lang="en-US">gtp.ko</span></font>。</p>
<p align="left">如果你在<font face="DejaVu Serif, serif"><span lang="en-US">Fedora</span></font>上得到出错信息<font face="DejaVu Serif, serif"><span lang="en-US">&quot;/usr/bin/ld:
cannot find -lc&quot;</span></font>，请用下面的命令处理其。</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>sudo
yum install glibc-static</i></span></font></blockquote>
<p align="left"><br><br>
</p>
<h3 class="cjk" style="page-break-before: always"><a name="__RefHeading__10768_71337508"></a>
用一些特殊选项编译<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font></h3>
<p align="left">大部分时候，<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>可以自动选择正确的参数和和各种版本的<font face="DejaVu Serif, serif"><span lang="en-US">Linux</span></font>内核一起编译。</p>
<p align="left">但是如果你想配置一些特殊选项，可以按照下面的介绍来做：</p>
<p align="left"><br><br>
</p>
<p align="left">用这个选项，<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>将不自动选择任何编译选项。</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>make
AUTO=0</i></span></font></blockquote>
<blockquote class="cjk"><br>
</blockquote>
<p align="left">用这个选项，<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>将使用简单<font face="DejaVu Serif, serif"><span lang="en-US">frame</span></font>替代<font face="DejaVu Serif, serif"><span lang="en-US">KGTP
ring buffer</span></font>。</p>
<p align="left">简单<font face="DejaVu Serif, serif"><span lang="en-US">frame</span></font>不支持<font face="DejaVu Serif, serif"><span lang="en-US">gtpframe_pipe</span></font>，它现在只用来调试<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>。</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>make
AUTO=0 FRAME_SIMPLE=1</i></span></font></blockquote>
<p align="left"><br><br>
</p>
<p align="left">用这个选项，<font face="DejaVu Serif, serif"><span lang="en-US">$clock</span></font>将返回<font face="DejaVu Serif, serif"><span lang="en-US">rdtsc</span></font>的值而不是<font face="DejaVu Serif, serif"><span lang="en-US">local_clock</span></font>。</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>make
AUTO=0 CLOCK_CYCLE=1</i></span></font></blockquote>
<p align="left"><br><br>
</p>
<p align="left">用这个选项，<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>可以用<font face="DejaVu Serif, serif"><span lang="en-US">procfs</span></font>替代<font face="DejaVu Serif, serif"><span lang="en-US">debugfs</span></font>。</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>make
AUTO=0 USE_PROC=1</i></span></font></blockquote>
<p align="left"><br><br>
</p>
<p align="left">这些选线可以一起使用，例如：</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>make
AUTO=0 FRAME_SIMPLE=1 CLOCK_CYCLE=1</i></span></font></blockquote>
<p align="left"><br><br>
</p>
<h2 class="cjk" style="page-break-before: always"><a name="__RefHeading__10770_71337508"></a>
安装和卸载 <font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font></h2>
<p align="left">因为<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>可以直接在编译目录里<font face="DejaVu Serif, serif"><span lang="en-US">insmod</span></font>，所以不编译后不安装也可以直接使用（见
<a href="#如何让GDB连接KGTP|outline">如何让<font face="DejaVu Serif, serif"><span lang="en-US">GDB</a></span></font><a href="#如何让GDB连接KGTP|outline">连接<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</a></span></font>）。但是如果需要也可以将其安装到系统中。
安装：</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>cd
kgtp/</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>sudo
make install</i></span></font></blockquote>
<p align="left"><br><br>
</p>
<p align="left">卸载：</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>cd
kgtp/</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>sudo
make uninstall</i></span></font></blockquote>
<p align="left"><br><br>
</p>
<h2 class="cjk" style="page-break-before: always"><a name="__RefHeading__10772_71337508"></a>
和<font face="DejaVu Serif, serif"><span lang="en-US">DKMS</span></font>一起使用<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font></h2>
<p align="left">如果你需要的话，你还可以让<font face="DejaVu Serif, serif"><span lang="en-US">DKMS</span></font>来使用<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>。</p>
<p align="left">下面的命令将拷贝<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>的文件到<font face="DejaVu Serif, serif"><span lang="en-US">DKMS</span></font>需要的目录中。</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>cd
kgtp/</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>sudo
make dkms</i></span></font></blockquote>
<p align="left">于是你可以用<font face="DejaVu Serif, serif"><span lang="en-US">DKMS</span></font>命令控制<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>。请到
<font face="DejaVu Serif, serif"><span lang="en-US"><a href="http://linux.dell.com/dkms/manpage.html">http://linux.dell.com/dkms/manpage.html</a>
</span></font>去看如何使用<font face="DejaVu Serif, serif"><span lang="en-US">DKMS</span></font>。</p>
<p align="left"><br><br>
</p>
<h2 class="cjk" style="page-break-before: always"><a name="__RefHeading__10774_71337508"></a>
使用<font face="DejaVu Serif, serif"><span lang="en-US">KGTP
Linux</span></font>内核<font face="DejaVu Serif, serif"><span lang="en-US">patch</span></font></h2>
<p align="left">大多数时候，你不需要<font face="DejaVu Serif, serif"><span lang="en-US">KGTP
patch</span></font>，因为<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>以一个<font face="DejaVu Serif, serif"><span lang="en-US">LKM</span></font>的形式编译安装更为方便。但是为了帮助人们集成<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>到他们自己的内核树，<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>也提供了<font face="DejaVu Serif, serif"><span lang="en-US">patch.
</span></font>在<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>目录中：</p>
<ul>
	<li><p align="left"><font face="DejaVu Serif, serif"><span lang="en-US"><b>gtp_3.7_to_upstream.patch</b>
	</span></font>是给<font face="DejaVu Serif, serif"><span lang="en-US">Linux
	kernel </span></font>从<font face="DejaVu Serif, serif"><span lang="en-US">3.7</span></font>到<font face="DejaVu Serif, serif"><span lang="en-US">upstream</span></font>的<font face="DejaVu Serif, serif"><span lang="en-US">patch</span></font>。</p>
	<li><p align="left"><font face="DejaVu Serif, serif"><span lang="en-US"><b>gtp_3.0_to_3.6.patch</b>
	</span></font>是给<font face="DejaVu Serif, serif"><span lang="en-US">Linux
	kernel </span></font>从<font face="DejaVu Serif, serif"><span lang="en-US">3.0</span></font>到<font face="DejaVu Serif, serif"><span lang="en-US">3.6</span></font>的<font face="DejaVu Serif, serif"><span lang="en-US">patch</span></font>。</p>
	<li><p align="left"><font face="DejaVu Serif, serif"><span lang="en-US"><b>gtp_2.6.39.patch</b>
	</span></font>是给<font face="DejaVu Serif, serif"><span lang="en-US">Linux
	kernel 2.6.39</span></font>的<font face="DejaVu Serif, serif"><span lang="en-US">patch</span></font>。</p>
	<li><p align="left"><font face="DejaVu Serif, serif"><span lang="en-US"><b>gtp_2.6.33_to_2.6.38.patch</b>
	</span></font>是给<font face="DejaVu Serif, serif"><span lang="en-US">Linux
	kernel </span></font>从<font face="DejaVu Serif, serif"><span lang="en-US">2.6.33</span></font>到<font face="DejaVu Serif, serif"><span lang="en-US">2.6.38</span></font>的<font face="DejaVu Serif, serif"><span lang="en-US">patch</span></font>。</p>
	<li><p align="left"><font face="DejaVu Serif, serif"><span lang="en-US"><b>gtp_2.6.20_to_2.6.32.patch</b>
	</span></font>是给<font face="DejaVu Serif, serif"><span lang="en-US">Linux
	kernel </span></font>从<font face="DejaVu Serif, serif"><span lang="en-US">2.6.20</span></font>到<font face="DejaVu Serif, serif"><span lang="en-US">2.6.32</span></font>的<font face="DejaVu Serif, serif"><span lang="en-US">patch</span></font>。</p>
	<li><p align="left"><font face="DejaVu Serif, serif"><span lang="en-US"><b>gtp_older_to_2.6.19.patch</b>
	</span></font>是给<font face="DejaVu Serif, serif"><span lang="en-US">Linux
	kernel 2.6.19</span></font>以及更早版本的<font face="DejaVu Serif, serif"><span lang="en-US">patch</span></font>。</p>
</ul>
<p align="left"><br><br>
</p>
<h2 class="cjk" style="page-break-before: always"><a name="__RefHeading__10776_71337508"></a>
安装可以和<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>一起使用的<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font></h2>
<p align="left">早于<font face="DejaVu Serif, serif"><span lang="en-US">7.6</span></font>版本的<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>的<font face="DejaVu Serif, serif"><span lang="en-US">tracepoint</span></font>功能有一些<font face="DejaVu Serif, serif"><span lang="en-US">bug</span></font>，而且还有一些功能做的不是很好。</p>
<p align="left">所以如果你的<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>小于<font face="DejaVu Serif, serif"><span lang="en-US">7.6</span></font>请到
<font face="DejaVu Serif, serif"><span lang="en-US"><a href="https://code.google.com/p/gdbt/">https://code.google.com/p/gdbt/</a>
</span></font>去安装可以和<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>一起使用的<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>。这里提供<font face="DejaVu Serif, serif"><span lang="en-US">UBUBTU,
CentOS, Fedora, Mandriva, RHEL, SLE, openSUSE</span></font>源。其他系统还可以下载静态编译版本。</p>
<p align="left">如果你有<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>的问题，请根据这里的信息<a href="#需要帮助或者汇报问题|outline">需要帮助或者汇报问题</a>。</p>
<p align="left"><br><br>
</p>
<h1 class="cjk" style="page-break-before: always"><a name="__RefHeading__11575_71337508"></a><a name="8.附录B 如何让GDB连接KGTP|outline"></a>
附录<font face="DejaVu Sans, sans-serif"><span lang="en-US">B
</span></font>如何让<font face="DejaVu Sans, sans-serif"><span lang="en-US">GDB</span></font>连接<font face="DejaVu Sans, sans-serif"><span lang="en-US">KGTP</span></font></h1>
<p align="left">要使用<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>的功能需要先让<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>连接到<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>上。</p>
<h2 class="cjk"><a name="__RefHeading__11577_71337508"></a>普通<font face="DejaVu Serif, serif"><span lang="en-US">Linux</span></font></h2>
<h3 class="cjk"><a name="__RefHeading__11579_71337508"></a>安装<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>模块</h3>
<p align="left">如果你已经安装了<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>在你的系统中，你可以：</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>sudo
modprobe gtp</i></span></font></blockquote>
<p align="left"><br><br>
</p>
<p align="left">或者你可以直接使用<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>目录里的文件：</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>cd
kgtp/</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>sudo
insmod gtp.ko</i></span></font></blockquote>
<p align="left"><br><br>
</p>
<h3 class="cjk" style="page-break-before: always"><a name="__RefHeading__11581_71337508"></a>
处理找不到<font face="DejaVu Serif, serif"><span lang="en-US">&quot;/sys/kernel/debug/gtp&quot;</span></font>的问题</h3>
<p align="left">如果你有这个问题，请先确定你的内核<font face="DejaVu Serif, serif"><span lang="en-US">config</span></font>打开了<font face="DejaVu Serif, serif"><span lang="en-US">&quot;Debug
Filesystem&quot;</span></font>。<a href="#如果你的系统内核是自己编译的|outline">如果你的系统内核是自己编译的</a></p>
<p align="left"><br><br>
</p>
<p align="left">如果它以及被打开了，请用下面命令<font face="DejaVu Serif, serif"><span lang="en-US">mount
sysfs</span></font>。</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>sudo
mount -t sysfs none /sys/</i></span></font></blockquote>
<p align="left">也许你可能会得到一些错误例如<font face="DejaVu Serif, serif"><span lang="en-US">&quot;sysfs
is already mounted on /sys&quot;</span></font>，请忽略他们。</p>
<p align="left"><br><br>
</p>
<p align="left">请用下面命令<font face="DejaVu Serif, serif"><span lang="en-US">mount
debugfs</span></font>。</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>mount
-t debugfs none /sys/kernel/debug/</i></span></font></blockquote>
<p align="left">然后你就找到<font face="DejaVu Serif, serif"><span lang="en-US">&quot;/sys/kernel/debug/gtp&quot;</span></font>。</p>
<p align="left"><br><br>
</p>
<h3 class="cjk" style="page-break-before: always"><a name="__RefHeading__11583_71337508"></a><a name="让GDB连接到KGTP|outline"></a>
让<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>连接到<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font></h3>
<h4 class="cjk"><a name="__RefHeading__10902_1675807557"></a>装载<font face="DejaVu Sans, sans-serif"><span lang="en-US">Linux</span></font>内核调试镜像到<font face="DejaVu Sans, sans-serif"><span lang="en-US">GDB</span></font></h4>
<p>你可以用下面的命令打开<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>来装载镜像：</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>gdb
Linux</i></span></font>内核调试镜像</blockquote>
<p>或者在打开<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>后，用下面的<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>命令来装载镜像：</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>file
Linux</i></span></font>内核调试镜像文件</blockquote>
<p>你可以根据“<a href="#5.0.0.4.当前Linux内核调试镜像在哪|outline">当前<font face="DejaVu Serif, serif"><span lang="en-US">Linux</a></span></font><a href="#5.0.0.4.当前Linux内核调试镜像在哪|outline">内核调试镜像在哪</a>”找到<font face="DejaVu Serif, serif"><span lang="en-US">Linux</span></font>内核调试镜像文件。</p>
<p><br><br>
</p>
<p align="left">请 <b>注意</b> 让<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>打开正确的<font face="DejaVu Serif, serif"><span lang="en-US">vmlinux</span></font>文件非常重要。请到
<a href="#确定Linux内核调试镜像是正确的|outline">确定<font face="DejaVu Serif, serif"><span lang="en-US">Linux</a></span></font><a href="#确定Linux内核调试镜像是正确的|outline">内核调试镜像是正确的</a>
去看下如何做。</p>
<p align="left"><br><br>
</p>
<h4 class="cjk" style="page-break-before: always"><a name="__RefHeading__11585_71337508"></a>
<font face="DejaVu Sans, sans-serif"><span lang="en-US">GDB</span></font>在本地主机上</h4>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>sudo
gdb ./vmlinux</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
target remote /sys/kernel/debug/gtp</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>Remote
debugging using /sys/kernel/debug/gtp</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>0x0000000000000000
in ?? ()</i></span></font></blockquote>
<p align="left">然后你就可以用<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>命令调试和跟踪<font face="DejaVu Serif, serif"><span lang="en-US">Linux</span></font>内核了。</p>
<p align="left"><br><br>
</p>
<h4 class="cjk" style="page-break-before: always"><a name="__RefHeading__11587_71337508"></a><a name="6.0.0.3.如果GDB在远程主机上|outline"></a>
如果<font face="DejaVu Sans, sans-serif"><span lang="en-US">GDB</span></font>在远程主机上</h4>
<p align="left">用<font face="DejaVu Serif, serif"><span lang="en-US">nc</span></font>把<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>接口映射到端口<font face="DejaVu Serif, serif"><span lang="en-US">1024</span></font>上。</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>sudo
su</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>nc
-l 1234 &lt;/sys/kernel/debug/gtp &gt;/sys/kernel/debug/gtp</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#(nc
-l -p 1234 &lt;/sys/kernel/debug/gtp &gt;/sys/kernel/debug/gtp
</i></span></font>给老版本的<font face="DejaVu Serif, serif"><span lang="en-US"><i>nc)</i></span></font></blockquote>
<p align="left">之后，<font face="DejaVu Serif, serif"><span lang="en-US">nc</span></font>会在那里等待连接。</p>
<p align="left"><br><br>
</p>
<p align="left">让<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>连接<font face="DejaVu Serif, serif"><span lang="en-US">1234</span></font>端口。</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>gdb-release
./vmlinux</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
target remote xxx.xxx.xxx.xxx:1234</i></span></font></blockquote>
<blockquote class="cjk" style="margin-left: 0cm"><br>
</blockquote>
<p align="left">然后你就可以用<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>命令调试和跟踪<font face="DejaVu Serif, serif"><span lang="en-US">Linux</span></font>内核了。</p>
<p align="left"><br><br>
</p>
<h2 class="cjk" style="page-break-before: always"><a name="__RefHeading__11589_71337508"></a>
<font face="DejaVu Serif, serif"><span lang="en-US">Android</span></font></h2>
<p align="left">这个视频介绍了使用<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>连接<font face="DejaVu Serif, serif"><span lang="en-US">Android</span></font>上<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>的过程，可访问
<font face="DejaVu Serif, serif"><span lang="en-US"><a href="http://www.tudou.com/programs/view/qCumSPhByFI/">http://www.tudou.com/programs/view/qCumSPhByFI/
</a></span></font>或者 <font face="DejaVu Serif, serif"><span lang="en-US"><a href="http://youtu.be/9YMpAvsl37I">http://youtu.be/9YMpAvsl37I</a>
</span></font>进行观看。</p>
<p align="left"><br><br>
</p>
<h3 class="cjk" style="page-break-before: always"><a name="__RefHeading__11591_71337508"></a>
安装<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>模块</h3>
<p align="left"><b>第一步</b> 确定<font face="DejaVu Serif, serif"><span lang="en-US">ADB</span></font>已经连接到<font face="DejaVu Serif, serif"><span lang="en-US">Android</span></font>上。</p>
<p align="left"><br><br>
</p>
<p align="left"><b>第二步</b> 拷贝<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>模块到<font face="DejaVu Serif, serif"><span lang="en-US">Android</span></font>上。</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>sudo
adb push gtp.ko /</i></span></font></blockquote>
<p align="left">目录 <font face="DejaVu Serif, serif"><span lang="en-US">&quot;/&quot;
</span></font>可能是只读的。你可以选择其他目录或者用命令<font face="DejaVu Serif, serif"><span lang="en-US">&quot;sudo
adb shell mount -o rw,remount /&quot;</span></font>把这个目录<font face="DejaVu Serif, serif"><span lang="en-US">remount</span></font>为可写。</p>
<p align="left"><br><br>
</p>
<p align="left"><b>第三步</b> 安装<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>模块。</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>adb
shell insmod /gtp.ko</i></span></font></blockquote>
<p align="left"><br><br>
</p>
<h3 class="cjk" style="page-break-before: always"><a name="__RefHeading__11593_71337508"></a>
处理找不到<font face="DejaVu Serif, serif"><span lang="en-US">&quot;/sys/kernel/debug/gtp&quot;</span></font>的问题</h3>
<p align="left">如果你有这个问题，请先确定你的内核<font face="DejaVu Serif, serif"><span lang="en-US">config</span></font>打开了<font face="DejaVu Serif, serif"><span lang="en-US">&quot;Debug
Filesystem&quot;</span></font>。<a href="#如果你的系统内核是自己编译的|outline">如果你的系统内核是自己编译的</a></p>
<p align="left">如果它以及被打开了，请用下面命令<font face="DejaVu Serif, serif"><span lang="en-US">mount
sysfs</span></font>。</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>sudo
adb shell mount -t sysfs none /sys/</i></span></font></blockquote>
<p align="left">也许你可能会得到一些错误例如<font face="DejaVu Serif, serif"><span lang="en-US">&quot;Device
or resource busy&quot;</span></font>，请忽略他们。 
</p>
<p align="left"><br><br>
</p>
<p align="left">请用下面命令<font face="DejaVu Serif, serif"><span lang="en-US">mount
debugfs</span></font>。</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>sudo
adb shell mount -t debugfs none /sys/kernel/debug/</i></span></font></blockquote>
<p align="left"><br><br>
</p>
<p align="left">然后你就找到<font face="DejaVu Serif, serif"><span lang="en-US">&quot;/sys/kernel/debug/gtp&quot;</span></font>。</p>
<p align="left"><br><br>
</p>
<h3 class="cjk" style="page-break-before: always"><a name="__RefHeading__11595_71337508"></a>
<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>连接<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font></h3>
<p align="left">用<font face="DejaVu Serif, serif"><span lang="en-US">nc</span></font>将<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>接口映射到<font face="DejaVu Serif, serif"><span lang="en-US">1024</span></font>端口上。</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>adb
forward tcp:1234 tcp:1234</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>adb
shell &quot;nc -l -p 1234 &lt;/sys/kernel/debug/gtp
&gt;/sys/kernel/debug/gtp&quot;</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#(adb
shell &quot;nc -l 1234 &lt;/sys/kernel/debug/gtp
&gt;/sys/kernel/debug/gtp&quot; </i></span></font>给新版本的<font face="DejaVu Serif, serif"><span lang="en-US"><i>nc)</i></span></font></blockquote>
<p align="left">之后，<font face="DejaVu Serif, serif"><span lang="en-US">nc</span></font>会在那里等待连接。</p>
<p align="left"><br><br>
</p>
<p align="left">让<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>连接<font face="DejaVu Serif, serif"><span lang="en-US">1234</span></font>端口。</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>gdb-release
./vmlinux</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
target remote :1234</i></span></font></blockquote>
<p align="left">然后你就可以用<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>命令调试和跟踪<font face="DejaVu Serif, serif"><span lang="en-US">Linux</span></font>内核了。</p>
<p align="left"><br><br>
</p>
<h1 class="cjk" style="page-break-before: always"><a name="__RefHeading__11597_71337508"></a>
附录<font face="DejaVu Sans, sans-serif"><span lang="en-US">C
</span></font>增加模块的符号信息到<font face="DejaVu Sans, sans-serif"><span lang="en-US">GDB</span></font></h1>
<p align="left">有时你需要添加一个<font face="DejaVu Serif, serif"><span lang="en-US">Linux</span></font>内核模块的符号信息到<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>好调试其。</p>
<p align="left">手动增加符号信息不太容易，所以<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>包里包含了<font face="DejaVu Serif, serif"><span lang="en-US">GDB
Python</span></font>脚本<font face="DejaVu Serif, serif"><span lang="en-US">&quot;getmod.py&quot;</span></font>和程序<font face="DejaVu Serif, serif"><span lang="en-US">&quot;getmod&quot;</span></font>可以帮到你。</p>
<p align="left"><br><br>
</p>
<h2 class="cjk" style="page-break-before: always"><a name="__RefHeading__11599_71337508"></a>
如何使用<font face="DejaVu Serif, serif"><span lang="en-US">getmod</span></font></h2>
<p align="left"><font face="DejaVu Serif, serif"><span lang="en-US">&quot;getmod&quot;
</span></font>是用<font face="DejaVu Serif, serif"><span lang="en-US">C</span></font>写的所以你可以把它用在任何地方即使是一个嵌入式环境。</p>
<p align="left">例如：</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#</i></span></font>下面的命令将把<font face="DejaVu Serif, serif"><span lang="en-US"><i>Linux</i></span></font>内核模块信息以<font face="DejaVu Serif, serif"><span lang="en-US"><i>GDB</i></span></font>命令的格式保存到文件<font face="DejaVu Serif, serif"><span lang="en-US"><i>/tmp/mi</i></span></font>。</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>sudo
getmod &gt;/tmp/mi</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#</i></span></font>在<font face="DejaVu Serif, serif"><span lang="en-US"><i>GDB</i></span></font>那边：</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
source /tmp/mi</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>add
symbol table from file
&quot;/lib/modules/2.6.39-rc5+/kernel/fs/nls/nls_iso8859-1.ko&quot;
at</i></span></font></blockquote>
<blockquote class="cjk">        <font face="DejaVu Serif, serif"><span lang="en-US"><i>.text_addr
= 0xf80de000</i></span></font></blockquote>
<blockquote class="cjk">        <font face="DejaVu Serif, serif"><span lang="en-US"><i>.note.gnu.build-id_addr
= 0xf80de088</i></span></font></blockquote>
<blockquote class="cjk">        <font face="DejaVu Serif, serif"><span lang="en-US"><i>.exit.text_addr
= 0xf80de074</i></span></font></blockquote>
<blockquote class="cjk">        <font face="DejaVu Serif, serif"><span lang="en-US"><i>.init.text_addr
= 0xf8118000</i></span></font></blockquote>
<blockquote class="cjk">        <font face="DejaVu Serif, serif"><span lang="en-US"><i>.rodata.str1.1_addr
= 0xf80de0ac</i></span></font></blockquote>
<blockquote class="cjk">        <font face="DejaVu Serif, serif"><span lang="en-US"><i>.rodata_addr
= 0xf80de0c0</i></span></font></blockquote>
<blockquote class="cjk">        <font face="DejaVu Serif, serif"><span lang="en-US"><i>__mcount_loc_addr
= 0xf80de9c0</i></span></font></blockquote>
<blockquote class="cjk">        <font face="DejaVu Serif, serif"><span lang="en-US"><i>.data_addr
= 0xf80de9e0</i></span></font></blockquote>
<blockquote class="cjk">        <font face="DejaVu Serif, serif"><span lang="en-US"><i>.gnu.linkonce.this_module_addr
= 0xf80dea00</i></span></font></blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#</i></span></font>这条<font face="DejaVu Serif, serif"><span lang="en-US"><i>GDB</i></span></font>命令后，所有<font face="DejaVu Serif, serif"><span lang="en-US"><i>Linux</i></span></font>内核模块信息都被装载进<font face="DejaVu Serif, serif"><span lang="en-US"><i>GDB</i></span></font>了。</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#After
this GDB command, all the Linux Kernel module info is loaded into
GDB.</i></span></font></blockquote>
<blockquote class="cjk" style="margin-left: 0cm"><br>
</blockquote>
<p align="left">如果你使用远程调试或者离线调试，你可以需要修改基本目录。下面是一个例子：</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>#/home/teawater/kernel/b26</i></span></font>是<font face="DejaVu Serif, serif"><span lang="en-US"><i>GDB</i></span></font>所在主机上内核模块所在的路径</blockquote>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>sudo
./getmod -r /home/teawater/kernel/b26 &gt;~/tmp/mi</i></span></font></blockquote>
<p align="left"><br><br>
</p>
<h2 class="cjk" style="page-break-before: always"><a name="__RefHeading__11601_71337508"></a>
如何使用<font face="DejaVu Serif, serif"><span lang="en-US">getmod.py</span></font></h2>
<p align="left">请 注意
<font face="DejaVu Serif, serif"><span lang="en-US"><a href="https://code.google.com/p/gdbt/">https://code.google.com/p/gdbt/</a></span></font>下载的静态编译<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>不能使用<font face="DejaVu Serif, serif"><span lang="en-US">getmod.py</span></font>。</p>
<p align="left">在使用<font face="DejaVu Serif, serif"><span lang="en-US">getmod.py</span></font>前连接到<font face="DejaVu Serif, serif"><span lang="en-US">KGTP</span></font>。</p>
<blockquote class="cjk"><font face="DejaVu Serif, serif"><span lang="en-US"><i>(gdb)
source ~/kgtp/getmod.py</i></span></font></blockquote>
<p align="left" style="margin-right: 1cm">于是这个脚本将自动装载<font face="DejaVu Serif, serif"><span lang="en-US">Linux</span></font>内核模块到<font face="DejaVu Serif, serif"><span lang="en-US">GDB</span></font>中。</p>
<div title="footer">
	<p align="center" style="margin-top: 0.5cm; margin-bottom: 0cm"><sdfield type=PAGE subtype=RANDOM format=PAGE><font face="DejaVu Serif, serif"><font size="3" style="font-size: 12pt">1</font></font></sdfield></p>
</div>
</body>
</html>